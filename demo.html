<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8">
    <title>DEMO - Territ√≥rios</title>
    <meta name="description" content="Vers√£o de demonstra√ß√£o do sistema de territ√≥rios">
    <meta name="theme-color" content="#e67e22"> <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        /* --- ESTILOS ID√äNTICOS AO ORIGINAL --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: #fff8e1; /* Fundo levemente amarelado para demo */ margin: 0; padding-top: 70px; padding-bottom: 80px; font-size: 16px; }
        
        .container { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; padding: 0 15px; max-width: 1200px; margin: 0 auto; }
        .tela-central { max-width: 90%; margin: 20px auto; background: white; padding: 25px; border-radius: 15px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .hidden { display: none !important; }
        input, select { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ccc; border-radius: 8px; font-size: 1rem; background: white; }

        /* Header & Footer */
        .app-header { position: fixed; top: 0; left: 0; right: 0; height: 60px; background: white; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); z-index: 1000; border-bottom: 3px solid #e67e22; }
        .app-title { font-size: 1.2rem; font-weight: 700; color: #333; display: flex; align-items: center; gap: 8px; }
        .app-footer { position: fixed; bottom: 0; left: 0; right: 0; height: 60px; background: white; display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #eee; z-index: 1000; }
        .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; background: none; border: none; color: #999; font-size: 0.75rem; gap: 2px; padding: 0; margin: 0; width: auto; }
        .nav-item.active { color: #e67e22; } /* Laranja na Demo */
        .nav-item .material-icons { font-size: 24px; }
        .icon-btn { background: none; border: none; cursor: pointer; position: relative; color: #555; padding: 5px; }
        .badge { position: absolute; top: 0; right: 0; background: #e74c3c; color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 0.7rem; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white; }

        /* Cards & Status */
        .card { background: white; border-radius: 12px; padding: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); text-align: left; border-left: 5px solid #ccc; transition: transform 0.2s; }
        .card:hover { transform: translateY(-2px); }
        .card h3 { margin: 0 0 5px 0; color: #333; font-size: 1.1rem; font-weight: 700; }
        .card p { margin: 3px 0; color: #666; font-size: 0.95rem; }
        .status-Livre { border-left-color: #27ae60; }
        .status-Ocupado { border-left-color: #e74c3c; opacity: 0.9; }
        .status-Meu { border-left-color: #3498db; background-color: #f0f8ff; border: 2px solid #3498db; }

        /* Bot√µes */
        button { cursor: pointer; padding: 12px; border: none; border-radius: 8px; font-weight: bold; width: 100%; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 1rem; margin-top: 10px; transition: transform 0.1s; }
        button:active { transform: scale(0.98); }
        .btn-pedir, .btn-verde { background-color: #27ae60; color: white; }
        .btn-designar { background-color: #f39c12; color: white; }
        .btn-desabilitado { background-color: #eee; color: #aaa; }
        .btn-azul { background-color: #3498db; color: white; }
        .btn-vermelho { background-color: #fff0f0; color: #e74c3c; border: 1px solid #ffcccc; }
        .btn-close { background: #eee; border: none; border-radius: 50%; width: 30px; height: 30px; color: #333; padding: 0 !important; margin: 0 !important; }
        
        /* Bot√µes Espec√≠ficos da Demo */
        .btn-demo-admin { background-color: #8e44ad; color: white; margin-bottom: 10px; }
        .btn-demo-editor { background-color: #2980b9; color: white; margin-bottom: 10px; }
        .btn-demo-pub { background-color: #27ae60; color: white; margin-bottom: 10px; }

        /* Modais */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000; display: flex; justify-content: center; align-items: stretch; padding: 10px 0; }
        .modal-content { background: #fff; width: 95%; max-width: 720px; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); display: flex; flex-direction: column; max-height: calc(100vh - 40px); overflow: hidden; padding: 0; }
        .modal-header { flex-shrink: 0; display: flex; align-items: center; justify-content: space-between; padding: 12px 15px; border-bottom: 1px solid #eee; }
        .modal-body { flex: 1; overflow-y: auto; padding: 20px; }
        
        /* Ajustes Z-Index */
        #modal-confirmacao { z-index: 3000; }
        #modal-confirmacao .modal-content { max-height: auto; height: auto; align-self: center; padding: 20px; max-width: 350px; }
        #modal-endereco .modal-content { padding: 20px !important; }
        #modal-users, #modal-designar, #modal-editar-usuario, #modal-gestao-lista, #modal-editar-territorio { z-index: 2100 !important; } 

        /* Toast */
        #toast-container { position: fixed; top: 80px; left: 50%; transform: translateX(-50%); z-index: 5000; display: flex; flex-direction: column; gap: 10px; pointer-events: none; width: 90%; max-width: 400px; }
        .toast { background: #333; color: #fff; padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); opacity: 0; transform: translateY(-20px); transition: all 0.3s ease; font-size: 0.95rem; text-align: center; pointer-events: auto; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .toast.visible { opacity: 1; transform: translateY(0); }
        .toast.sucesso { background-color: #27ae60; }
        .toast.erro { background-color: #e74c3c; }

        /* Mapas */
        #conteudo-mapa { width: 100%; border-radius: 8px; z-index: 1; position: relative; }
        .lista-enderecos-cartao { margin-top: 15px; padding: 0; list-style: none; border-top: 1px solid #eee; padding-top: 10px; }
        .lista-enderecos-cartao li { background: #fff; border: 1px solid #ddd; border-left: 5px solid #3498db; border-radius: 6px; padding: 12px 15px; margin-bottom: 10px; display: flex; align-items: center; gap: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .lista-enderecos-cartao .numero { font-weight: bold; font-size: 1.2rem; color: #3498db; min-width: 30px; text-align: center; }
        .mapa-fullscreen { position: fixed !important; top: 0; left: 0; width: 100vw !important; height: 100vh !important; z-index: 9999 !important; background: white; border-radius: 0 !important; }
        .btn-fullscreen { position: absolute; top: 10px; right: 10px; z-index: 10000; background: white; border: none; width: 40px; height: 40px; border-radius: 50%; box-shadow: 0 2px 6px rgba(0,0,0,0.2); cursor: pointer; display: flex; align-items: center; justify-content: center; color: #333; }

        /* Edi√ß√£o */
        .checkbox-group { display: flex; flex-direction: column; gap: 10px; margin: 15px 0; }
        .checkbox-group label { display: flex; align-items: center; gap: 10px; font-size: 1rem; cursor: pointer; padding: 10px; background: #f9f9f9; border-radius: 6px; }
        .checkbox-group input { width: 20px; height: 20px; margin: 0; }
        .item-selecao { background: white; border: 1px solid #eee; margin-bottom: 8px; padding: 10px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }

        @media (max-width: 480px) { .container { grid-template-columns: 1fr; padding: 0 10px; } }
    </style>
</head>
<body>

    <div id="toast-container"></div>

    <header class="app-header hidden" id="app-header">
      <div class="app-title">
        <span class="material-icons" style="color:#e67e22">science</span>
        <div style="display:flex; flex-direction:column; line-height:1;">
            <span>Territ√≥rios (DEMO)</span>
            <span id="header-nome-usuario" style="font-size:0.7rem; color:#666; font-weight:normal;"></span>
        </div>
      </div>
      <div class="header-actions">
        <button class="icon-btn hidden" id="btn-admin-bell" onclick="toggleModal('modal-admin')">
          <span class="material-icons">notifications</span>
          <span class="badge hidden" id="admin-badge">0</span>
        </button>
      </div>
    </header>

    <div id="tela-login" class="tela-central">
      <h2>üß™ Modo Demonstra√ß√£o</h2>
      <p>Este ambiente √© seguro para testes. Nenhuma altera√ß√£o afeta o banco de dados real.</p>
      <p style="margin-bottom:20px;">Escolha um perfil para testar:</p>
      
      <button class="btn-demo-admin" onclick="loginDemo('admin')">
          <span class="material-icons">admin_panel_settings</span> Testar como Admin/Servo
      </button>
      <button class="btn-demo-editor" onclick="loginDemo('editor')">
          <span class="material-icons">edit_note</span> Testar como Editor
      </button>
      <button class="btn-demo-pub" onclick="loginDemo('publicador')">
          <span class="material-icons">person</span> Testar como Publicador
      </button>
      
      <p style="font-size:0.8rem; color:#999; margin-top:20px;">Dados mockados. As altera√ß√µes s√£o locais.</p>
    </div>

    <div id="tela-sistema" class="hidden">
      <div id="lista-territorios" class="container"></div>
    </div>

    <nav class="app-footer hidden" id="app-footer">
      <button class="nav-item active" onclick="trocarAba(this, 'tela-sistema')"><span class="material-icons">dashboard</span> <span>Cart√µes</span> </button>
      <button class="nav-item hidden" id="nav-gestao" onclick="abrirGestaoTerritorios()"><span class="material-icons">folder_managed</span><span>Gest√£o</span></button>
      <button class="nav-item" onclick="toggleModal('modal-perfil')"><span class="material-icons">person</span><span>Perfil</span></button>
    </nav>

    <div id="modal-admin" class="modal-overlay hidden">
      <div class="modal-content">
        <div class="modal-header"><h3 style="margin:0">üîî Solicita√ß√µes (Demo)</h3><button class="btn-close" onclick="toggleModal('modal-admin')"><span class="material-icons">close</span></button></div>
        <div class="modal-body" id="lista-solicitacoes"><p style="text-align:center;">Carregando...</p></div>
      </div>
    </div>

    <div id="modal-perfil" class="modal-overlay hidden">
      <div class="modal-content">
        <div class="modal-header"><h3 style="margin:0">Perfil Demo</h3><button class="btn-close" onclick="toggleModal('modal-perfil')"><span class="material-icons">close</span></button></div>
        <div class="modal-body" style="text-align:center;">
            <span class="material-icons" style="font-size: 60px; color:#ccc; margin-bottom:10px;">account_circle</span>
            <h2 id="perfil-nome" style="margin:5px 0;">---</h2>
            <p id="perfil-email" style="color:#666; margin-bottom:5px;">---</p>
            <p style="margin:0 0 20px 0; color:#3498db; font-weight:bold;"><span id="perfil-funcao">...</span></p>
            <div id="area-admin-panel" class="hidden" style="margin-bottom: 20px; border-top: 1px solid #eee; padding-top: 15px;">
                <h3 style="margin:0 0 10px 0; font-size: 1rem; color: #e67e22;">Administra√ß√£o</h3>
                <button class="btn-designar" onclick="abrirGestaoUsuarios()" style="background-color: #e67e22; color: white;"><span class="material-icons">group</span> Gerenciar Usu√°rios</button>
            </div>
            <button class="btn-vermelho" onclick="fazerLogout()"><span class="material-icons">logout</span> Resetar Demo</button>
        </div>
      </div>
    </div>

    <div id="modal-users" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header"><h3 style="margin:0">Gerenciar Usu√°rios (Demo)</h3><button class="btn-close" onclick="toggleModal('modal-users')"><span class="material-icons">close</span></button></div>
            <div class="modal-body" id="lista-users-body"><p>Carregando...</p></div>
        </div>
    </div>

    <div id="modal-editar-usuario" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 400px; align-self: center;">
            <div class="modal-header"><h3 style="margin:0">Permiss√µes (Demo)</h3><button class="btn-close" onclick="toggleModal('modal-editar-usuario')"><span class="material-icons">close</span></button></div>
            <div class="modal-body">
                <p id="edit-user-nome" style="font-weight: bold; margin-bottom: 10px;">---</p>
                <div class="checkbox-group">
                    <label><input type="checkbox" id="role-publicador" value="Publicador"> Publicador</label>
                    <label><input type="checkbox" id="role-dirigente" value="Dirigente"> Dirigente</label>
                    <label><input type="checkbox" id="role-admin" value="Admin"> Admin</label>
                    <label><input type="checkbox" id="role-editor" value="Editor"> Editor</label>
                </div>
                <button class="btn-verde" onclick="salvarEdicaoViaModal()">Simular Salvar</button>
            </div>
        </div>
    </div>

    <div id="modal-designar" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 400px; align-self: center;">
            <div class="modal-header"><h3 style="margin:0">Designar (Demo)</h3><button class="btn-close" onclick="toggleModal('modal-designar')"><span class="material-icons">close</span></button></div>
            <div class="modal-body">
                <p id="msg-designar-titulo">Para quem vai este cart√£o?</p>
                <select id="sel-designar-pub"><option value="">Carregando...</option></select>
                <button class="btn-designar" id="btn-confirmar-designacao">Confirmar (Mock)</button>
            </div>
        </div>
    </div>

    <div id="modal-gestao-lista" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header"><h3 style="margin:0">Editar Territ√≥rios (Demo)</h3><button class="btn-close" onclick="toggleModal('modal-gestao-lista')"><span class="material-icons">close</span></button></div>
            <div style="padding:10px; border-bottom:1px solid #eee;">
                <input type="text" placeholder="Filtrar..." onkeyup="filtrarListaEdicao(this.value)" style="width:100%; padding:10px; border:1px solid #ccc;">
            </div>
            <div class="modal-body" id="lista-gestao-body"></div>
        </div>
    </div>

    <div id="modal-mapa" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header"><h3 style="margin:0" id="titulo-mapa">...</h3><button class="btn-close" onclick="toggleModal('modal-mapa')"><span class="material-icons">close</span></button></div>
            <div class="modal-body"><div id="conteudo-mapa"><p style="text-align:center;">Carregando...</p></div></div>
        </div>
    </div>

    <div id="modal-endereco" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header"><h3 style="margin:0" id="detalhes-endereco-titulo">Endere√ßo</h3><button class="btn-close" onclick="toggleModal('modal-endereco')"><span class="material-icons">close</span></button></div>
            <div class="modal-body">
                <div style="text-align:left; margin-bottom: 15px;">
                    <p><strong>Rua:</strong> <span id="detalhes-rua">---</span></p>
                    <p><strong>N√∫mero:</strong> <span id="detalhes-numero">---</span></p>
                    <p><strong>GPS:</strong> <span id="detalhes-gps">---</span></p>
                </div>
                <div id="leaflet-map-unico" style="height:300px; width:100%; border-radius: 8px; position:relative;"></div>
                <button class="btn-azul" style="margin-top:10px;" onclick="toggleModal('modal-endereco')">Fechar</button>
            </div>
        </div>
    </div>

    <div id="modal-confirmacao" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:300px; padding:20px; text-align:center; align-self:center;">
            <h3 id="confirm-titulo">Confirma√ß√£o</h3>
            <p id="confirm-texto">...</p>
            <div style="display:flex; gap:10px; justify-content:center;">
                <button id="confirm-sim" class="btn-azul">Sim</button>
                <button onclick="toggleModal('modal-confirmacao')" class="btn-azul" style="background:#eee; color:#333;">N√£o</button>
            </div>
        </div>
    </div>

<script>
// ============================================
// L√ìGICA DE DEMONSTRA√á√ÉO (MOCK BACKEND)
// ============================================

// 1. DADOS FICT√çCIOS
var mockUsuarios = [
    { email: "admin@demo.com", nome: "Admin Demo", nivel: "Admin, Publicador" },
    { email: "editor@demo.com", nome: "Editor Demo", nivel: "Editor, Publicador" },
    { email: "publicador@demo.com", nome: "Jos√© Publicador", nivel: "Publicador" },
    { email: "maria@demo.com", nome: "Maria Silva", nivel: "Publicador" },
    { email: "joao@demo.com", nome: "Jo√£o Souza", nivel: "Publicador" }
];

var mockTerritorios = [
    { id: "TERR-001", nome: "Centro - Pra√ßa", status: "Livre", responsavel: "", dataSaida: "" },
    { id: "TERR-002", nome: "Centro - Mercado", status: "Ocupado", responsavel: "Maria Silva", dataSaida: "10/12/2025" },
    { id: "TERR-003", nome: "Bairro Alto - Rua A", status: "Ocupado", responsavel: "Jo√£o Souza", dataSaida: "12/12/2025" },
    { id: "TERR-004", nome: "Bairro Novo - Quadra 1", status: "Livre", responsavel: "", dataSaida: "" },
    { id: "TERR-005", nome: "Rural - Estrada Velha", status: "Livre", responsavel: "", dataSaida: "" },
    // O Territ√≥rio 006 ser√° manipulado para ser "Meu" se eu for o Jos√© Publicador
    { id: "TERR-006", nome: "Vila Ol√≠mpica", status: "Ocupado", responsavel: "Jos√© Publicador", dataSaida: "15/12/2025" }
];

var mockSolicitacoes = [
    { data: new Date(), nome: "Jo√£o Souza", email: "joao@demo.com", info: "TERR-004", tipo: "TERRITORIO" },
    { data: new Date(), nome: "Novo Usu√°rio", email: "novo@demo.com", info: "123456789", tipo: "ACESSO" }
];

// Estado Global da Sess√£o Demo
var usuarioAtual = null;

// 2. FUN√á√ÉO QUE SUBSTITUI O FETCH
async function chamarAPI(acao, dados = {}) {
    console.log(`[MOCK API] A√ß√£o: ${acao}`, dados);
    
    // Simula atraso de rede
    await new Promise(r => setTimeout(r, 600));

    // --- ROTEADOR MOCK ---
    if (acao === "verificarLogin") {
        const user = mockUsuarios.find(u => u.email === dados.email);
        if (user) return { status: "APROVADO", nome: user.nome, email: user.email, nivel: user.nivel };
        return { status: "ERRO" };
    }

    if (acao === "buscarTerritorios") {
        // Retorna lista formatada com isMeu calculado
        const listaFormatada = mockTerritorios.map(t => {
            const isMeu = t.responsavel === usuarioAtual.nome; // Simplifica√ß√£o: usa nome aqui no mock
            return {
                id: t.id,
                nome: t.nome,
                status: t.status,
                responsavel: t.responsavel,
                dataSaida: t.dataSaida,
                isMeu: isMeu,
                // Permiss√µes
                podeGerenciar: usuarioAtual.nivel.includes("Admin") || usuarioAtual.nivel.includes("Dirigente"),
                podeAbrir: isMeu || usuarioAtual.nivel.includes("Admin") || usuarioAtual.nivel.includes("Editor"),
                ehEditor: usuarioAtual.nivel.includes("Editor")
            };
        });
        return { 
            mapas: listaFormatada, 
            roles: { 
                admin: usuarioAtual.nivel.includes("Admin"), 
                dirigente: usuarioAtual.nivel.includes("Dirigente"), 
                editor: usuarioAtual.nivel.includes("Editor") 
            } 
        };
    }

    if (acao === "listarTodosTerritoriosAdmin") {
        // Retorna formato simples para lista de gest√£o
        return mockTerritorios.map(t => ({
            id: t.id, nome: t.nome, status: t.status, dono: t.responsavel, data: t.dataSaida
        }));
    }

    if (acao === "processarAcaoTerritorio") {
        const { id, tipoAcao, email } = dados;
        const terr = mockTerritorios.find(t => t.id === id);
        
        if (tipoAcao === "pedir") {
            // Em demo, aprovamos direto para ver o efeito visual ou criamos solicitacao
            // Vamos simular sucesso imediato visual alterando o mock
            if(terr.status === "Livre") {
                terr.status = "Ocupado";
                terr.responsavel = usuarioAtual.nome;
                terr.dataSaida = new Date().toLocaleDateString('pt-BR');
                return { sucesso: "Territ√≥rio designado a voc√™ (Demo)." };
            }
        }
        if (tipoAcao === "designar") {
            const userAlvo = mockUsuarios.find(u => u.email === email);
            terr.status = "Ocupado";
            terr.responsavel = userAlvo ? userAlvo.nome : email;
            terr.dataSaida = new Date().toLocaleDateString('pt-BR');
            return { sucesso: `Designado para ${terr.responsavel} (Demo).` };
        }
        return { erro: "A√ß√£o simulada." };
    }

    if (acao === "buscarEnderecosPorTerritorio") {
        // Retorna coordenadas fict√≠cias pr√≥ximas a uma cidade gen√©rica
        return {
            cidade: "Cidade Demo",
            enderecos: [
                { id: "1", rua: "Rua Exemplo A", numero: "100", referencia: "Casa Azul", lat: -23.55052, lng: -46.63330 },
                { id: "2", rua: "Rua Exemplo A", numero: "120", referencia: "", lat: -23.55152, lng: -46.63430 },
                { id: "3", rua: "Rua Exemplo B", numero: "50", referencia: "Sobrado", lat: -23.55252, lng: -46.63530 }
            ]
        };
    }

    if (acao === "buscarSolicitacoes") {
        return mockSolicitacoes;
    }

    if (acao === "listarTodosUsuarios") {
        return { usuarios: mockUsuarios };
    }

    // Fallback para qualquer outra a√ß√£o de escrita
    return { sucesso: "A√ß√£o realizada com sucesso (Simula√ß√£o)." };
}

// --- L√ìGICA DE UI (Adaptada do index.html original) ---

function mostrarNotificacao(msg, tipo="sucesso") {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast ${tipo}`;
    let icon = tipo === 'sucesso' ? 'check_circle' : 'error';
    toast.innerHTML = `<span class="material-icons">${icon}</span> <span>${msg}</span>`;
    container.appendChild(toast);
    setTimeout(() => toast.classList.add('visible'), 10);
    setTimeout(() => { toast.classList.remove('visible'); setTimeout(() => toast.remove(), 300); }, 3000);
}

// Inicializa√ß√£o: Se n√£o tiver sess√£o, mostra login
window.onload = function() {
    // Na demo, sempre for√ßamos o login manual para escolher o perfil
    document.getElementById('tela-login').classList.remove('hidden');
};

// Login Facilitado para Demo
function loginDemo(perfil) {
    let email = "";
    if (perfil === 'admin') email = "admin@demo.com";
    if (perfil === 'editor') email = "editor@demo.com";
    if (perfil === 'publicador') email = "publicador@demo.com";

    // Simula o processo normal
    mostrarNotificacao("Entrando no modo " + perfil + "...", "sucesso");
    chamarAPI("verificarLogin", { email: email }).then(r => {
        usuarioAtual = mockUsuarios.find(u => u.email === email);
        processarLogin(r);
    });
}

function processarLogin(r) {
    document.getElementById('tela-login').classList.add('hidden');
    
    // Atualiza variaveis globais da demo
    usuarioNome = r.nome;
    usuarioEmail = r.email;

    // Atualiza UI do Perfil
    document.getElementById('perfil-nome').innerText = r.nome;
    document.getElementById('perfil-email').innerText = r.email;
    document.getElementById('perfil-funcao').innerText = r.nivel;
    if(document.getElementById('header-nome-usuario')) document.getElementById('header-nome-usuario').innerText = r.nome.split(' ')[0];

    // L√≥gica RBAC
    const roles = r.nivel.toLowerCase();
    const isAdmin = roles.includes('admin');
    const isEditor = roles.includes('editor');
    
    // Painel Admin
    if (isAdmin) document.getElementById('area-admin-panel').classList.remove('hidden');
    else document.getElementById('area-admin-panel').classList.add('hidden');

    // Bot√£o Gest√£o
    if (isAdmin || isEditor) document.getElementById('nav-gestao').classList.remove('hidden');
    else document.getElementById('nav-gestao').classList.add('hidden');

    // Sino
    if (isAdmin) document.getElementById('btn-admin-bell').classList.remove('hidden');
    else document.getElementById('btn-admin-bell').classList.add('hidden');

    // Libera telas
    document.getElementById('app-header').classList.remove('hidden');
    document.getElementById('app-footer').classList.remove('hidden');
    document.getElementById('tela-sistema').classList.remove('hidden');
    
    carregarSistema();
}

function fazerLogout() {
    location.reload(); // Recarrega a p√°gina resetando a mem√≥ria
}

function carregarSistema() {
    document.getElementById('lista-territorios').innerHTML = '<p style="text-align:center; margin-top:20px;">Carregando...</p>';
    chamarAPI("buscarTerritorios", { email: usuarioEmail }).then(renderizarDados);
    // S√≥ carrega notifica√ß√µes se for admin
    if (usuarioAtual.nivel.toLowerCase().includes('admin')) {
        carregarSolicitacoes();
    }
}

function renderizarDados(resultado) {
    const lista = resultado.mapas;
    const divLista = document.getElementById('lista-territorios');
    divLista.innerHTML = '';

    if (!lista.length) { divLista.innerHTML = 'Nada aqui.'; return; }

    lista.forEach(t => {
        let classeStatus = 'status-' + t.status;
        if (t.isMeu) classeStatus = 'status-Meu';
        
        let btnHtml = '';
        if (t.podeGerenciar) {
            btnHtml = `<button class="btn-designar" onclick="acionar('${t.id}', 'designar')"><span class="material-icons">assignment_ind</span> Designar</button>`;
        } else if (t.status === 'Livre') {
            btnHtml = `<button class="btn-pedir" onclick="acionar('${t.id}', 'pedir')"><span class="material-icons">touch_app</span> Pedir</button>`;
        } else {
            btnHtml = `<button class="btn-desabilitado" disabled><span class="material-icons">lock</span> Ocupado</button>`;
        }

        let mapBtn = t.podeAbrir ? `<button class="btn-mapa" onclick="abrirMapa('${t.id}', '${t.nome}')"><span class="material-icons">map</span> Mapa</button>` : '';

        // Info extra
        let info = '';
        if(t.status === 'Ocupado' && t.responsavel) {
            info = `<div style="margin-top:8px; font-size:0.85rem; color:#555;"><i class="material-icons" style="font-size:14px; vertical-align:middle;">person</i> ${t.responsavel}</div>`;
        }

        const card = document.createElement('div');
        card.className = `card ${classeStatus}`;
        card.innerHTML = `<h3>${t.id}</h3><p><strong>${t.nome}</strong></p><p>${t.status}${t.isMeu ? ' (Voc√™)' : ''}</p>${info}${btnHtml}${mapBtn}`;
        divLista.appendChild(card);
    });
}

function acionar(id, acao) {
    if (acao === 'designar') {
        idTerritorioParaDesignar = id;
        toggleModal('modal-designar');
        carregarListaPublicadoresNoSelect();
        return;
    }
    // Pedir
    toggleModal('modal-confirmacao');
    document.getElementById('confirm-texto').innerText = "Deseja pedir este territ√≥rio (Simula√ß√£o)?";
    
    // Override do bot√£o sim
    const btnSim = document.getElementById('confirm-sim');
    const novoBtn = btnSim.cloneNode(true);
    btnSim.parentNode.replaceChild(novoBtn, btnSim);
    
    novoBtn.onclick = function() {
        toggleModal('modal-confirmacao');
        chamarAPI("processarAcaoTerritorio", { id: id, tipoAcao: acao, email: usuarioEmail }).then(r => {
            mostrarNotificacao(r.sucesso || r.erro, r.erro ? "erro" : "sucesso");
            carregarSistema();
        });
    };
}

// Fun√ß√µes Auxiliares de Mock
function carregarListaPublicadoresNoSelect() {
    const sel = document.getElementById('sel-designar-pub');
    sel.innerHTML = '';
    mockUsuarios.forEach(u => {
        const opt = document.createElement('option');
        opt.value = u.email;
        opt.innerText = u.nome;
        sel.appendChild(opt);
    });
    
    document.getElementById('btn-confirmar-designacao').onclick = function() {
        const alvo = sel.value;
        toggleModal('modal-designar');
        chamarAPI("processarAcaoTerritorio", { id: idTerritorioParaDesignar, tipoAcao: "designar", email: alvo }).then(r => {
            mostrarNotificacao(r.sucesso, "sucesso");
            carregarSistema();
        });
    }
}

function carregarSolicitacoes() {
    const div = document.getElementById('lista-solicitacoes');
    div.innerHTML = '';
    mockSolicitacoes.forEach(s => {
        div.innerHTML += `<div class="card-aprovacao" style="padding:10px; margin-bottom:5px; border-left:4px solid #f39c12;"><b>${s.tipo}</b><br>${s.nome} - ${s.info}</div>`;
    });
}

function abrirGestaoTerritorios() {
    toggleModal('modal-gestao-lista');
    const div = document.getElementById('lista-gestao-body');
    div.innerHTML = '';
    mockTerritorios.forEach(t => {
        div.innerHTML += `<div class="item-selecao"><b>${t.id}</b> - ${t.nome}</div>`;
    });
}

function abrirGestaoUsuarios() {
    toggleModal('modal-users');
    const div = document.getElementById('lista-users-body');
    div.innerHTML = '';
    mockUsuarios.forEach(u => {
        div.innerHTML += `<div class="item-selecao"><b>${u.nome}</b><br><small>${u.nivel}</small></div>`;
    });
}

function abrirMapa(id, nome) {
    toggleModal('modal-mapa');
    document.getElementById('titulo-mapa').innerText = nome;
    chamarAPI("buscarEnderecosPorTerritorio").then(res => {
        document.getElementById('conteudo-mapa').innerHTML = '<div id="leaflet-map-container" style="height:300px; width:100%;"></div>';
        
        setTimeout(() => {
            mapaAtual = L.map('leaflet-map-container').setView([-23.55052, -46.63330], 15);
            L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mapaAtual);
            res.enderecos.forEach(e => {
                L.marker([e.lat, e.lng]).addTo(mapaAtual).bindPopup(e.rua);
            });
        }, 200);
    });
}

// UX: Alternar Abas e Modais
function trocarAba(btn, telaId) {
    document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    // Em demo, como √© SPA simples, nada complexo aqui
}
function toggleModal(id) {
    document.getElementById(id).classList.toggle('hidden');
}
function salvarEdicaoViaModal() {
    toggleModal('modal-editar-usuario');
    mostrarNotificacao("Salvo (Simula√ß√£o)", "sucesso");
}
function filtrarListaEdicao(v) { /* L√≥gica filtro simples */ }

</script>
</body>
</html>
