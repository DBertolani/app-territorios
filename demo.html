<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8">
    <title>DEMO - Territ√≥rios</title>
    <meta name="description" content="VERS√ÉO DE DEMONSTRA√á√ÉO - Sistema de territ√≥rios">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        /* --- TODOS OS ESTILOS ORIGINAIS PRESERVADOS --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: #f4f6f8; margin: 0; padding-top: 70px; padding-bottom: 80px; font-size: 16px; }
        .container { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; padding: 0 15px; max-width: 1200px; margin: 0 auto; }
        @media (min-width: 768px) { .container { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); } }
        .tela-central { max-width: 90%; margin: 20px auto; background: white; padding: 25px; border-radius: 15px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .hidden { display: none !important; }
        input, select { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ccc; border-radius: 8px; font-size: 1rem; background: white; }

        /* MODIFICA√á√ÉO: Marcador Visual de Demo */
        .app-header { position: fixed; top: 0; left: 0; right: 0; height: 60px; background: #2c3e50; color: white; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 1000; border-bottom: 4px solid #e67e22; }
        .app-header .app-title span { color: white !important; }
        .demo-tag { background: #e67e22; color: white; font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-left: 8px; vertical-align: middle; font-weight: bold; }

        .app-title { font-size: 1.2rem; font-weight: 700; color: #333; display: flex; align-items: center; gap: 8px; }
        .app-footer { position: fixed; bottom: 0; left: 0; right: 0; height: 60px; background: white; display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #eee; z-index: 1000; }
        .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; background: none; border: none; color: #999; font-size: 0.75rem; gap: 2px; padding: 0; margin: 0; width: auto; }
        .nav-item.active { color: #3498db; }
        .nav-item .material-icons { font-size: 24px; }
        .icon-btn { background: none; border: none; cursor: pointer; position: relative; color: #fff; padding: 5px; }
        .badge { position: absolute; top: 0; right: 0; background: #e74c3c; color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 0.7rem; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white; }

        .card { background: white; border-radius: 12px; padding: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); text-align: left; border-left: 5px solid #ccc; }
        .card h3 { margin: 0 0 5px 0; color: #333; font-size: 1.1rem; font-weight: 700; }
        .card p { margin: 3px 0; color: #666; font-size: 0.95rem; }
        .status-Livre { border-left-color: #27ae60; }
        .status-Ocupado { border-left-color: #e74c3c; opacity: 0.9; }
        .status-Meu { border-left-color: #3498db; background-color: #f0f8ff; border: 2px solid #3498db; }

        button { cursor: pointer; padding: 12px; border: none; border-radius: 8px; font-weight: bold; width: 100%; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 1rem; margin-top: 10px; transition: transform 0.1s; }
        button:active { transform: scale(0.98); }
        .btn-pedir, .btn-verde { background-color: #27ae60; color: white; }
        .btn-designar { background-color: #f39c12; color: white; }
        .btn-desabilitado { background-color: #eee; color: #aaa; }
        .btn-azul { background-color: #3498db; color: white; }
        .btn-vermelho { background-color: #fff0f0; color: #e74c3c; border: 1px solid #ffcccc; }
        .btn-close { background: #eee; border: none; border-radius: 50%; width: 30px; height: 30px; color: #333; padding: 0 !important; margin: 0 !important; }

        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000; display: flex; justify-content: center; align-items: stretch; padding: 10px 0; }
        .modal-content { background: #fff; width: 95%; max-width: 720px; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); display: flex; flex-direction: column; max-height: calc(100vh - 40px); overflow: hidden; padding: 0; }
        .modal-header { flex-shrink: 0; display: flex; align-items: center; justify-content: space-between; padding: 12px 15px; border-bottom: 1px solid #eee; }
        .modal-body { flex: 1; overflow-y: auto; padding: 20px; }
        #modal-users, #modal-designar, #modal-editar-usuario, #modal-gestao-lista, #modal-editar-territorio { z-index: 2100 !important; } 

        #toast-container { position: fixed; top: 80px; left: 50%; transform: translateX(-50%); z-index: 5000; display: flex; flex-direction: column; gap: 10px; pointer-events: none; width: 90%; max-width: 400px; }
        .toast { background: #333; color: #fff; padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); opacity: 0; transform: translateY(-20px); transition: all 0.3s ease; font-size: 0.95rem; text-align: center; pointer-events: auto; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .toast.visible { opacity: 1; transform: translateY(0); }
        .toast.sucesso { background-color: #27ae60; }
        .toast.erro { background-color: #e74c3c; }

        .item-usuario { background: white; display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #eee; }
        .tags-roles span { background: #eef2f7; color: #3498db; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; margin-right: 4px; }
        
        .mapa-fullscreen { position: fixed !important; top: 0; left: 0; width: 100vw !important; height: 100vh !important; z-index: 9999 !important; background: white; border-radius: 0 !important; }
        .btn-fullscreen { position: absolute; top: 10px; right: 10px; z-index: 10000; background: white; border: none; width: 40px; height: 40px; border-radius: 50%; box-shadow: 0 2px 6px rgba(0,0,0,0.2); cursor: pointer; display: flex; align-items: center; justify-content: center; color: #333; }

        /* Estilo Bot√µes Login Demo */
        .btn-demo-login { margin-bottom: 12px; text-align: left; padding: 15px; border: 1px solid #ddd; display: flex; align-items: center; gap: 15px; background: #fff; }
        .btn-demo-login:hover { background: #f9f9f9; border-color: #3498db; }
        .btn-demo-login b { display: block; font-size: 1.1rem; color: #333; }
        .btn-demo-login span { font-size: 0.8rem; color: #777; }
    </style>
</head>
<body>

    <div id="toast-container"></div>

    <header class="app-header hidden" id="app-header">
      <div class="app-title">
        <span class="material-icons">map</span>
        <div style="display:flex; flex-direction:column; line-height:1;">
            <span>Territ√≥rios <small class="demo-tag">MODO TESTE</small></span>
            <span id="header-nome-usuario" style="font-size:0.7rem; color:#ccc; font-weight:normal;"></span>
        </div>
      </div>
      <div class="header-actions">
        <button class="icon-btn hidden" id="btn-admin-bell" onclick="toggleModal('modal-admin')">
          <span class="material-icons">notifications</span>
          <span class="badge hidden" id="admin-badge">0</span>
        </button>
      </div>
    </header>

    <div id="tela-login" class="tela-central">
      <h2 style="color: #e67e22; margin-top: 0;">üß™ Demonstra√ß√£o Interativa</h2>
      <p>Teste o sistema sem afetar dados reais. Escolha como deseja acessar:</p>
      
      <button class="btn-demo-login" onclick="loginDemo('Admin')">
        <span class="material-icons" style="color:#e74c3c">admin_panel_settings</span>
        <div><b>Acesso Administrador</b><span>Gerencia tudo: usu√°rios, territ√≥rios e notifica√ß√µes.</span></div>
      </button>

      <button class="btn-demo-login" onclick="loginDemo('Editor')">
        <span class="material-icons" style="color:#f39c12">edit</span>
        <div><b>Acesso Editor</b><span>Pode gerenciar nomes de territ√≥rios e bairros.</span></div>
      </button>

      <button class="btn-demo-login" onclick="loginDemo('Publicador')">
        <span class="material-icons" style="color:#27ae60">person</span>
        <div><b>Acesso Publicador</b><span>Visualiza√ß√£o padr√£o: pede e devolve seus cart√µes.</span></div>
      </button>
      
      <p style="font-size: 0.75rem; color: #999; margin-top: 20px;">Nota: Ao atualizar a p√°gina, os dados retornam ao estado inicial.</p>
    </div>

    <div id="tela-sistema" class="hidden">
      <div id="lista-territorios" class="container"></div>
    </div>

    <nav class="app-footer hidden" id="app-footer">
      <button class="nav-item active" onclick="trocarAba(this, 'tela-sistema')"><span class="material-icons">dashboard</span> <span>Cart√µes</span> </button>
      <button class="nav-item hidden" id="nav-gestao" onclick="abrirGestaoTerritorios()"><span class="material-icons">folder_managed</span><span>Gest√£o</span></button>
      <button class="nav-item" onclick="toggleModal('modal-perfil')"><span class="material-icons">person</span><span>Perfil</span></button>
    </nav>

    <div id="modal-admin" class="modal-overlay hidden">
      <div class="modal-content">
        <div class="modal-header"><h3>üîî Solicita√ß√µes</h3><button class="btn-close" onclick="toggleModal('modal-admin')"><span class="material-icons">close</span></button></div>
        <div class="modal-body" id="lista-solicitacoes"></div>
      </div>
    </div>

    <div id="modal-users" class="modal-overlay hidden">
      <div class="modal-content">
        <div class="modal-header"><h3>Gerenciar Usu√°rios</h3><button class="btn-close" onclick="toggleModal('modal-users')"><span class="material-icons">close</span></button></div>
        <div class="modal-body" id="lista-users-body"></div>
      </div>
    </div>

    <div id="modal-editar-usuario" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 400px; align-self: center;">
            <div class="modal-header"><h3>Editar Permiss√µes</h3><button class="btn-close" onclick="toggleModal('modal-editar-usuario')"><span class="material-icons">close</span></button></div>
            <div class="modal-body">
                <p id="edit-user-nome" style="font-weight: bold;">---</p>
                <div class="checkbox-group">
                    <label><input type="checkbox" id="role-publicador" value="Publicador"> Publicador</label>
                    <label><input type="checkbox" id="role-dirigente" value="Dirigente"> Dirigente</label>
                    <label><input type="checkbox" id="role-admin" value="Admin"> Admin</label>
                    <label><input type="checkbox" id="role-editor" value="Editor"> Editor</label>
                </div>
                <button class="btn-verde" onclick="salvarEdicaoViaModal()">Simular Salvar</button>
            </div>
        </div>
    </div>

    <div id="modal-designar" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 400px; align-self: center;">
            <div class="modal-header"><h3>Designar (Simula√ß√£o)</h3><button class="btn-close" onclick="toggleModal('modal-designar')"><span class="material-icons">close</span></button></div>
            <div class="modal-body">
                <p id="msg-designar-titulo">Para quem vai este cart√£o?</p>
                <select id="sel-designar-pub"></select>
                <button class="btn-designar" id="btn-confirmar-designacao">Confirmar Designa√ß√£o</button>
            </div>
        </div>
    </div>

    <div id="modal-gestao-lista" class="modal-overlay hidden">
      <div class="modal-content">
        <div class="modal-header"><h3>Gest√£o de Territ√≥rios</h3><button class="btn-close" onclick="toggleModal('modal-gestao-lista')"><span class="material-icons">close</span></button></div>
        <div class="modal-body" id="lista-gestao-body"></div>
      </div>
    </div>

    <div id="modal-editar-territorio" class="modal-overlay hidden">
      <div class="modal-content" style="max-width:400px; align-self:center;">
        <div class="modal-header"><h3>Editar Territ√≥rio</h3><button class="btn-close" onclick="toggleModal('modal-editar-territorio')"><span class="material-icons">close</span></button></div>
        <div class="modal-body">
            <h4 id="edit-terr-id">---</h4>
            <input type="text" id="edit-terr-nome">
            <button class="btn-verde" onclick="salvarEdicaoTerritorio()">Salvar Localmente</button>
        </div>
      </div>
    </div>

    <div id="modal-perfil" class="modal-overlay hidden">
      <div class="modal-content">
        <div class="modal-header"><h3>Meu Perfil</h3><button class="btn-close" onclick="toggleModal('modal-perfil')"><span class="material-icons">close</span></button></div>
        <div class="modal-body" style="text-align:center;">
            <span class="material-icons" style="font-size: 60px; color:#ccc;">account_circle</span>
            <h2 id="perfil-nome">---</h2>
            <p id="perfil-email">---</p>
            <p id="perfil-funcao" style="font-weight:bold; color:#3498db;"></p>
            <div id="area-admin-panel" class="hidden">
                <button class="btn-designar" onclick="abrirGestaoUsuarios()"><span class="material-icons">group</span> Gerenciar Usu√°rios</button>
            </div>
            <button class="btn-vermelho" onclick="fazerLogout()"><span class="material-icons">logout</span> Encerrar Demo</button>
        </div>
      </div>
    </div>

    <div id="modal-mapa" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header"><h3 id="titulo-mapa">...</h3><button class="btn-close" onclick="toggleModal('modal-mapa')"><span class="material-icons">close</span></button></div>
            <div class="modal-body"><div id="conteudo-mapa"></div></div>
        </div>
    </div>

    <div id="modal-endereco" class="modal-overlay hidden">
      <div class="modal-content">
        <div class="modal-header"><h3>Endere√ßo</h3><button class="btn-close" onclick="toggleModal('modal-endereco')"><span class="material-icons">close</span></button></div>
        <div class="modal-body">
            <div style="text-align:left;">
                <p><strong>Cidade:</strong> Cidade Demo</p>
                <p><strong>Bairro:</strong> Bairro Exemplo</p>
                <p><strong>Rua:</strong> <span id="detalhes-rua">---</span></p>
                <p><strong>N√∫mero:</strong> <span id="detalhes-numero">---</span></p>
                <p><strong>GPS:</strong> <span id="detalhes-gps">---</span></p>
            </div>
            <div id="leaflet-map-unico" style="height:300px; width:100%; border-radius: 8px;"></div>
            <button class="btn-azul" onclick="toggleModal('modal-endereco')">Fechar</button>
        </div>
      </div>
    </div>

<script>
// ============================================
// üß™ ENGINE DE SIMULA√á√ÉO (MOCK DATA)
// ============================================

const mockDados = {
    usuarios: [
        { email: "admin@demo.com", nome: "Carlos Administrador", nivel: "Admin, Publicador" },
        { email: "editor@demo.com", nome: "Ana Editora", nivel: "Editor, Publicador" },
        { email: "pub@demo.com", nome: "Jos√© Publicador", nivel: "Publicador" },
        { email: "maria@demo.com", nome: "Maria Publicadora", nivel: "Publicador" }
    ],
    territorios: [
        { id: "TERR-001", nome: "Centro - Setor Norte", status: "Livre", responsavel: "", dataSaida: "", podeGerenciar: true, podeAbrir: true },
        { id: "TERR-002", nome: "Bairro Horizonte", status: "Ocupado", responsavel: "Maria Publicadora", dataSaida: "10/12/2025", podeGerenciar: true, podeAbrir: true },
        { id: "TERR-003", nome: "Vila Esperan√ßa", status: "Livre", responsavel: "", dataSaida: "", podeGerenciar: true, podeAbrir: true },
        { id: "TERR-004", nome: "Parque Industrial", status: "Ocupado", responsavel: "Jos√© Publicador", dataSaida: "15/12/2025", podeGerenciar: true, podeAbrir: true }
    ],
    solicitacoes: [
        { data: "18/12/2025", nome: "Jos√© Publicador", email: "pub@demo.com", info: "TERR-003", tipo: "TERRITORIO" }
    ]
};

var sessao = null; // Guardar√° o usu√°rio logado na demo

// --- FUN√á√ÉO chameAPI MOCKADA (SUBSTITUI√á√ÉO CIR√öRGICA) ---
async function chamarAPI(acao, dados = {}) {
    console.log("[Demo] API Call:", acao, dados);
    await new Promise(r => setTimeout(r, 600)); // Simula lat√™ncia de rede

    switch(acao) {
        case "verificarLogin":
            const user = mockDados.usuarios.find(u => u.email === dados.email);
            return user ? { status: "APROVADO", ...user } : { status: "ERRO" };
        
        case "buscarTerritorios":
            // Ajusta "isMeu" com base na sess√£o demo
            const mapas = mockDados.territorios.map(t => ({
                ...t,
                isMeu: t.responsavel === sessao.nome
            }));
            return { mapas: mapas, roles: { admin: sessao.nivel.includes("Admin"), editor: sessao.nivel.includes("Editor") } };

        case "listarTodosUsuarios":
            return { usuarios: mockDados.usuarios };

        case "listarTodosTerritoriosAdmin":
            return mockDados.territorios.map(t => ({ ...t, data: t.dataSaida, dono: t.responsavel }));

        case "buscarSolicitacoes":
            return mockDados.solicitacoes;

        case "buscarEnderecosPorTerritorio":
            return { 
                cidade: "Cidade Demo", 
                enderecos: [
                    { rua: "Rua do Teste", numero: "100", lat: -21.216, lng: -41.887 },
                    { rua: "Av. da Simula√ß√£o", numero: "200", lat: -21.218, lng: -41.889 }
                ] 
            };

        case "processarAcaoTerritorio":
            const item = mockDados.territorios.find(t => t.id === dados.id);
            if(dados.tipoAcao === "pedir") {
                item.status = "Ocupado";
                item.responsavel = sessao.nome;
                item.dataSaida = "Hoje";
            }
            if(dados.tipoAcao === "designar") {
                const alvo = mockDados.usuarios.find(u => u.email === dados.email);
                item.status = "Ocupado";
                item.responsavel = alvo ? alvo.nome : dados.email;
                item.dataSaida = "Hoje";
            }
            return { sucesso: "A√ß√£o simulada com sucesso!" };

        default:
            return { sucesso: "OK" };
    }
}

// --- L√ìGICA DE LOGIN DEMO ---
function loginDemo(perfil) {
    let emailFake = perfil === 'Admin' ? "admin@demo.com" : (perfil === 'Editor' ? "editor@demo.com" : "pub@demo.com");
    chamarAPI("verificarLogin", { email: emailFake }).then(r => {
        sessao = r;
        processarLogin(r);
    });
}

// --- FUN√á√ïES DE UI (FIEIS AO ORIGINAL) ---

function mostrarNotificacao(msg, tipo = "sucesso") {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast ${tipo}`;
    toast.innerHTML = `<span class="material-icons">${tipo === 'sucesso' ? 'check_circle' : 'error'}</span> <span>${msg}</span>`;
    container.appendChild(toast);
    requestAnimationFrame(() => toast.classList.add('visible'));
    setTimeout(() => { toast.classList.remove('visible'); setTimeout(() => toast.remove(), 300); }, 3000);
}

function processarLogin(r) {
    document.getElementById('tela-login').classList.add('hidden');
    document.getElementById('perfil-nome').innerText = r.nome;
    document.getElementById('perfil-email').innerText = r.email;
    document.getElementById('perfil-funcao').innerText = r.nivel;
    document.getElementById('header-nome-usuario').innerText = r.nome.split(' ')[0];

    const roles = r.nivel.toLowerCase();
    if (roles.includes('admin')) document.getElementById('area-admin-panel').classList.remove('hidden');
    if (roles.includes('admin') || roles.includes('editor')) document.getElementById('nav-gestao').classList.remove('hidden');
    if (roles.includes('admin')) document.getElementById('btn-admin-bell').classList.remove('hidden');

    document.getElementById('app-header').classList.remove('hidden');
    document.getElementById('app-footer').classList.remove('hidden');
    document.getElementById('tela-sistema').classList.remove('hidden');
    carregarSistema();
}

function carregarSistema() {
    document.getElementById('lista-territorios').innerHTML = '<p style="text-align:center;">Carregando Demo...</p>';
    chamarAPI("buscarTerritorios").then(renderizarDados);
    if(sessao.nivel.includes("Admin")) carregarSolicitacoes();
}

function renderizarDados(resultado) {
    const div = document.getElementById('lista-territorios');
    div.innerHTML = '';
    resultado.mapas.forEach(t => {
        const card = document.createElement('div');
        card.className = `card status-${t.isMeu ? 'Meu' : t.status}`;
        card.innerHTML = `
            <h3>${t.id}</h3>
            <p><strong>${t.nome}</strong></p>
            <p>${t.status} ${t.isMeu ? '(Voc√™)' : ''}</p>
            ${t.status === 'Ocupado' ? `<div style="margin-top:8px; font-size:0.85rem; color:#555; display:flex; gap:10px; align-items:center;">
                <span><i class="material-icons" style="font-size:14px; vertical-align:middle;">person</i> ${t.responsavel}</span>
                <span><i class="material-icons" style="font-size:14px; vertical-align:middle;">event</i> ${t.dataSaida || '---'}</span>
            </div>` : ''}
            <button class="${t.podeGerenciar ? 'btn-designar' : (t.status === 'Livre' ? 'btn-pedir' : 'btn-desabilitado')}" ${!t.podeGerenciar && t.status !== 'Livre' ? 'disabled' : ''} onclick="acionar('${t.id}', '${t.podeGerenciar ? 'designar' : 'pedir'}')">
                <span class="material-icons">${t.podeGerenciar ? 'assignment_ind' : (t.status === 'Livre' ? 'touch_app' : 'lock')}</span> ${t.podeGerenciar ? 'Designar' : (t.status === 'Livre' ? 'Pedir' : 'Ocupado')}
            </button>
            <button class="btn-azul" onclick="abrirMapa('${t.id}', '${t.nome}')"><span class="material-icons">map</span> Ver Mapa</button>
        `;
        div.appendChild(card);
    });
}

function acionar(id, acao) {
    if(acao === 'designar') {
        idTerritorioParaDesignar = id;
        toggleModal('modal-designar');
        carregarListaPublicadoresNoSelect();
        return;
    }
    mostrarNotificacao("Solicitando cart√£o na demo...", "sucesso");
    chamarAPI("processarAcaoTerritorio", { id: id, tipoAcao: acao }).then(r => {
        mostrarNotificacao(r.sucesso);
        carregarSistema();
    });
}

var idTerritorioParaDesignar = null;
function carregarListaPublicadoresNoSelect() {
    const sel = document.getElementById('sel-designar-pub');
    sel.innerHTML = mockDados.usuarios.map(u => `<option value="${u.email}">${u.nome}</option>`).join('');
    document.getElementById('btn-confirmar-designacao').onclick = () => {
        chamarAPI("processarAcaoTerritorio", { id: idTerritorioParaDesignar, tipoAcao: "designar", email: sel.value }).then(r => {
            mostrarNotificacao(r.sucesso);
            toggleModal('modal-designar');
            carregarSistema();
        });
    };
}

var mapaAtual = null;
function abrirMapa(id, nome) {
    toggleModal('modal-mapa');
    document.getElementById('titulo-mapa').innerText = nome;
    chamarAPI("buscarEnderecosPorTerritorio").then(res => {
        document.getElementById('conteudo-mapa').innerHTML = '<div id="leaflet-map-container" style="height:300px; width:100%;"></div>';
        setTimeout(() => {
            if(mapaAtual) mapaAtual.remove();
            mapaAtual = L.map('leaflet-map-container').setView([-21.216, -41.887], 15);
            L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mapaAtual);
            res.enderecos.forEach(e => L.marker([e.lat, e.lng]).addTo(mapaAtual).bindPopup(e.rua));
        }, 200);
    });
}

function toggleModal(id) { 
    const el = document.getElementById(id);
    if(el) el.classList.toggle('hidden'); 
}
function trocarAba(btn, tela) { 
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    btn.classList.add('active');
}
function fazerLogout() { location.reload(); }

function abrirGestaoUsuarios() {
    toggleModal('modal-users');
    chamarAPI("listarTodosUsuarios").then(res => {
        const body = document.getElementById('lista-users-body');
        body.innerHTML = res.usuarios.map(u => `<div class="item-usuario"><div><b>${u.nome}</b><br><small>${u.email}</small></div><span class="tags-roles"><span>${u.nivel}</span></span></div>`).join('');
    });
}

function carregarSolicitacoes() {
    chamarAPI("buscarSolicitacoes").then(res => {
        const div = document.getElementById('lista-solicitacoes');
        div.innerHTML = res.map(s => `<div class="card-aprovacao" style="padding:10px; margin-bottom:10px; border-left:4px solid #f39c12;"><b>${s.nome}</b> pediu o mapa <b>${s.info}</b></div>`).join('');
        const badge = document.getElementById('admin-badge');
        badge.innerText = res.length;
        badge.classList.remove('hidden');
    });
}

function abrirGestaoTerritorios() {
    toggleModal('modal-gestao-lista');
    chamarAPI("listarTodosTerritoriosAdmin").then(res => {
        const body = document.getElementById('lista-gestao-body');
        body.innerHTML = res.map(t => `<div class="item-selecao" onclick="mostrarNotificacao('Edi√ß√£o dispon√≠vel na demo','sucesso')"><b>${t.id}</b> - ${t.nome}</div>`).join('');
    });
}

function salvarEdicaoTerritorio() { mostrarNotificacao("Salvo na Demo"); toggleModal('modal-editar-territorio'); }
function salvarEdicaoViaModal() { mostrarNotificacao("Salvo na Demo"); toggleModal('modal-editar-usuario'); }

</script>
</body>
</html>
