<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8">
    <title>Territ√≥rios</title>
    <meta name="description" content="Aplicativo para gest√£o de territ√≥rios de prega√ß√£o">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#3498db">
    <link rel="apple-touch-icon" href="icon-192.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        /* --- ESTILOS BASE --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: #f4f6f8; margin: 0; padding-top: 70px; padding-bottom: 80px; font-size: 16px; }
        .app-header { position: fixed; top: 0; left: 0; right: 0; height: 60px; background: white; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); z-index: 1000; }
        
        /* T√≠tulo com Nome do Usu√°rio */
        .app-title { font-size: 1.2rem; font-weight: 700; color: #333; display: flex; align-items: center; gap: 8px; }
        
        .icon-btn { background: none; border: none; cursor: pointer; position: relative; color: #555; padding: 5px; }
        .badge { position: absolute; top: 0; right: 0; background: #e74c3c; color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 0.7rem; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white; }
        .container { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; padding: 0 15px; max-width: 1200px; margin: 0 auto; }
        .card { background: white; border-radius: 12px; padding: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); text-align: left; border-left: 5px solid #ccc; }
        .card h3 { margin: 0 0 5px 0; color: #333; font-size: 1.1rem; font-weight: 700; }
        .card p { margin: 3px 0; color: #666; font-size: 0.95rem; }
        .status-Livre { border-left-color: #27ae60; }
        .status-Ocupado { border-left-color: #e74c3c; opacity: 0.9; }
        .status-Meu { border-left-color: #3498db; background-color: #f0f8ff; border: 2px solid #3498db; }
        button { cursor: pointer; padding: 12px; border: none; border-radius: 8px; font-weight: bold; width: 100%; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 1rem; margin-top: 10px; transition: transform 0.1s; }
        button:active { transform: scale(0.98); }
        .btn-pedir { background-color: #27ae60; color: white; }
        .btn-designar { background-color: #f39c12; color: white; }
        .btn-desabilitado { background-color: #eee; color: #aaa; }
        .btn-azul { background-color: #3498db; color: white; }
        .btn-vermelho { background-color: #fff0f0; color: #e74c3c; border: 1px solid #ffcccc; }
        .btn-verde { background-color: #27ae60; color: white; }
        
        /* --- MODAIS CORRIGIDOS --- */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000; display: flex; justify-content: center; align-items: stretch; padding: 10px 0; }
        .modal-content { 
            background: #fff; 
            width: 95%; 
            max-width: 720px; 
            border-radius: 16px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); 
            display: flex; 
            flex-direction: column; 
            max-height: calc(100vh - 40px); /* Margem de seguran√ßa */
            overflow: hidden; 
            padding: 0; /* Padding controlado internamente */
        }
        .modal-header { flex-shrink: 0; display: flex; align-items: center; justify-content: space-between; padding: 12px 15px; border-bottom: 1px solid #eee; }
        .modal-body { 
            flex: 1; 
            overflow-y: auto; 
            padding: 20px; /* Mais espa√ßo interno */
        }
        .btn-close { background: #eee; border: none; border-radius: 50%; width: 30px; height: 30px; color: #333; padding: 0 !important; margin: 0 !important; display: flex; align-items: center; justify-content: center; }
        
        /* Ajustes espec√≠ficos de conte√∫do */
        #modal-mapa .modal-content > div:first-child p { margin: 3px 0 !important; font-size: 1rem !important; }
        #modal-endereco .modal-content div:first-child { margin-top: 5px; }
        .card-solicitacao { background: #f9f9f9; padding: 10px; border-radius: 8px; border: 1px solid #eee; margin-bottom: 10px; text-align: left; }
        select { width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #ccc; margin: 5px 0; background: white;}
        
        /* FOOTER & LOGIN */
        .app-footer { position: fixed; bottom: 0; left: 0; right: 0; height: 60px; background: white; display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #eee; z-index: 1000; }
        .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; background: none; border: none; color: #999; font-size: 0.75rem; gap: 2px; padding: 0; margin: 0; width: auto; }
        .nav-item.active { color: #3498db; }
        .nav-item .material-icons { font-size: 24px; }
        .tela-central { max-width: 90%; margin: 20px auto; background: white; padding: 25px; border-radius: 15px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ccc; border-radius: 8px; font-size: 1rem; }
        .hidden { display: none !important; }
        @media (max-width: 900px) { .container { display: grid !important; grid-template-columns: 1fr 1fr !important; gap: 10px; padding: 0 10px; } .card { padding: 10px; border-left-width: 4px; display: flex; flex-direction: column; justify-content: space-between; } .card h3 { font-size: 0.95rem; } .card p { font-size: 0.8rem; } button { padding: 10px !important; font-size: 0.9rem !important; margin-top: 5px; } }
        
        /* MAPAS */
        #conteudo-mapa { width: 100%; border-radius: 8px; z-index: 1; }
        .leaflet-popup-content { font-family: 'Segoe UI', sans-serif; font-size: 14px; text-align: center;}
        .lista-enderecos-cartao { margin-top: 15px; padding: 0; list-style: none; text-align: left; border-top: 1px solid #eee; padding-top: 10px; }
        .lista-enderecos-cartao li { background: #fff; border: 1px solid #ddd; border-left: 5px solid #3498db; border-radius: 6px; padding: 12px 15px; margin-bottom: 10px; display: flex; align-items: center; gap: 15px; line-height: normal; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .lista-enderecos-cartao .numero { font-weight: bold; font-size: 1.2rem; color: #3498db; min-width: 30px; text-align: center; flex-shrink: 0; }
        .lista-enderecos-cartao li > div { display: flex; flex-direction: column; gap: 1px; flex-grow: 1; }
        .endereco-principal { font-size: 0.95rem; font-weight: bold; line-height: 1.3; margin: 0; }
        .endereco-ref { color: #888; font-size: 0.8rem; line-height: 1.2; margin: 0; margin-top: 2px; }
        .modal-content button { margin-top: 8px !important; margin-bottom: 8px !important; }
        .modal-content button:last-child { margin-bottom: 0px !important; }
        #modal-endereco .modal-content { padding: 20px 20px !important; }
        #modal-endereco .modal-content div { line-height: 1.5; margin-bottom: 5px; font-size: 1rem; }
        #detalhes-endereco-titulo { margin-bottom: 15px; font-size: 1.2rem; color: #333; }
        
        /* FULLSCREEN */
        #btn-entrar-fullscreen { position: absolute; top: 10px; right: 10px; z-index: 1000; background: white; border: none; border-radius: 4px; width: 32px; height: 32px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center; color: #333; cursor: pointer; }
        .mapa-fullscreen { position: fixed !important; top: 0; left: 0; width: 100vw !important; height: 100vh !important; z-index: 9999 !important; background: white; border-radius: 0 !important; }
        #btn-sair-fullscreen { display: none; position: fixed; top: 20px; right: 20px; z-index: 10000; background: white; border: none; border-radius: 50%; width: 45px; height: 45px; box-shadow: 0 2px 10px rgba(0,0,0,0.3); align-items: center; justify-content: center; color: #c00; cursor: pointer; }
        .mapa-fullscreen ~ #btn-sair-fullscreen { display: flex !important; }
        .mapa-fullscreen ~ #btn-entrar-fullscreen { display: none !important; }
        
        /* SELE√á√ÉO */
        .lista-selecao-itens { list-style: none; padding: 0; margin: 0; }
        .item-selecao { background: white; border: 1px solid #eee; margin-bottom: 8px; padding: 10px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: background 0.2s; }
        .item-selecao:hover { background-color: #f9f9f9; border-color: #ccc; }
        .badge-status { color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: bold; }

        /* --- NOVO ESTILO PARA NOTIFICA√á√ïES E GEST√ÉO --- */
        .card-aprovacao {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            border-left: 5px solid #3498db;
            margin-bottom: 10px;
            overflow: hidden; /* Importante para o efeito de abrir/fechar */
        }
        .aprovacao-header { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
        .aprovacao-avatar { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
        
        .aprovacao-resumo { padding: 15px; display: flex; align-items: center; justify-content: space-between; cursor: pointer; background: #fff; transition: background 0.2s; }
        .aprovacao-resumo:active { background-color: #f5f5f5; }
        
        .aprovacao-detalhes { padding: 0 15px 15px 15px; display: none; background: #fff; border-top: 1px solid #f0f0f0; }
        .aprovacao-detalhes.aberto { display: block; animation: slideDown 0.3s ease; }
        
        .aprovacao-info h4 { margin: 0; font-size: 1rem; color: #333; }
        .aprovacao-info p { margin: 2px 0 0 0; font-size: 0.85rem; color: #666; }

        /* Estilo para Lista de Usu√°rios (Gest√£o) */
        .item-usuario { padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .tags-roles span { background: #eef2f7; color: #3498db; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; margin-right: 4px; }

        @keyframes slideDown { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

        /* Checkboxes Personalizados */
        .lista-papeis { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin: 15px 0; background: #f9f9f9; padding: 10px; border-radius: 8px; }
        .papel-item { display: flex; align-items: center; gap: 8px; font-size: 0.9rem; color: #444; cursor: pointer; }
        .papel-item input { width: 18px; height: 18px; margin: 0; cursor: pointer; }
        .acoes-aprovacao { display: flex; gap: 10px; margin-top: 10px; }
    </style>
</head>
<body>

    <header class="app-header hidden" id="app-header">
      <div class="app-title">
        <span class="material-icons" style="color:#3498db">map</span>
        <div style="display:flex; flex-direction:column; line-height:1;">
            <span>Territ√≥rios</span>
            <span id="header-nome-usuario" style="font-size:0.7rem; color:#666; font-weight:normal;"></span>
        </div>
      </div>
      <div class="header-actions">
        <button class="icon-btn hidden" id="btn-admin-bell" onclick="toggleModal('modal-admin')">
          <span class="material-icons">notifications</span>
          <span class="badge hidden" id="admin-badge">0</span>
        </button>
      </div>
    </header>

    <div id="tela-login" class="tela-central hidden">
      <h2>üë§ Entrar</h2>
      <p>Bem-vindo ao sistema.</p>
      <input type="email" id="login-email" placeholder="seuemail@exemplo.com">
      <button class="btn-azul" onclick="fazerLogin()">Acessar</button>
    </div>

    <div id="tela-pendente" class="tela-central hidden">
      <h2>‚è≥ Aguardando</h2>
      <span class="material-icons" style="font-size: 48px; color: #f39c12;">hourglass_top</span>
      <p>Sua solicita√ß√£o est√° em an√°lise.</p>
      <button onclick="fazerLogout()" style="background:#f0f0f0; color:#333;">Voltar</button>
    </div>

    <div id="tela-cadastro" class="tela-central hidden">
      <h2>üîí Acesso Restrito</h2>
      <p>Solicite seu cadastro.</p>
      <input type="text" id="cad-nome" placeholder="Seu Nome">
      <input type="tel" id="cad-tel" placeholder="Telefone">
      <button class="btn-azul" onclick="enviarSolicitacao()">Solicitar</button>
      <button onclick="fazerLogout()" style="background:transparent; color:#666; margin-top:5px;">Cancelar</button>
    </div>

    <div id="tela-sistema" class="hidden">
      <div id="lista-territorios" class="container"></div>
    </div>

    <nav class="app-footer hidden" id="app-footer">
      <button class="nav-item active"><span class="material-icons">dashboard</span> <span>Cart√µes</span> </button>
      <button class="nav-item" onclick="toggleModal('modal-perfil')"><span class="material-icons">person</span><span>Perfil</span></button>
    </nav>

    <div id="modal-admin" class="modal-overlay hidden">
      <div class="modal-content">
        <div class="modal-header">
            <h3 style="margin:0">üîî Solicita√ß√µes</h3>
            <button class="btn-close" onclick="toggleModal('modal-admin')"><span class="material-icons">close</span></button>
        </div>
        <div class="modal-body" id="lista-solicitacoes"><p style="text-align:center; color:#999;">Carregando...</p></div>
      </div>
    </div>

    <div id="modal-users" class="modal-overlay hidden">
      <div class="modal-content">
        <div class="modal-header">
            <h3 style="margin:0">Gerenciar Usu√°rios</h3>
            <button class="btn-close" onclick="toggleModal('modal-users')"><span class="material-icons">close</span></button>
        </div>
        <div class="modal-body" id="lista-users-body">
            <p style="text-align:center;">Carregando...</p>
        </div>
      </div>
    </div>

    <div id="modal-perfil" class="modal-overlay hidden">
      <div class="modal-content">
        <div class="modal-header"><h3 style="margin:0">Meu Perfil</h3><button class="btn-close" onclick="toggleModal('modal-perfil')"><span class="material-icons">close</span></button></div>
        <div class="modal-body" style="text-align:center;">
            <span class="material-icons" style="font-size: 60px; color:#ccc; margin-bottom:10px;">account_circle</span>
            <h2 id="perfil-nome" style="margin:5px 0;">---</h2>
            <p id="perfil-email" style="color:#666; margin-bottom:20px;">---</p>
            <button class="btn-vermelho" onclick="fazerLogout()"><span class="material-icons">logout</span> Sair da Conta</button>
        </div>
      </div>
    </div>

    <div id="modal-mapa" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header"><h3 style="margin:0" id="titulo-mapa">...</h3><button class="btn-close" onclick="toggleModal('modal-mapa')"><span class="material-icons">close</span></button></div>
            <div class="modal-body"><div id="conteudo-mapa" style="text-align:left;"><p style="text-align:center; color:#aaa;">Carregando...</p></div></div>
        </div>
    </div>

    <div id="modal-endereco" class="modal-overlay hidden">
      <div class="modal-content">
        <div class="modal-header"><h3 style="margin:0" id="detalhes-endereco-titulo">Endere√ßo</h3><button class="btn-close" onclick="toggleModal('modal-endereco')"><span class="material-icons">close</span></button></div>
        <div class="modal-body">
            <div style="text-align:left; margin-bottom: 15px;">
                <p style="margin:2px 0;"><strong>Cidade:</strong> <span id="detalhes-cidade">---</span></p>
                <p style="margin:2px 0;"><strong>Bairro/Regi√£o:</strong> <span id="detalhes-bairro">---</span></p>
                <hr style="margin: 10px 0;">
                <p style="margin:2px 0;"><strong>Rua:</strong> <span id="detalhes-rua">---</span></p>
                <p style="margin:2px 0;"><strong>N√∫mero:</strong> <span id="detalhes-numero">---</span></p>
                <p style="margin:2px 0;"><strong>Refer√™ncia:</strong> <span id="detalhes-referencia">---</span></p>
                <p style="margin:2px 0;"><strong>GPS:</strong> <span id="detalhes-gps">---</span></p>
            </div>
            <div id="leaflet-map-unico" style="height:300px; width:100%; border-radius: 8px;"></div>
            <button class="btn-designar" id="btn-tra√ßar-rota" style="margin-top:15px;" target="_blank"><span class="material-icons">directions</span> Tra√ßar Rota no Maps</button>
            <button class="btn-azul" style="margin-top:10px; background-color:#ccc; color:#333;" onclick="toggleModal('modal-endereco')">Fechar</button>
        </div>
      </div>
    </div>

    <div id="modal-selecao" class="modal-overlay hidden">
      <div class="modal-content" style="height: 80vh;">
        <div class="modal-header"><h3 style="margin:0;">Escolher Territ√≥rio</h3><button class="btn-close" onclick="toggleModal('modal-selecao')"><span class="material-icons">close</span></button></div>
        <div style="padding:10px; border-bottom:1px solid #eee;">
            <input type="text" placeholder="Filtrar..." onkeyup="filtrarListaSelecao(this.value)" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:6px;">
        </div>
        <div id="corpo-selecao" class="modal-body" style="background:#f4f6f8;">
          <p style="text-align:center; padding:20px; color:#666;">Carregando...</p>
        </div>
      </div>
    </div>

<script>
// ============================================
// ‚ö†Ô∏è COLOQUE O SEU LINK DE IMPLANTA√á√ÉO AQUI:
const API_URL = "https://script.google.com/macros/s/AKfycbw_B0RlBbzKBft76h-HT1kYjE9fbh2udZfZ-uuMMgmLReBlFiIl2N3Xkv_pE8ndBKn1mA/exec"; 
// ============================================

async function chamarAPI(acao, dados = {}) {
    if (API_URL.includes("SUA_URL")) return alert("Link da API n√£o configurado!");
    dados.acao = acao;
    try {
        const response = await fetch(API_URL, { method: "POST", body: JSON.stringify(dados) });
        return await response.json();
    } catch (e) { return { erro: e.toString() }; }
}

var usuarioEmail = "";
var usuarioNome = "";
var mapaAtual = null; 
var mapaUnico = null; 
var enderecosCache = {};
var territorioInfoCache = {}; 

window.onload = function() {
  var emailSalvo = localStorage.getItem('app_territorios_email');
  if (emailSalvo) {
    document.getElementById('login-email').value = emailSalvo;
    fazerLogin();
  } else {
    document.getElementById('tela-login').classList.remove('hidden');
  }
};

function fazerLogin() {
  var email = document.getElementById('login-email').value.trim();
  if (!email) return alert("Digite seu e-mail.");
  usuarioEmail = email;

  var btn = document.querySelector('#tela-login button');
  var txt = btn.innerHTML;
  btn.innerHTML = "..."; btn.disabled = true;

  chamarAPI("verificarLogin", { email: email }).then(function(r) {
    processarLogin(r);
    btn.innerHTML = txt; btn.disabled = false;
  });
}

function processarLogin(r) {
  document.getElementById('tela-login').classList.add('hidden');
  document.getElementById('tela-pendente').classList.add('hidden');
  document.getElementById('tela-cadastro').classList.add('hidden');

  if (r.status === "APROVADO") {
    usuarioNome = r.nome || "Publicador";
    var usuarioNivel = r.nivel || "Publicador";
    
    localStorage.setItem('app_territorios_email', usuarioEmail);
    localStorage.setItem('app_territorios_nivel', usuarioNivel);

    document.getElementById('perfil-nome').innerText = usuarioNome;
    document.getElementById('perfil-email').innerText = usuarioEmail;
    
    // Nome no cabe√ßalho
    if(document.getElementById('header-nome-usuario')) {
        document.getElementById('header-nome-usuario').innerText = usuarioNome.split(' ')[0];
    }
    
    // Lista os cargos no perfil
    var niveisHTML = usuarioNivel.split(',').map(function(n) {
        return '<span style="background:#eef2f7; color:#3498db; padding:4px 8px; border-radius:15px; font-size:0.8rem; margin:2px;">' + n.trim() + '</span>';
    }).join(' ');
    
    var containerPerfil = document.querySelector('#modal-perfil .modal-body');
    var divExistente = document.getElementById('perfil-cargos-display');
    if(divExistente) divExistente.remove();
    var divCargos = document.createElement('div');
    divCargos.id = 'perfil-cargos-display';
    divCargos.style.marginBottom = "20px";
    divCargos.innerHTML = niveisHTML;
    containerPerfil.insertBefore(divCargos, containerPerfil.lastElementChild);

    document.getElementById('app-header').classList.remove('hidden');
    document.getElementById('app-footer').classList.remove('hidden');
    document.getElementById('tela-sistema').classList.remove('hidden');
    carregarSistema();
  } else if (r.status === "PENDENTE") {
    document.getElementById('tela-pendente').classList.remove('hidden');
  } else {
    document.getElementById('tela-cadastro').classList.remove('hidden');
  }
}

function fazerLogout() { localStorage.clear(); location.reload(); }

function carregarSistema() {
  document.getElementById('lista-territorios').innerHTML = '<p style="text-align:center; margin-top:20px;">Carregando...</p>';
  chamarAPI("buscarTerritorios", { email: usuarioEmail }).then(renderizarDados);
  carregarSolicitacoes();
}

function renderizarDados(resultado) {
  var lista = resultado.mapas || [];
  var roles = resultado.roles || {};
  var isAdmin = roles.admin;

  if (isAdmin) {
    document.getElementById('btn-admin-bell').classList.remove('hidden');
  }

  var divLista = document.getElementById('lista-territorios');
  divLista.innerHTML = '';

  if (!lista.length) {
    divLista.innerHTML = '<p style="text-align:center;">Nenhum territ√≥rio.</p>';
    return;
  }

  lista.forEach(function(t) {
    var classeStatus = 'status-' + t.status;
    if (t.isMeu) classeStatus = 'status-Meu';
    var botaoHtml = '';
    
    if (t.podeGerenciar) {
        botaoHtml = '<button class="btn-designar" onclick="acionar(\'' + t.id + '\', \'designar\')"><span class="material-icons">assignment_ind</span> Designar</button>';
    } else if (t.status === 'Livre') {
        botaoHtml = '<button class="btn-pedir" onclick="acionar(\'' + t.id + '\', \'pedir\')"><span class="material-icons">touch_app</span> Pedir</button>';
    } else {
        botaoHtml = '<button class="btn-desabilitado" disabled><span class="material-icons">lock</span> Ocupado</button>';
    }

    // Bot√£o de Ver Mapa (Condicional)
    var botaoMapa = t.podeAbrir 
        ? '<button class="btn-mapa"><span class="material-icons">map</span> Ver Endere√ßos</button>'
        : '';

    var card = document.createElement('div');
    card.className = 'card ' + classeStatus;
    card.innerHTML = 
      '<h3>' + t.id + '</h3>' +
      '<p><strong>' + t.nome + '</strong></p>' +
      '<p>' + t.status + (t.isMeu ? ' (Voc√™)' : '') + '</p>' +
      botaoHtml + botaoMapa;

    if (t.podeAbrir) {
        card.querySelector('.btn-mapa').addEventListener('click', function() { abrirMapa(t.id, t.nome); });
    }
    divLista.appendChild(card);
  });
}

// --- GEST√ÉO DE NOTIFICA√á√ïES (ACORDE√ÉO) ---
function carregarSolicitacoes() {
  chamarAPI("buscarSolicitacoes", { email: usuarioEmail }).then(function(lista) {
    var divSol = document.getElementById('lista-solicitacoes');
    var badge = document.getElementById('admin-badge');
    var modalHeader = document.querySelector('#modal-admin .modal-header');

    if (!document.getElementById('btn-gerir-users')) {
        var btnGerir = document.createElement('button');
        btnGerir.id = 'btn-gerir-users';
        btnGerir.className = 'icon-btn';
        btnGerir.innerHTML = '<span class="material-icons" style="color:#3498db">group</span>';
        btnGerir.onclick = abrirGestaoUsuarios;
        btnGerir.style.marginRight = "10px";
        modalHeader.insertBefore(btnGerir, modalHeader.lastElementChild);
    }

    if (!lista || !lista.length) {
      divSol.innerHTML = '<div style="padding:30px; text-align:center; color:#aaa;">Nada pendente.</div>';
      badge.classList.add('hidden');
      return;
    }
    badge.innerText = lista.length;
    badge.classList.remove('hidden');
    divSol.innerHTML = '';
    
    lista.forEach(function(p, index) {
      var idUnico = 'sol-' + index;
      var div = document.createElement('div');
      div.className = 'card-aprovacao';
      var icone = p.tipo === 'TERRITORIO' ? 'map' : 'person_add';
      var cor = p.tipo === 'TERRITORIO' ? '#f39c12' : '#3498db';
      var titulo = p.tipo === 'TERRITORIO' ? 'Pedido de Mapa' : 'Novo Cadastro';
      var subtitulo = p.nome;
      
      if (p.tipo === 'TERRITORIO') div.style.borderLeftColor = '#f39c12';

      div.innerHTML = 
        '<div class="aprovacao-resumo" onclick="toggleDetalhes(\''+idUnico+'\')">' +
            '<div style="display:flex; align-items:center; gap:10px;">' +
                '<div class="aprovacao-avatar" style="color:'+cor+'; background:#f9f9f9;"><span class="material-icons">'+icone+'</span></div>' +
                '<div><h4 style="margin:0; font-size:0.95rem;">'+titulo+'</h4><p style="margin:0; font-size:0.85rem; color:#666;">'+subtitulo+'</p></div>' +
            '</div>' +
            '<span class="material-icons" id="icon-'+idUnico+'" style="color:#ccc;">expand_more</span>' +
        '</div>' +
        '<div class="aprovacao-detalhes" id="'+idUnico+'">' +
            (p.tipo === 'TERRITORIO' 
                ? '<p style="margin:10px 0;">Quer o mapa: <strong>'+p.info+'</strong></p>' +
                  '<div class="acoes-aprovacao">' +
                      '<button class="btn-designar" style="flex:2;" onclick="aprovarPedido(\''+p.email+'\', \''+p.info+'\')">Aprovar</button>' +
                      '<button class="btn-azul" style="flex:1; background:#eee; color:#555;" onclick="sugerirOutro(\''+p.email+'\', \''+p.info+'\')"><span class="material-icons">edit</span></button>' +
                      '<button class="btn-vermelho" style="flex:1;" onclick="recusarPedido(\''+p.email+'\', \''+p.info+'\', \'TERRITORIO\')"><span class="material-icons">close</span></button>' +
                  '</div>'
                : '<p style="margin:5px 0;">Email: '+p.email+'</p><p style="margin:0 0 10px 0;">Tel: '+p.info+'</p>' +
                  '<div class="lista-papeis" id="roles-'+index+'">' +
                      '<label class="papel-item"><input type="checkbox" value="Publicador" checked> Pub.</label>' +
                      '<label class="papel-item"><input type="checkbox" value="Dirigente"> Dirigente</label>' +
                      '<label class="papel-item"><input type="checkbox" value="Editor"> Editor</label>' +
                      '<label class="papel-item"><input type="checkbox" value="Admin"> Admin</label>' +
                  '</div>' +
                  '<div class="acoes-aprovacao">' +
                      '<button class="btn-verde" style="flex:1;" onclick="processarAprovacaoCadastro(\''+p.email+'\', \''+p.nome+'\', \'roles-'+index+'\')">Confirmar</button>' +
                      '<button class="btn-vermelho" style="width:50px;" onclick="recusarPedido(\''+p.email+'\', \''+p.info+'\', \'ACESSO\')"><span class="material-icons">block</span></button>' +
                  '</div>'
            ) +
        '</div>';
      divSol.appendChild(div);
    });
  });
}

function toggleDetalhes(id) {
    var el = document.getElementById(id);
    var icon = document.getElementById('icon-' + id);
    if (el.classList.contains('aberto')) {
        el.classList.remove('aberto');
        icon.innerText = 'expand_more';
    } else {
        document.querySelectorAll('.aprovacao-detalhes.aberto').forEach(d => {
            d.classList.remove('aberto');
            if(d.previousElementSibling.lastElementChild) d.previousElementSibling.lastElementChild.innerText = 'expand_more';
        });
        el.classList.add('aberto');
        icon.innerText = 'expand_less';
    }
}

// --- GEST√ÉO DE USU√ÅRIOS ---
function abrirGestaoUsuarios() {
    toggleModal('modal-users');
    var divBody = document.getElementById('lista-users-body');
    divBody.innerHTML = '<p style="text-align:center; margin-top:20px;">Buscando usu√°rios...</p>';
    chamarAPI("listarTodosUsuarios", { email: usuarioEmail }).then(function(lista) {
        if (!lista || lista.erro) { divBody.innerHTML = '<p>Erro ao carregar ou sem permiss√£o.</p>'; return; }
        divBody.innerHTML = '';
        var ul = document.createElement('div');
        lista.forEach(function(u) {
            var item = document.createElement('div');
            item.className = 'item-usuario';
            var tags = u.nivel.split(',').map(n => '<span>'+n.trim()+'</span>').join('');
            item.innerHTML = '<div><div style="font-weight:bold;">' + u.nome + '</div><div style="font-size:0.8rem; color:#666;">' + u.email + '</div><div class="tags-roles" style="margin-top:5px;">' + tags + '</div></div><button class="icon-btn" onclick="editarUsuario(\''+u.email+'\', \''+u.nivel+'\')"><span class="material-icons">edit</span></button>';
            ul.appendChild(item);
        });
        divBody.appendChild(ul);
    });
}

function editarUsuario(emailAlvo, nivelAtual) {
    var novosPapeis = prompt("Edite os pap√©is separados por v√≠rgula:", nivelAtual);
    if (novosPapeis === null || novosPapeis === nivelAtual) return;
    if (novosPapeis.trim() === "") {
        if(confirm("Deseja EXCLUIR o usu√°rio " + emailAlvo + "?")) {
            chamarAPI("excluirUsuario", { adminEmail: usuarioEmail, emailAlvo: emailAlvo }).then(function(r) {
                alert(r.sucesso || r.erro); abrirGestaoUsuarios();
            });
        }
        return;
    }
    chamarAPI("salvarEdicaoUsuario", { adminEmail: usuarioEmail, emailAlvo: emailAlvo, novosPapeis: novosPapeis }).then(function(r) {
        alert(r.sucesso || r.erro); abrirGestaoUsuarios();
    });
}

function processarAprovacaoCadastro(emailAlvo, nomeAlvo, idContainerRoles) {
    var divRoles = document.getElementById(idContainerRoles);
    var checkboxes = divRoles.querySelectorAll('input[type="checkbox"]:checked');
    if (checkboxes.length === 0) return alert("Selecione pelo menos uma fun√ß√£o.");
    var papeisSelecionados = Array.from(checkboxes).map(cb => cb.value).join(', ');
    if(!confirm('Aprovar ' + nomeAlvo + ' como: ' + papeisSelecionados + '?')) return;
    chamarAPI("aprovarCadastro", { adminEmail: usuarioEmail, emailAlvo: emailAlvo, nomeAlvo: nomeAlvo, nivel: papeisSelecionados }).then(function(r) {
       alert(r.sucesso || r.erro); carregarSolicitacoes();
    });
}

// --- OUTRAS FUN√á√ïES ---
function aprovarPedido(email, idTerritorio) {
    if(!confirm('Designar ' + idTerritorio + ' para este publicador?')) return;
    chamarAPI("aprovarPedidoTerritorio", { email: email, idTerritorio: idTerritorio }).then(function(r) {
        alert(r.sucesso || r.erro); carregarSolicitacoes(); carregarSistema(); 
    });
}
function recusarPedido(email, info, tipo) {
    var motivo = prompt("Motivo da recusa:", "Indispon√≠vel");
    if (motivo === null) return; 
    chamarAPI("recusarSolicitacao", { email: email, info: info, tipo: tipo, motivo: motivo }).then(function(r) {
        alert(r.sucesso || r.erro); carregarSolicitacoes();
    });
}
function sugerirOutro(email, idAtual) {
    abrirSeletorTerritorio(function(novoID) {
        if (!novoID) return;
        chamarAPI("sugerirTrocaTerritorio", { email: email, idAtual: idAtual, novoID: novoID }).then(function(r) {
            alert(r.sucesso || r.erro); carregarSolicitacoes();
        });
    });
}
function acionar(id, acao) {
    if(!confirm('Confirma ' + acao + '?')) return;
    chamarAPI("processarAcaoTerritorio", { id: id, tipoAcao: acao, email: usuarioEmail }).then(function(r) {
          if (r.erro) alert(r.erro); else { alert(r.sucesso); carregarSistema(); }
      });
}
function enviarSolicitacao() {
    var nome = document.getElementById('cad-nome').value;
    var tel = document.getElementById('cad-tel').value;
    if (!nome || !tel) return alert("Preencha todos os campos.");
    chamarAPI("solicitarCadastro", { nome: nome, tel: tel, email: usuarioEmail }).then(function(r) {
       if(r.erro) alert(r.erro); else { alert(r.sucesso); location.reload(); }
    });
}
function toggleModal(id) { document.getElementById(id).classList.toggle('hidden'); }

// --- MAPAS LEAFLET ---
function abrirMapa(idTerritorio, nomeTerritorio) {
    toggleModal('modal-mapa');
    document.getElementById('titulo-mapa').innerText = 'Cart√£o N¬∫: ' + idTerritorio; 
    var divConteudo = document.getElementById('conteudo-mapa');
    divConteudo.innerHTML = '<p style="text-align:center;color:#aaa;">Carregando dados...</p>';
    
    chamarAPI("buscarEnderecosPorTerritorio", { id: idTerritorio }).then(function(resultado) { 
         var enderecos = resultado.enderecos;
         var cidade = resultado.cidade;
         enderecosCache[idTerritorio] = enderecos;
         territorioInfoCache[idTerritorio] = { nome: nomeTerritorio, cidade: cidade }; 

         if (!enderecos || enderecos.length === 0) {
             divConteudo.innerHTML = '<p style="margin-top:15px;color:#c00;text-align:center;">Sem dados de GPS.</p>';
             return;
         }
         
         divConteudo.innerHTML = '<div id="leaflet-map-container" style="height:250px;width:100%;border-radius:8px;"></div><ul class="lista-enderecos-cartao"></ul>';
         var ul = divConteudo.querySelector('ul');
         
         if (mapaAtual) { mapaAtual.remove(); mapaAtual = null; }
         var bounds = [];
         
         setTimeout(function() {
            mapaAtual = L.map('leaflet-map-container');
            L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(mapaAtual);

            enderecos.forEach(function(end, index) {
                var numero = index + 1; 
                var latLng = [end.lat, end.lng];
                bounds.push(latLng);
                var li = document.createElement('li');
                li.innerHTML = '<strong>' + numero + '</strong> ' + end.rua + ', ' + end.numero;
                li.style.padding = '10px'; li.style.borderBottom = '1px solid #eee';
                li.onclick = function() { abrirDetalhesEndereco(numero, idTerritorio); };
                ul.appendChild(li);
                L.marker(latLng).addTo(mapaAtual).bindPopup(numero + '. ' + end.rua);
            });
            if (bounds.length > 0) mapaAtual.fitBounds(bounds, { padding: [20, 20] });
            
            // Adiciona bot√µes de compartilhar se existirem endere√ßos
            adicionarBotaoCompartilhar(idTerritorio, nomeTerritorio, enderecos);
            
         }, 150); 
     });
}
// --- MODAL DETALHES ---
function abrirDetalhesEndereco(numero, idTerritorio) {
      var enderecos = enderecosCache[idTerritorio];
      var info = territorioInfoCache[idTerritorio]; 
      if (!enderecos || !info) return alert("Erro de dados. Tente recarregar.");
      var end = enderecos[numero - 1]; 
      if (mapaUnico) { mapaUnico.remove(); mapaUnico = null; }

      document.getElementById('detalhes-endereco-titulo').innerText = 'Endere√ßo N¬∫ ' + numero;
      document.getElementById('detalhes-cidade').innerText = info.cidade;
      document.getElementById('detalhes-bairro').innerText = info.nome;
      document.getElementById('detalhes-rua').innerText = end.rua;
      document.getElementById('detalhes-numero').innerText = end.numero;
      document.getElementById('detalhes-referencia').innerText = end.referencia || 'N/A';
      document.getElementById('detalhes-gps').innerText = end.lat + ', ' + end.lng;
      
      var linkGPS = 'https://www.google.com/maps/search/?api=1&query=' + end.lat + ',' + end.lng;
      var btnRota = document.getElementById('btn-tra√ßar-rota');
      btnRota.onclick = function() { window.open(linkGPS, '_blank'); };

      toggleModal('modal-endereco');
      setTimeout(function() {
          mapaUnico = L.map('leaflet-map-unico').setView([end.lat, end.lng], 18);
          L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '¬© OpenStreetMap' }).addTo(mapaUnico);
          var numberedIcon = L.divIcon({ className: 'custom-numbered-icon', html: '<div style="background:#e74c3c; color:white; border-radius:50%; width:24px; height:24px; text-align:center; line-height:24px; font-weight:bold; border:2px solid white;">' + numero + '</div>', iconSize: [24, 24], iconAnchor: [12, 24] });
          L.marker([end.lat, end.lng], { icon: numberedIcon }).addTo(mapaUnico).bindPopup('Ponto ' + numero).openPopup();
          mapaUnico.invalidateSize();
      }, 50);
}

// COMPARTILHAMENTO
function adicionarBotaoCompartilhar(idTerritorio, nomeTerritorio, listaEnderecos) {
    var divConteudo = document.getElementById('conteudo-mapa');
    var containerAcoes = document.getElementById('container-acoes-mapa-geral');
    if (!containerAcoes) {
        containerAcoes = document.createElement('div');
        containerAcoes.id = 'container-acoes-mapa-geral';
        containerAcoes.style.marginTop = '15px';
        containerAcoes.style.display = 'flex';
        containerAcoes.style.flexDirection = 'column'; 
        containerAcoes.style.gap = '10px';
        divConteudo.appendChild(containerAcoes); 
    }
    containerAcoes.innerHTML = 
        '<button class="btn-designar" id="btn-compartilhar" style="background-color:#25D366; color: white;"><span class="material-icons">share</span> Enviar Lista no WhatsApp</button>' +
        '<button class="btn-designar" id="btn-maps-multiplo" style="background-color:#4285F4; color: white;"><span class="material-icons">map</span> Abrir Todos no Maps</button>' +
        '<button class="btn-azul" style="background-color:#eee; color:#333; border:1px solid #ccc;" onclick="toggleModal(\'modal-mapa\')">Fechar</button>';

    document.getElementById('btn-compartilhar').onclick = function() { compartilharDadosTerritorio(idTerritorio, nomeTerritorio, listaEnderecos); };
    document.getElementById('btn-maps-multiplo').onclick = function() { abrirRotaCompleta(listaEnderecos); };
}

function compartilharDadosTerritorio(id, nome, enderecos) {
    if (!enderecos || enderecos.length === 0) return alert("Sem dados.");
    var linkRota = gerarLinkRota(enderecos);
    var textoLista = enderecos.map(function(end, index) { return 'üìç *' + (index + 1) + '.* ' + end.rua + ', ' + (end.numero || 'S/N') + '\n   _Ref: ' + (end.referencia || '-') + '_'; }).join('\n\n');
    var mensagem = 'üó∫Ô∏è *Territ√≥rio ' + id + '* - ' + nome + '\n\n' + textoLista + '\n\n' + 'üîó *Ver todos no Mapa:*\n' + linkRota;
    var urlZap = 'https://api.whatsapp.com/send?text=' + encodeURIComponent(mensagem.trim());
    window.open(urlZap, '_blank');
}

function abrirRotaCompleta(enderecos) {
    var link = gerarLinkRota(enderecos);
    window.open(link, '_blank');
}

function gerarLinkRota(enderecos) {
    var baseUrl = "https://www.google.com/maps/dir/";
    var coordenadas = enderecos.map(function(e) { return e.lat + ',' + e.lng; }).join('/');
    return baseUrl + coordenadas;
}

function alternarTelaCheia() {
    var mapaDiv = document.getElementById('leaflet-map-container');
    if (mapaDiv.classList.contains('mapa-fullscreen')) { mapaDiv.classList.remove('mapa-fullscreen'); } 
    else { mapaDiv.classList.add('mapa-fullscreen'); }
    setTimeout(function() { if (mapaAtual) { mapaAtual.invalidateSize(); } }, 200);
}

// SELETOR
function abrirSeletorTerritorio(cb) {
    window.callbackSelecao = cb;
    toggleModal('modal-selecao');
    chamarAPI("listarTodosTerritoriosAdmin").then(renderizarListaSelecao);
}
function renderizarListaSelecao(lista) {
    var corpo = document.getElementById('corpo-selecao');
    corpo.innerHTML = '';
    lista.forEach(function(t) {
        var div = document.createElement('div');
        div.className = 'item-selecao';
        div.innerHTML = '<b>' + t.id + '</b> - ' + t.nome + ' (' + t.status + ')';
        div.onclick = function() { toggleModal('modal-selecao'); if(window.callbackSelecao) window.callbackSelecao(t.id); };
        corpo.appendChild(div);
    });
}
function filtrarListaSelecao(texto) {
    var termo = texto.toLowerCase();
    document.querySelectorAll('.item-selecao').forEach(item => {
        item.style.display = item.innerText.toLowerCase().includes(termo) ? 'flex' : 'none';
    });
}
if ('serviceWorker' in navigator) { navigator.serviceWorker.register('./service-worker.js'); }
</script>
</body>
</html>

