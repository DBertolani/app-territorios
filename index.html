<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8">
    <title>Territ√≥rios</title>
    <meta name="description" content="Aplicativo para gest√£o de territ√≥rios de prega√ß√£o">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#3498db">
    <link rel="apple-touch-icon" href="icon-192.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        /* --- 1. BASE & LAYOUT --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: #f4f6f8; margin: 0; padding-top: 70px; padding-bottom: 80px; font-size: 16px; }
        
        .container { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); 
            gap: 15px; 
            padding: 0 15px; 
            max-width: 1200px; 
            margin: 0 auto; 
        }

        @media (min-width: 768px) {
            .container { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }
        }

        .tela-central { max-width: 90%; margin: 20px auto; background: white; padding: 25px; border-radius: 15px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .hidden { display: none !important; }
        input, select { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ccc; border-radius: 8px; font-size: 1rem; background: white; }

        /* --- 2. HEADER & FOOTER --- */
        .app-header { position: fixed; top: 0; left: 0; right: 0; height: 60px; background: white; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); z-index: 1000; }
        .app-title { font-size: 1.2rem; font-weight: 700; color: #333; display: flex; align-items: center; gap: 8px; }
        .app-footer { position: fixed; bottom: 0; left: 0; right: 0; height: 60px; background: white; display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #eee; z-index: 1000; }
        
        /* CORRE√á√ÉO DE ALINHAMENTO DO √çCONE GEST√ÉO */
        .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; background: none; border: none; color: #999; font-size: 0.75rem; gap: 2px; padding: 0; margin: 0; width: auto; cursor: pointer; }
        .nav-item.active { color: #3498db; }
        .nav-item .material-icons { font-size: 24px; }

        .icon-btn { background: none; border: none; cursor: pointer; position: relative; color: #555; padding: 5px; }
        .badge { position: absolute; top: 0; right: 0; background: #e74c3c; color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 0.7rem; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white; }

        /* --- 3. CART√ïES & STATUS --- */
        .card { background: white; border-radius: 12px; padding: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); text-align: left; border-left: 5px solid #ccc; }
        .card h3 { margin: 0 0 5px 0; color: #333; font-size: 1.1rem; font-weight: 700; }
        .card p { margin: 3px 0; color: #666; font-size: 0.95rem; }
        .status-Livre { border-left-color: #27ae60; }
        .status-Ocupado { border-left-color: #e74c3c; opacity: 0.9; }
        .status-Meu { border-left-color: #3498db; background-color: #f0f8ff; border: 2px solid #3498db; }

        /* --- 4. BOT√ïES --- */
        button { cursor: pointer; padding: 12px; border: none; border-radius: 8px; font-weight: bold; width: 100%; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 1rem; margin-top: 10px; transition: transform 0.1s; }
        button:active { transform: scale(0.98); }
        .btn-pedir, .btn-verde { background-color: #27ae60; color: white; }
        .btn-designar { background-color: #f39c12; color: white; }
        .btn-desabilitado { background-color: #eee; color: #aaa; }
        .btn-azul { background-color: #3498db; color: white; }
        .btn-vermelho { background-color: #fff0f0; color: #e74c3c; border: 1px solid #ffcccc; }
        .btn-close { background: #eee; border: none; border-radius: 50%; width: 30px; height: 30px; color: #333; padding: 0 !important; margin: 0 !important; }

        /* --- 5. MODAIS & TOAST --- */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000; display: flex; justify-content: center; align-items: stretch; padding: 10px 0; }
        .modal-content { background: #fff; width: 95%; max-width: 720px; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); display: flex; flex-direction: column; max-height: calc(100vh - 40px); overflow: hidden; padding: 0; }
        .modal-header { flex-shrink: 0; display: flex; align-items: center; justify-content: space-between; padding: 12px 15px; border-bottom: 1px solid #eee; }
        .modal-body { flex: 1; overflow-y: auto; padding: 20px; }
        
        #modal-confirmacao { z-index: 3000; }
        #modal-confirmacao .modal-content { max-height: auto; height: auto; align-self: center; padding: 20px; max-width: 350px; }
        #toast-container { position: fixed; top: 80px; left: 50%; transform: translateX(-50%); z-index: 5000; display: flex; flex-direction: column; gap: 10px; pointer-events: none; width: 90%; max-width: 400px; }
        .toast { background: #333; color: #fff; padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); opacity: 0; transform: translateY(-20px); transition: all 0.3s ease; font-size: 0.95rem; text-align: center; pointer-events: auto; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .toast.visible { opacity: 1; transform: translateY(0); }
        .toast.sucesso { background-color: #27ae60; }
        .toast.erro { background-color: #e74c3c; }

        /* --- 6. ESTILOS EXTRAS E GEST√ÉO --- */
        .box-registro-visita { background: #f0f8ff; border: 1px solid #cceeff; border-radius: 8px; padding: 15px; margin-top: 15px; }
        .box-registro-visita label { font-size: 0.9rem; font-weight: bold; color: #3498db; display: block; margin-bottom: 5px; }
        .btn-print { background-color: #7f8c8d; color: white; margin-top: 5px; }

        .card-solicitacao, .item-usuario { background: #f9f9f9; padding: 10px; border-radius: 8px; border: 1px solid #eee; margin-bottom: 10px; }
        .item-usuario { background: white; display: flex; justify-content: space-between; align-items: center; padding: 15px; }
        .tags-roles span { background: #eef2f7; color: #3498db; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; margin-right: 4px; }
        .card-aprovacao { background: white; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-left: 5px solid #3498db; margin-bottom: 10px; overflow: hidden; }
        .aprovacao-resumo { padding: 15px; display: flex; align-items: center; justify-content: space-between; cursor: pointer; background: #fff; }
        .aprovacao-detalhes { padding: 0 15px 15px; display: none; background: #fff; border-top: 1px solid #f0f0f0; }
        .aprovacao-detalhes.aberto { display: block; animation: slideDown 0.3s ease; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        .lista-papeis { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin: 15px 0; background: #f9f9f9; padding: 10px; border-radius: 8px; }

        .checkbox-group { display: flex; flex-direction: column; gap: 10px; margin: 15px 0; }
        .checkbox-group label { display: flex; align-items: center; gap: 10px; font-size: 1rem; cursor: pointer; padding: 10px; background: #f9f9f9; border-radius: 6px; }
        .checkbox-group input { width: 20px; height: 20px; margin: 0; }
        
        .item-selecao { background: white; border: 1px solid #eee; margin-bottom: 8px; padding: 10px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .item-selecao:hover { background-color: #f9f9f9; border-color: #ccc; }

        /* --- 7. MAPAS --- */
        #conteudo-mapa { width: 100%; border-radius: 8px; z-index: 1; position: relative; }
        .lista-enderecos-cartao { margin-top: 15px; padding: 0; list-style: none; border-top: 1px solid #eee; padding-top: 10px; }
        .lista-enderecos-cartao li { background: #fff; border: 1px solid #ddd; border-left: 5px solid #3498db; border-radius: 6px; padding: 12px 15px; margin-bottom: 10px; display: flex; align-items: center; gap: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer; }
        .lista-enderecos-cartao .numero { font-weight: bold; font-size: 1.2rem; color: #3498db; min-width: 30px; text-align: center; }
        
        /* Mapa Fullscreen */
        .mapa-fullscreen { position: fixed !important; top: 0; left: 0; width: 100vw !important; height: 100vh !important; z-index: 9999 !important; background: white; border-radius: 0 !important; }
        .btn-fullscreen { position: absolute; top: 10px; right: 10px; z-index: 10000; background: white; border: none; width: 40px; height: 40px; border-radius: 50%; box-shadow: 0 2px 6px rgba(0,0,0,0.2); cursor: pointer; display: flex; align-items: center; justify-content: center; color: #333; }
        .mapa-fullscreen .btn-fullscreen { color: #c00; background: white; border: 2px solid #c00; }

        @media (max-width: 480px) { .container { grid-template-columns: 1fr; padding: 0 10px; } }
    </style>
</head>
<body>

    <div id="toast-container"></div>

    <header class="app-header hidden" id="app-header">
      <div class="app-title">
        <span class="material-icons" style="color:#3498db">map</span>
        <div style="display:flex; flex-direction:column; line-height:1;">
            <span>Territ√≥rios</span>
            <span id="header-nome-usuario" style="font-size:0.7rem; color:#666; font-weight:normal;"></span>
        </div>
      </div>
      <div class="header-actions">
        <button class="icon-btn hidden" id="btn-admin-bell" onclick="toggleModal('modal-admin')">
          <span class="material-icons">notifications</span>
          <span class="badge hidden" id="admin-badge">0</span>
        </button>
      </div>
    </header>

    <div id="tela-login" class="tela-central hidden">
      <h2>üë§ Entrar</h2>
      <p>Bem-vindo ao sistema.</p>
      <input type="email" id="login-email" placeholder="seuemail@exemplo.com">
      <button class="btn-azul" onclick="fazerLogin()">Acessar</button>
    </div>

    <div id="tela-pendente" class="tela-central hidden">
      <h2>‚è≥ Aguardando</h2>
      <span class="material-icons" style="font-size: 48px; color: #f39c12;">hourglass_top</span>
      <p>Sua solicita√ß√£o est√° em an√°lise.</p>
      <button onclick="fazerLogout()" style="background:#f0f0f0; color:#333;">Voltar</button>
    </div>

    <div id="tela-cadastro" class="tela-central hidden">
      <h2>üîí Acesso Restrito</h2>
      <p>Solicite seu cadastro.</p>
      <input type="text" id="cad-nome" placeholder="Seu Nome">
      <input type="tel" id="cad-tel" placeholder="Telefone">
      <button class="btn-azul" onclick="enviarSolicitacao()">Solicitar</button>
      <button onclick="fazerLogout()" style="background:transparent; color:#666; margin-top:5px;">Cancelar</button>
    </div>

    <div id="tela-sistema" class="hidden">
      <div id="lista-territorios" class="container"></div>
    </div>

    <nav class="app-footer hidden" id="app-footer">
      <button class="nav-item active" onclick="trocarAba(this, 'tela-sistema')"><span class="material-icons">dashboard</span> <span>Cart√µes</span> </button>
      <button class="nav-item hidden" id="nav-gestao" onclick="abrirGestaoTerritorios()"><span class="material-icons">folder_managed</span><span>Gest√£o</span></button>
      <button class="nav-item" onclick="toggleModal('modal-perfil')"><span class="material-icons">person</span><span>Perfil</span></button>
    </nav>

    <div id="modal-admin" class="modal-overlay hidden">
      <div class="modal-content">
        <div class="modal-header"><h3 style="margin:0">üîî Solicita√ß√µes</h3><button class="btn-close" onclick="toggleModal('modal-admin')"><span class="material-icons">close</span></button></div>
        <div class="modal-body" id="lista-solicitacoes"><p style="text-align:center;">Carregando...</p></div>
      </div>
    </div>

    <div id="modal-users" class="modal-overlay hidden">
      <div class="modal-content">
        <div class="modal-header"><h3 style="margin:0">Gerenciar Usu√°rios</h3><button class="btn-close" onclick="toggleModal('modal-users')"><span class="material-icons">close</span></button></div>
        <div class="modal-body" id="lista-users-body"></div>
      </div>
    </div>

    <div id="modal-designar" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 400px; align-self: center;">
            <div class="modal-header"><h3 style="margin:0">Designar</h3><button class="btn-close" onclick="toggleModal('modal-designar')"><span class="material-icons">close</span></button></div>
            <div class="modal-body">
                <p id="msg-designar-titulo">Para quem vai este cart√£o?</p>
                <select id="sel-designar-pub"><option value="">Carregando...</option></select>
                <div style="margin: 15px 0; padding: 10px; background: #f9f9f9; border-radius: 6px;">
                    <label style="display:flex; align-items:center; gap:8px; cursor:pointer;"><input type="checkbox" id="check-offline" onchange="toggleInputOffline()"> <strong>Publicador sem App</strong></label>
                    <input type="text" id="input-offline-nome" class="hidden" placeholder="Nome do irm√£o(√£)" style="margin-top:10px;">
                </div>
                <button class="btn-designar" id="btn-confirmar-designacao">Confirmar</button>
            </div>
        </div>
    </div>

    <div id="modal-endereco" class="modal-overlay hidden">
      <div class="modal-content">
        <div class="modal-header"><h3 style="margin:0" id="detalhes-endereco-titulo">Endere√ßo</h3><button class="btn-close" onclick="toggleModal('modal-endereco')"><span class="material-icons">close</span></button></div>
        <div class="modal-body">
            <div style="text-align:left; margin-bottom: 10px;">
                <p style="margin:2px 0; font-size:0.85rem; color:#666;">
                    <span id="detalhes-cidade">---</span> - <span id="detalhes-bairro">---</span>
                </p>
                <hr style="margin:5px 0; border:0; border-top:1px solid #eee;">
                <p style="font-size:1.1rem; margin:5px 0;"><strong id="detalhes-rua">---</strong>, <strong id="detalhes-numero">---</strong></p>
                <p style="color:#e67e22; margin:5px 0;"><strong>Ref:</strong> <span id="detalhes-referencia">---</span></p>
                <div style="display:flex; gap:10px; margin-top:10px;">
                    <a id="link-gps-externo" href="#" target="_blank" class="btn-azul" style="text-decoration:none; background:#4285F4; flex:1;">
                        <span class="material-icons" style="font-size:1rem; margin-right:5px;">directions</span> Ir (GPS)
                    </a>
                    <button class="btn-azul" id="btn-share-individual" style="background:#25D366; width:auto;">
                        <span class="material-icons">share</span>
                    </button>
                </div>
            </div>
            <div id="box-registro-visita-container" class="box-registro-visita hidden">
                <label>Registro de Casa (Apenas Publicador):</label>
                <select id="sel-status-visita">
                    <option value="">Selecione...</option>
                    <option value="Nao em casa">N√£o em casa</option>
                    <option value="Nao atendeu">N√£o atendeu</option>
                    <option value="Visitado">Visitado</option>
                </select>
                <input type="text" id="input-obs-visita" placeholder="Obs:">
                <button class="btn-verde" onclick="salvarVisitaAtual()">üíæ Salvar</button>
            </div>
            <div id="leaflet-map-unico" style="height:200px; width:100%; border-radius: 8px; margin-top:15px; position:relative;"></div>
        </div>
      </div>
    </div>

    <div id="modal-gestao-lista" class="modal-overlay hidden">
      <div class="modal-content">
        <div class="modal-header"><h3>Editar Territ√≥rios</h3><button class="btn-close" onclick="toggleModal('modal-gestao-lista')"><span class="material-icons">close</span></button></div>
        <div style="padding:10px;"><input type="text" placeholder="Filtrar..." onkeyup="filtrarListaEdicao(this.value)"></div>
        <div class="modal-body" id="lista-gestao-body"></div>
      </div>
    </div>

    <div id="modal-editar-territorio" class="modal-overlay hidden">
      <div class="modal-content" style="max-width:400px; align-self:center;">
        <div class="modal-header"><h3>Editar Dados</h3><button class="btn-close" onclick="toggleModal('modal-editar-territorio')"><span class="material-icons">close</span></button></div>
        <div class="modal-body">
            <h4 id="edit-terr-id">---</h4>
            <input type="text" id="edit-terr-nome">
            <button class="btn-verde" onclick="salvarEdicaoTerritorio()">Salvar</button>
        </div>
      </div>
    </div>

    <div id="modal-editar-usuario" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 400px; align-self: center;">
            <div class="modal-header"><h3 style="margin:0">Permiss√µes</h3><button class="btn-close" onclick="toggleModal('modal-editar-usuario')"><span class="material-icons">close</span></button></div>
            <div class="modal-body">
                <p id="edit-user-nome" style="font-weight: bold; margin-bottom: 10px;">---</p>
                <div class="checkbox-group">
                    <label><input type="checkbox" id="role-publicador" value="Publicador"> Publicador</label>
                    <label><input type="checkbox" id="role-dirigente" value="Dirigente"> Dirigente</label>
                    <label><input type="checkbox" id="role-admin" value="Admin"> Admin (Servo)</label>
                    <label><input type="checkbox" id="role-editor" value="Editor"> Editor</label>
                </div>
                <button class="btn-verde" onclick="salvarEdicaoViaModal()">Salvar</button>
                <button class="btn-vermelho" style="margin-top:10px; background:#eee; color:#333;" onclick="toggleModal('modal-editar-usuario')">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="modal-perfil" class="modal-overlay hidden">
      <div class="modal-content">
        <div class="modal-header"><h3>Perfil</h3><button class="btn-close" onclick="toggleModal('modal-perfil')"><span class="material-icons">close</span></button></div>
        <div class="modal-body" style="text-align:center;">
            <h2 id="perfil-nome">---</h2>
            <p id="perfil-email">---</p>
            <p id="perfil-funcao" style="color:#3498db; font-weight:bold;">---</p>
            <div id="area-admin-panel" class="hidden"><button class="btn-designar" onclick="abrirGestaoUsuarios()">Gerenciar Usu√°rios</button></div>
            <button class="btn-azul" onclick="atualizarPWA()" style="background:#f1c40f; color:#333;">Buscar Atualiza√ß√£o</button>
            <button class="btn-vermelho" onclick="fazerLogout()">Sair</button>
        </div>
      </div>
    </div>

    <div id="modal-mapa" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header"><h3 style="margin:0" id="titulo-mapa">...</h3><button class="btn-close" onclick="toggleModal('modal-mapa')"><span class="material-icons">close</span></button></div>
            <div class="modal-body"><div id="conteudo-mapa"></div></div>
        </div>
    </div>

    <div id="modal-confirmacao" class="modal-overlay hidden">
        <div class="modal-content"><h3>Confirma√ß√£o</h3><p id="confirm-texto"></p>
            <div style="display:flex; gap:10px;"><button id="confirm-sim" class="btn-azul">Sim</button><button onclick="toggleModal('modal-confirmacao')" class="btn-azul" style="background:#eee; color:#333;">N√£o</button></div>
        </div>
    </div>

    <div id="modal-selecao" class="modal-overlay hidden">
      <div class="modal-content" style="height: 80vh;">
        <div class="modal-header"><h3 style="margin:0;">Escolher Territ√≥rio</h3><button class="btn-close" onclick="toggleModal('modal-selecao')"><span class="material-icons">close</span></button></div>
        <div style="padding:10px; border-bottom:1px solid #eee;">
            <input type="text" placeholder="Filtrar..." onkeyup="filtrarListaSelecao(this.value)" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:6px;">
        </div>
        <div id="corpo-selecao" class="modal-body" style="background:#f4f6f8;">
          <p style="text-align:center; padding:20px; color:#666;">Carregando...</p>
        </div>
      </div>
    </div>

<script>
// ============================================
// CONFIGURA√á√ÉO API
const API_URL = "https://script.google.com/macros/s/AKfycbw_B0RlBbzKBft76h-HT1kYjE9fbh2udZfZ-uuMMgmLReBlFiIl2N3Xkv_pE8ndBKn1mA/exec"; 
// ============================================

var usuarioEmail = ""; var usuarioNome = ""; var usuarioNivel = "";
var mapaAtual = null; var mapaUnico = null; var enderecosCache = {}; var territorioInfoCache = {};
var idTerritorioParaDesignar = null; var emailUsuarioEdicao = null; var idTerritorioEdicao = null;
var enderecoAtualId = null; var territorioAtualId = null; var registroTrabalhoLocal = {};

async function chamarAPI(acao, dados = {}) {
    if (API_URL.includes("SUA_URL")) return { erro: "Configura√ß√£o" };
    dados.acao = acao;
    try {
        const response = await fetch(API_URL, { method: "POST", body: JSON.stringify(dados) });
        return await response.json();
    } catch (e) { return { erro: e.toString() }; }
}

function toggleModal(id) {
    var modal = document.getElementById(id);
    if (modal) modal.classList.toggle('hidden');
}

function mostrarNotificacao(msg, tipo = "sucesso") {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast ${tipo}`;
    toast.innerHTML = `<span class="material-icons">${tipo==='sucesso'?'check_circle':'error'}</span> <span>${msg}</span>`;
    container.appendChild(toast);
    setTimeout(() => toast.classList.add('visible'), 10);
    setTimeout(() => { toast.classList.remove('visible'); setTimeout(() => toast.remove(), 300); }, 3000);
}

function atualizarPWA() {
    if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
        mostrarNotificacao("Verificando atualiza√ß√µes...", "sucesso");
        navigator.serviceWorker.controller.postMessage({ type: 'SKIP_WAITING' });
        setTimeout(() => window.location.reload(), 1000);
    } else { window.location.reload(); }
}

window.onload = function() {
  var emailSalvo = localStorage.getItem('app_territorios_email');
  if (emailSalvo) { document.getElementById('login-email').value = emailSalvo; fazerLogin(); }
  else { document.getElementById('tela-login').classList.remove('hidden'); }
};

function fazerLogin() {
  var email = document.getElementById('login-email').value.trim();
  if (!email) return mostrarNotificacao("Digite seu e-mail.", "erro");
  usuarioEmail = email;
  chamarAPI("verificarLogin", { email: email }).then(processarLogin);
}

function processarLogin(r) {
  document.getElementById('tela-login').classList.add('hidden');
  document.getElementById('tela-pendente').classList.add('hidden');
  document.getElementById('tela-cadastro').classList.add('hidden');

  if (r.status === "APROVADO") {
    usuarioNome = r.nome; usuarioNivel = r.nivel;
    localStorage.setItem('app_territorios_email', usuarioEmail);
    document.getElementById('perfil-nome').innerText = r.nome;
    document.getElementById('perfil-email').innerText = usuarioEmail;
    document.getElementById('perfil-funcao').innerText = r.nivel;
    if(document.getElementById('header-nome-usuario')) document.getElementById('header-nome-usuario').innerText = r.nome.split(' ')[0];

    var roles = r.nivel.toLowerCase();
    var isAdmin = roles.includes('admin') || roles.includes('servo');
    document.getElementById('area-admin-panel').classList.toggle('hidden', !isAdmin);
    document.getElementById('nav-gestao').classList.toggle('hidden', !(isAdmin || roles.includes('editor')));
    document.getElementById('btn-admin-bell').classList.toggle('hidden', !isAdmin);

    if ((roles.includes('editor') || isAdmin) && !document.querySelector('.btn-print')) {
        var btnPrint = document.createElement('button');
        btnPrint.className = 'btn-print';
        btnPrint.innerHTML = '<span class="material-icons">print</span> Imprimir Cart√µes';
        btnPrint.onclick = () => alert("Gera√ß√£o de PDF em desenvolvimento.");
        document.querySelector('#modal-perfil .modal-body').insertBefore(btnPrint, document.querySelector('#modal-perfil .modal-body').lastElementChild);
    }

    document.getElementById('app-header').classList.remove('hidden');
    document.getElementById('app-footer').classList.remove('hidden');
    document.getElementById('tela-sistema').classList.remove('hidden');
    carregarSistema();
  } else if (r.status === "PENDENTE") { document.getElementById('tela-pendente').classList.remove('hidden'); }
  else { document.getElementById('tela-cadastro').classList.remove('hidden'); }
}

function carregarSistema() {
  document.getElementById('lista-territorios').innerHTML = '<p style="text-align:center;">Carregando...</p>';
  chamarAPI("buscarTerritorios", { email: usuarioEmail }).then(renderizarDados);
  carregarSolicitacoes();
}

function renderizarDados(res) {
  var div = document.getElementById('lista-territorios'); div.innerHTML = '';
  var isAdmin = usuarioNivel.toLowerCase().includes('admin') || usuarioNivel.toLowerCase().includes('dirigente');

  (res.mapas || []).forEach(t => {
    var classe = t.isMeu ? 'status-Meu' : 'status-' + t.status;
    var btnHtml = '';
    
    if (t.isMeu) {
        btnHtml += `<button class="btn-vermelho" onclick="tendarDevolver('${t.id}')">Devolver</button>`;
    } else if (isAdmin && t.status === 'Ocupado') {
        btnHtml += `<button class="btn-vermelho" style="border:1px dashed red;" onclick="tendarDevolver('${t.id}')">Devolver (Admin)</button>`;
    } else if (t.status === 'Livre') {
        btnHtml += `<button class="btn-pedir" onclick="acionar('${t.id}', 'pedir')">Pedir</button>`;
    } else {
        btnHtml += `<button class="btn-desabilitado" disabled>Ocupado</button>`;
    }

    if (t.podeGerenciar) btnHtml += `<button class="btn-designar" onclick="acionar('${t.id}', 'designar')">Designar</button>`;
    var mapBtn = t.podeAbrir || isAdmin ? `<button class="btn-mapa" onclick="abrirMapa('${t.id}', '${t.nome}')">Ver Endere√ßos</button>` : '';
    
    var info = (t.status === 'Ocupado' && t.responsavel) ? `<div style="margin-top:8px;color:#555;font-size:0.85rem;"><i class="material-icons" style="font-size:14px;">person</i> ${t.responsavel}</div>` : '';

    div.innerHTML += `<div class="card ${classe}"><h3>${t.id}</h3><p><b>${t.nome}</b></p><p>${t.status}${t.isMeu ? ' (Voc√™)' : ''}</p>${info}${btnHtml}${mapBtn}</div>`;
  });
}

function trocarAba(btn, id) {
    document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
}

// --- MAPAS & VISITAS PREMIUM ---
function abrirMapa(id, nome) {
    toggleModal('modal-mapa');
    document.getElementById('titulo-mapa').innerText = 'Cart√£o N¬∫: ' + id;
    
    chamarAPI("buscarEnderecosPorTerritorio", { id: id }).then(res => {
         enderecosCache[id] = res.enderecos;
         territorioInfoCache[id] = { nome: nome, cidade: res.cidade };
         
         document.getElementById('conteudo-mapa').innerHTML = 
            '<div id="leaflet-map-container" style="height:250px; position:relative;">' +
                '<button class="btn-fullscreen" onclick="toggleFullscreenMap(\'leaflet-map-container\')">' +
                    '<span class="material-icons">fullscreen</span>' +
                '</button>' +
            '</div>' +
            '<ul class="lista-enderecos-cartao"></ul>' +
            '<div id="area-botoes-mapa-geral" style="display:flex; flex-direction:column; gap:10px; margin-top:10px;"></div>';
         
         var ul = document.querySelector('.lista-enderecos-cartao');
         if (!registroTrabalhoLocal[id]) registroTrabalhoLocal[id] = [];
         
         setTimeout(() => {
            if(mapaAtual) mapaAtual.remove();
            mapaAtual = L.map('leaflet-map-container');
            L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mapaAtual);
            var bounds = [];
            
            res.enderecos.forEach((end, i) => {
                bounds.push([end.lat, end.lng]);
                var check = registroTrabalhoLocal[id].includes(end.id) ? '‚úÖ' : '';
                var refHtml = end.referencia ? `<br><small style="color:#e67e22">Ref: ${end.referencia}</small>` : '';
                
                var li = document.createElement('li');
                li.innerHTML = `<strong>${i+1}. ${end.rua}, ${end.numero}</strong> ${check} ${refHtml}`;
                li.onclick = () => abrirDetalhesEndereco(i+1, id);
                ul.appendChild(li);
                L.marker([end.lat, end.lng]).addTo(mapaAtual).bindPopup(`${i+1}. ${end.rua}`);
            });
            
            if(bounds.length) mapaAtual.fitBounds(bounds, {padding:[20,20]});
            adicionarBotoesMapaGeral(id, nome, res.enderecos);
         }, 200);
    });
}

function adicionarBotoesMapaGeral(id, nome, ends) {
    var area = document.getElementById('area-botoes-mapa-geral');
    if(!area) return;
    area.innerHTML = ''; 

    var btnZap = document.createElement('button');
    btnZap.className = 'btn-verde';
    btnZap.innerHTML = '<span class="material-icons">share</span> Enviar Lista no WhatsApp';
    btnZap.onclick = () => {
         var linkRota = gerarLinkRota(ends);
         var listaTxt = ends.map((e,i) => `${i+1}. ${e.rua}, ${e.numero} ${e.referencia ? '('+e.referencia+')' : ''}`).join('\n');
         var txt = `üó∫Ô∏è *Territ√≥rio ${id} - ${nome}*\n\n${listaTxt}\n\nüöó *Rota GPS:* ${linkRota}`;
         window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent(txt)}`);
    };

    var btnRota = document.createElement('button');
    btnRota.className = 'btn-azul';
    btnRota.style.background = '#4285F4';
    btnRota.innerHTML = '<span class="material-icons">directions_car</span> Abrir Rota Completa (Maps)';
    btnRota.onclick = () => { window.open(gerarLinkRota(ends), '_blank'); };

    area.appendChild(btnZap);
    area.appendChild(btnRota);
}

function gerarLinkRota(enderecos) {
    if (!enderecos || enderecos.length === 0) return "";
    var ultimo = enderecos[enderecos.length - 1];
    var dest = `${ultimo.lat},${ultimo.lng}`;
    var ways = enderecos.slice(0, enderecos.length - 1).map(e => `${e.lat},${e.lng}`).join('|');
    return `https://www.google.com/maps/dir/?api=1&destination=${dest}&waypoints=${ways}&travelmode=driving`;
}

function toggleFullscreenMap(idContainer) {
    var el = document.getElementById(idContainer);
    var btn = el.querySelector('.btn-fullscreen span');
    if (el.classList.contains('mapa-fullscreen')) {
        el.classList.remove('mapa-fullscreen');
        btn.innerText = 'fullscreen';
        btn.parentElement.style.color = '#333';
        btn.parentElement.style.border = 'none';
    } else {
        el.classList.add('mapa-fullscreen');
        btn.innerText = 'close';
        btn.parentElement.style.color = '#c00';
        btn.parentElement.style.border = '2px solid #c00';
    }
    setTimeout(() => { if(mapaAtual) mapaAtual.invalidateSize(); if(mapaUnico) mapaUnico.invalidateSize(); }, 200);
}

function abrirDetalhesEndereco(num, id) {
    var end = enderecosCache[id][num-1];
    enderecoAtualId = end.id; territorioAtualId = id;
    
    var info = territorioInfoCache[id] || {};
    document.getElementById('detalhes-cidade').innerText = info.cidade || '';
    document.getElementById('detalhes-bairro').innerText = info.nome || '';
    document.getElementById('detalhes-endereco-titulo').innerText = 'Endere√ßo N¬∫ ' + num;
    document.getElementById('detalhes-rua').innerText = end.rua;
    document.getElementById('detalhes-numero').innerText = end.numero;
    document.getElementById('detalhes-referencia').innerText = end.referencia || '-';
    document.getElementById('link-gps-externo').href = `https://www.google.com/maps/dir/?api=1&destination=${end.lat},${end.lng}`;
    
    document.getElementById('btn-share-individual').onclick = function() {
        var txt = `üìç *Endere√ßo:* ${end.rua}, ${end.numero}\nRef: ${end.referencia||''}\n\nüó∫Ô∏è *GPS:* https://www.google.com/maps/dir/?api=1&destination=${end.lat},${end.lng}`;
        window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent(txt)}`);
    };

    var box = document.getElementById('box-registro-visita-container');
    // Controle de visualiza√ß√£o se necess√°rio: box.classList.toggle('hidden', ...);

    document.getElementById('sel-status-visita').value = "";
    document.getElementById('input-obs-visita').value = "";

    if(mapaUnico) mapaUnico.remove();
    toggleModal('modal-endereco');
    
    document.getElementById('leaflet-map-unico').innerHTML = '<button class="btn-fullscreen" onclick="toggleFullscreenMap(\'leaflet-map-unico\')"><span class="material-icons">fullscreen</span></button>';

    setTimeout(() => {
        mapaUnico = L.map('leaflet-map-unico').setView([end.lat, end.lng], 18);
        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mapaUnico);
        L.marker([end.lat, end.lng]).addTo(mapaUnico);
    }, 200);
}

function salvarVisitaAtual() {
    var status = document.getElementById('sel-status-visita').value;
    var obs = document.getElementById('input-obs-visita').value;
    if(!status) return mostrarNotificacao("Selecione o status", "erro");
    if(!registroTrabalhoLocal[territorioAtualId].includes(enderecoAtualId)) registroTrabalhoLocal[territorioAtualId].push(enderecoAtualId);
    chamarAPI("salvarRegistroVisita", { idTerritorio: territorioAtualId, idEndereco: enderecoAtualId, status: status, obs: obs, publicador: usuarioEmail }).then(() => { 
        mostrarNotificacao("Salvo!"); toggleModal('modal-endereco');
        abrirMapa(territorioAtualId, territorioInfoCache[territorioAtualId].nome);
    });
}

function tendarDevolver(id) {
    var visitados = (registroTrabalhoLocal[id] || []).length;
    var total = (enderecosCache[id] || []).length;
    var roles = usuarioNivel.toLowerCase();
    var isSuper = roles.includes('admin') || roles.includes('dirigente');
    
    if (!isSuper && total > 0 && visitados < total) {
        if (!confirm(`Aten√ß√£o: Voc√™ registrou apenas ${visitados} de ${total} endere√ßos. Tem certeza que deseja devolver?`)) return;
    }
    acionar(id, 'devolver');
}

function acionar(id, acao) {
    if (acao === 'designar') { idTerritorioParaDesignar = id; toggleModal('modal-designar'); carregarListaPublicadores(); return; }
    var txt = acao === 'devolver' ? "Confirmar devolu√ß√£o e arquivar?" : "Pedir este territ√≥rio?";
    confirmarAcao('Confirma√ß√£o', txt, () => {
        chamarAPI("processarAcaoTerritorio", { id: id, tipoAcao: acao, email: usuarioEmail }).then(r => { 
            if(r.erro) mostrarNotificacao(r.erro, "erro");
            else { mostrarNotificacao(r.sucesso); carregarSistema(); }
        });
    });
}

// --- OFFLINE & GEST√ÉO ---
function toggleInputOffline() {
    var isOff = document.getElementById('check-offline').checked;
    document.getElementById('sel-designar-pub').classList.toggle('hidden', isOff);
    document.getElementById('input-offline-nome').classList.toggle('hidden', !isOff);
}

function carregarListaPublicadores() {
    chamarAPI("listarTodosUsuarios").then(res => {
        var sel = document.getElementById('sel-designar-pub'); sel.innerHTML = '<option value="">Selecione...</option>';
        (res.usuarios || []).forEach(u => sel.innerHTML += `<option value="${u.email}">${u.nome}</option>`);
        document.getElementById('btn-confirmar-designacao').onclick = finalizarDesignacao;
    });
}

function finalizarDesignacao() {
    var off = document.getElementById('check-offline').checked;
    var payload = { id: idTerritorioParaDesignar, tipoAcao: "designar", email: document.getElementById('sel-designar-pub').value };
    if(off) payload.nomeOffline = document.getElementById('input-offline-nome').value;
    chamarAPI("processarAcaoTerritorio", payload).then(() => { toggleModal('modal-designar'); carregarSistema(); });
}

function abrirGestaoTerritorios() {
    toggleModal('modal-gestao-lista');
    chamarAPI("listarTodosTerritoriosAdmin").then(res => {
        var body = document.getElementById('lista-gestao-body'); body.innerHTML = '';
        res.forEach(t => body.innerHTML += `<div class="item-selecao" onclick="abrirEdicaoTerritorio('${t.id}','${t.nome}')"><b>${t.id}</b> - ${t.nome}</div>`);
    });
}

function filtrarListaEdicao(v) {
    document.querySelectorAll('#lista-gestao-body .item-selecao').forEach(i => i.style.display = i.innerText.toLowerCase().includes(v.toLowerCase()) ? 'flex' : 'none');
}

function abrirEdicaoTerritorio(id, nome) {
    idTerritorioEdicao = id; document.getElementById('edit-terr-id').innerText = id;
    document.getElementById('edit-terr-nome').value = nome;
    toggleModal('modal-gestao-lista'); toggleModal('modal-editar-territorio');
}

function salvarEdicaoTerritorio() {
    chamarAPI("salvarDadosTerritorio", { idTerritorio: idTerritorioEdicao, novoNome: document.getElementById('edit-terr-nome').value })
    .then(() => { toggleModal('modal-editar-territorio'); carregarSistema(); });
}

function abrirGestaoUsuarios() {
    toggleModal('modal-perfil'); toggleModal('modal-users');
    chamarAPI("listarTodosUsuarios").then(res => {
        var body = document.getElementById('lista-users-body'); body.innerHTML = '';
        res.usuarios.forEach(u => body.innerHTML += `<div class="item-usuario"><b>${u.nome}</b><br><small>${u.email}</small></div><button class="icon-btn" onclick="abrirModalEdicao('${u.email}', '${u.nome}', '${u.nivel}')"><span class="material-icons">edit</span></button>`);
    });
}

function abrirModalEdicao(email, nome, nivel) {
    emailUsuarioEdicao = email;
    document.getElementById('edit-user-nome').innerText = nome;
    ['role-publicador', 'role-dirigente', 'role-admin', 'role-editor'].forEach(id => document.getElementById(id).checked = false);
    var roles = nivel.toLowerCase();
    if (roles.includes('publicador')) document.getElementById('role-publicador').checked = true;
    if (roles.includes('dirigente')) document.getElementById('role-dirigente').checked = true;
    if (roles.includes('admin') || roles.includes('servo')) document.getElementById('role-admin').checked = true;
    if (roles.includes('editor')) document.getElementById('role-editor').checked = true;
    toggleModal('modal-editar-usuario');
}

function salvarEdicaoViaModal() {
    if (!emailUsuarioEdicao) return;
    var checks = [];
    if(document.getElementById('role-publicador').checked) checks.push("Publicador");
    if(document.getElementById('role-dirigente').checked) checks.push("Dirigente");
    if(document.getElementById('role-admin').checked) checks.push("Admin");
    if(document.getElementById('role-editor').checked) checks.push("Editor");

    if (checks.length === 0) {
        if(confirm("Excluir usu√°rio?")) {
            chamarAPI("excluirUsuario", { adminEmail: usuarioEmail, emailAlvo: emailUsuarioEdicao }).then(() => { toggleModal('modal-editar-usuario'); abrirGestaoUsuarios(); });
        }
        return;
    }
    chamarAPI("salvarEdicaoUsuario", { adminEmail: usuarioEmail, emailAlvo: emailUsuarioEdicao, novosPapeis: checks.join(", ") }).then(() => { toggleModal('modal-editar-usuario'); abrirGestaoUsuarios(); });
}

function carregarSolicitacoes() {
    chamarAPI("buscarSolicitacoes", { email: usuarioEmail }).then(lista => {
        var div = document.getElementById('lista-solicitacoes'); div.innerHTML = '';
        var badge = document.getElementById('admin-badge');
        if (!lista.length) { badge.classList.add('hidden'); div.innerHTML = '<p style="text-align:center">Nada pendente.</p>'; return; }
        badge.innerText = lista.length; badge.classList.remove('hidden');
        lista.forEach((p, i) => {
            // Recriando o cart√£o de aprova√ß√£o complexo (Com checkboxes de papel)
            var ehTerritorio = p.tipo === "TERRITORIO";
            var html = ehTerritorio ?
                `<div class="card-aprovacao" style="padding:10px; margin-bottom:5px; border-left:5px solid #f39c12;">
                    <b>üó∫Ô∏è Pedido de Mapa</b><br>${p.nome} quer o ${p.info}
                    <div style="margin-top:5px; display:flex; gap:5px;">
                        <button class="btn-designar" onclick="aprovarPedido('${p.email}', '${p.info}')">Aprovar</button>
                        <button class="btn-azul" style="background:#eee; color:#333" onclick="sugerirOutro('${p.email}', '${p.info}')">Sugerir</button>
                        <button class="btn-vermelho" onclick="recusarPedido('${p.email}', '${p.info}', 'TERRITORIO')">X</button>
                    </div>
                </div>` :
                `<div class="card-aprovacao" style="padding:10px; margin-bottom:5px;">
                    <b>üë§ Novo Cadastro</b><br>${p.nome}<br><small>${p.email}</small>
                    <div class="lista-papeis" id="roles-new-${i}" style="margin:5px 0;">
                        <label><input type="checkbox" value="Publicador" checked> Pub</label>
                        <label><input type="checkbox" value="Dirigente"> Dir</label>
                        <label><input type="checkbox" value="Editor"> Ed</label>
                        <label><input type="checkbox" value="Admin"> Adm</label>
                    </div>
                    <div style="margin-top:5px; display:flex; gap:5px;">
                        <button class="btn-verde" onclick="processarAprovacaoCadastro('${p.email}', '${p.nome}', 'roles-new-${i}')">Confirmar</button>
                        <button class="btn-vermelho" onclick="recusarPedido('${p.email}', '${p.info}', 'ACESSO')">X</button>
                    </div>
                </div>`;
            div.innerHTML += html;
        });
    });
}

function processarAprovacaoCadastro(email, nome, idContainer) {
    var checks = document.querySelectorAll(`#${idContainer} input:checked`);
    if (!checks.length) return mostrarNotificacao("Selecione um papel.", "erro");
    var papeis = Array.from(checks).map(c => c.value).join(", ");
    confirmarAcao("Aprovar", `Aprovar ${nome} como ${papeis}?`, () => {
        chamarAPI("aprovarCadastro", { adminEmail: usuarioEmail, emailAlvo: email, nomeAlvo: nome, nivel: papeis }).then(() => {
            mostrarNotificacao("Aprovado!"); carregarSolicitacoes();
        });
    });
}

function aprovarPedido(email, id) { confirmarAcao("Aprovar", "Confirmar?", () => chamarAPI("aprovarPedidoTerritorio", { email: email, idTerritorio: id }).then(carregarSistema)); }
function recusarPedido(email, info, tipo) { chamarAPI("recusarSolicitacao", { email: email, info: info, tipo: tipo }).then(carregarSolicitacoes); }
function sugerirOutro(email, id) { abrirSeletorTerritorio(novo => chamarAPI("sugerirTrocaTerritorio", { email: email, idAtual: id, novoID: novo }).then(carregarSolicitacoes)); }

function abrirSeletorTerritorio(cb) {
    window.callbackSelecao = cb; toggleModal('modal-selecao');
    chamarAPI("listarTodosTerritoriosAdmin").then(res => {
        var body = document.getElementById('corpo-selecao'); body.innerHTML = '';
        res.forEach(t => body.innerHTML += `<div class="item-selecao" onclick="toggleModal('modal-selecao'); window.callbackSelecao('${t.id}')"><b>${t.id}</b> - ${t.nome} (${t.status})</div>`);
    });
}

function enviarSolicitacao() { chamarAPI("solicitarCadastro", { nome: document.getElementById('cad-nome').value, tel: document.getElementById('cad-tel').value, email: usuarioEmail }).then(() => location.reload()); }
function fazerLogout() { localStorage.clear(); location.reload(); }

function confirmarAcao(tit, txt, cb) {
    document.getElementById('confirm-titulo').innerText = tit;
    document.getElementById('confirm-texto').innerText = txt;
    var btn = document.getElementById('confirm-sim');
    var novo = btn.cloneNode(true); btn.parentNode.replaceChild(novo, btn);
    novo.onclick = () => { toggleModal('modal-confirmacao'); cb(); };
    toggleModal('modal-confirmacao');
}

// Service Worker Logic
if ('serviceWorker' in navigator) { navigator.serviceWorker.register('./service-worker.js'); }
</script>

</body>
</html>
