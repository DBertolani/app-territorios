<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8">
    <title>Territ√≥rios Conectados | Gest√£o PWA</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Sistema de Gest√£o de Territ√≥rios da Congrega√ß√£o - Vers√£o PWA 2.0">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2c3e50">
    
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        /* --- ARQUITETURA CSS (Vari√°veis para Tema Consistente) --- */
        :root {
            --primary-color: #3498db;
            --secondary-color: #2c3e50;
            --accent-color: #e74c3c;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --bg-color: #f4f6f8;
            --card-bg: #ffffff;
            --text-main: #333333;
            --text-light: #7f8c8d;
            --shadow-sm: 0 2px 5px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 15px rgba(0,0,0,0.1);
            --radius: 12px;
        }

        /* --- RESET E BASE --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg-color); margin: 0; padding-top: 70px; padding-bottom: 80px; color: var(--text-main); }
        
        /* --- COMPONENTES DE UI --- */
       .hidden { display: none!important; }
        
        /* Bot√µes */
       .btn { border: none; border-radius: 8px; padding: 12px 20px; font-weight: 600; cursor: pointer; transition: transform 0.1s, opacity 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 8px; width: 100%; font-size: 0.95rem; }
       .btn:active { transform: scale(0.98); }
       .btn-primary { background-color: var(--primary-color); color: white; }
       .btn-success { background-color: var(--success-color); color: white; }
       .btn-danger { background-color: var(--accent-color); color: white; }
       .btn-warning { background-color: var(--warning-color); color: white; }
       .btn-ghost { background-color: transparent; color: var(--text-light); border: 1px solid #ddd; }
        
        /* Header Fixo */
       .app-header { position: fixed; top: 0; left: 0; right: 0; height: 60px; background: var(--card-bg); display: flex; align-items: center; justify-content: space-between; padding: 0 16px; box-shadow: var(--shadow-sm); z-index: 1000; }
       .header-title { font-size: 1.2rem; font-weight: 700; color: var(--secondary-color); display: flex; align-items: center; gap: 8px; }
        
        /* PWA Toast de Atualiza√ß√£o */
        #pwa-update-toast {
            position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%);
            background-color: var(--secondary-color); color: white;
            padding: 12px 24px; border-radius: 50px;
            display: flex; align-items: center; gap: 12px;
            box-shadow: var(--shadow-md); z-index: 9999;
            cursor: pointer; opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        #pwa-update-toast.visible { opacity: 1; pointer-events: all; }

        /* Cards de Territ√≥rio */
       .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px; padding: 16px; max-width: 1200px; margin: 0 auto; }
       .territory-card { background: var(--card-bg); border-radius: var(--radius); padding: 16px; box-shadow: var(--shadow-sm); border-left: 5px solid #ccc; position: relative; }
       .status-Livre { border-left-color: var(--success-color); }
       .status-Ocupado { border-left-color: var(--accent-color); }
       .status-Meu { border-left-color: var(--primary-color); background-color: #f0f8ff; border: 2px solid var(--primary-color); }

        /* Painel do Servo (Admin) */
       .admin-dashboard { background: var(--card-bg); border-radius: var(--radius); padding: 20px; margin: 16px; box-shadow: var(--shadow-sm); }
       .admin-tabs { display: flex; border-bottom: 2px solid #eee; margin-bottom: 15px; }
       .admin-tab { padding: 10px 20px; cursor: pointer; color: var(--text-light); font-weight: 600; border-bottom: 2px solid transparent; }
       .admin-tab.active { color: var(--primary-color); border-bottom-color: var(--primary-color); }
        
       .user-list-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #eee; }
       .user-role-badge { padding: 4px 8px; border-radius: 12px; font-size: 0.75rem; background: #eee; color: #555; font-weight: bold; }
       .role-Admin { background: #fdebd0; color: #d35400; }
       .role-Dirigente { background: #d4e6f1; color: #2980b9; }

        /* Modais */
       .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000; display: flex; justify-content: center; align-items: flex-end; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
       .modal-backdrop.active { opacity: 1; pointer-events: auto; }
       .modal-content { background: var(--card-bg); width: 100%; max-width: 600px; border-radius: 20px 20px 0 0; max-height: 90vh; display: flex; flex-direction: column; animation: slideUp 0.3s ease; }
        @media(min-width: 600px) {.modal-backdrop { align-items: center; }.modal-content { border-radius: 20px; height: auto; } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        /* Footer Nav */
       .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; height: 60px; background: var(--card-bg); border-top: 1px solid #eee; display: flex; justify-content: space-around; align-items: center; z-index: 1000; }
       .nav-btn { background: none; border: none; display: flex; flex-direction: column; align-items: center; color: var(--text-light); font-size: 0.75rem; gap: 4px; }
       .nav-btn.active { color: var(--primary-color); }
       .nav-btn i { font-size: 24px; }

    </style>
</head>
<body>

    <header class="app-header" id="main-header">
        <div class="header-title">
            <span class="material-icons" style="color:var(--primary-color)">map</span>
            <span>Territ√≥rios</span>
        </div>
        <button class="btn-ghost" style="width:auto; padding:5px;" onclick="syncData()">
            <span class="material-icons">sync</span>
        </button>
    </header>

    <div id="pwa-update-toast" onclick="applyUpdate()">
        <span class="material-icons">system_update</span>
        <div>
            <strong>Atualiza√ß√£o Dispon√≠vel</strong>
            <div style="font-size:0.8rem">Toque para aplicar a nova vers√£o</div>
        </div>
    </div>

    <div id="view-login" class="grid-container" style="text-align:center; padding-top: 10vh;">
        <span class="material-icons" style="font-size: 64px; color: var(--primary-color);">account_circle</span>
        <h2>Acesso ao Sistema</h2>
        <p style="color:var(--text-light);">Identifique-se para acessar os mapas.</p>
        <input type="email" id="login-email" placeholder="seu@email.com" style="width:100%; padding:15px; margin-bottom:15px; border:1px solid #ccc; border-radius:8px;">
        <button class="btn btn-primary" onclick="processLogin()">Entrar</button>
        <button class="btn btn-ghost" style="margin-top:10px;" onclick="showRequestAccess()">Solicitar Cadastro</button>
    </div>

    <div id="view-list" class="grid-container hidden">
        </div>

    <div id="modal-admin" class="modal-backdrop">
        <div class="modal-content">
            <div style="padding:15px; border-bottom:1px solid #eee; display:flex; justify-content:space-between;">
                <h3 style="margin:0">Painel do Servo</h3>
                <span class="material-icons" onclick="closeModal('modal-admin')">close</span>
            </div>
            <div style="padding:0;">
                <div class="admin-tabs">
                    <div class="admin-tab active" onclick="switchAdminTab('users')">Usu√°rios</div>
                    <div class="admin-tab" onclick="switchAdminTab('requests')">Solicita√ß√µes <span id="badge-requests" style="background:red; color:white; border-radius:50%; padding:2px 6px; font-size:0.7rem; display:none;">0</span></div>
                </div>
                <div id="admin-content-users" style="padding:15px; max-height:60vh; overflow-y:auto;">
                    <p>Carregando usu√°rios...</p>
                </div>
                <div id="admin-content-requests" class="hidden" style="padding:15px; max-height:60vh; overflow-y:auto;">
                    <p>Nenhuma solicita√ß√£o pendente.</p>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-profile" class="modal-backdrop">
        <div class="modal-content">
            <div style="padding:20px; text-align:center;">
                <span class="material-icons" style="font-size:48px; color:var(--text-light)">person</span>
                <h2 id="profile-name" style="margin:10px 0;">Nome</h2>
                <p id="profile-email" style="color:var(--text-light); margin-bottom:20px;">Email</p>
                <div id="profile-roles-container" style="margin-bottom:20px;"></div>
                
                <div style="background:#f9f9f9; padding:15px; border-radius:8px; text-align:left; margin-bottom:20px;">
                    <strong>Minhas Estat√≠sticas</strong>
                    <div style="display:flex; justify-content:space-between; margin-top:10px;">
                        <span>Territ√≥rios Ativos:</span>
                        <strong id="stat-active-maps">0</strong>
                    </div>
                </div>

                <button class="btn btn-danger" onclick="doLogout()">Sair</button>
                <button class="btn btn-ghost" style="margin-top:10px;" onclick="closeModal('modal-profile')">Fechar</button>
            </div>
        </div>
    </div>

<div id="modal-map-view" class="modal-backdrop">
        <div class="modal-content" style="height: 90vh;">
            <div style="padding:15px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <h3 style="margin:0" id="map-title">Territ√≥rio</h3>
                    <small id="map-subtitle" style="color:var(--text-light)">Carregando...</small>
                </div>
                <span class="material-icons" onclick="closeModal('modal-map-view')">close</span>
            </div>
            
            <div id="map-body" style="flex:1; overflow-y:auto; padding:0;">
                <div id="leaflet-map" style="height: 40vh; width: 100%; background: #eee;"></div>
                
                <div id="address-list" style="padding:15px;"></div>
            </div>

            <div style="padding:15px; border-top:1px solid #eee; display:flex; gap:10px;">
                <button class="btn btn-success" onclick="shareMapWhatsApp()">
                    <span class="material-icons">share</span> WhatsApp
                </button>
                <button class="btn btn-primary" onclick="openNativeMaps()">
                    <span class="material-icons">map</span> GPS
                </button>
            </div>
        </div>
    </div>

    <div id="modal-assign" class="modal-backdrop">
        <div class="modal-content">
            <div style="padding:20px;">
                <h3>Designar Territ√≥rio</h3>
                <p id="assign-territory-info" style="color:var(--text-light); margin-bottom:20px;">...</p>
                
                <label style="font-weight:bold; display:block; margin-bottom:8px;">Selecione o Publicador:</label>
                <select id="assign-publisher-select" style="width:100%; padding:12px; border-radius:8px; border:1px solid #ccc; background:white; margin-bottom:20px;">
                    <option value="">Carregando lista...</option>
                </select>

                <div style="display:flex; gap:10px;">
                    <button class="btn btn-primary" onclick="confirmAssignment()">Confirmar</button>
                    <button class="btn btn-ghost" onclick="closeModal('modal-assign')">Cancelar</button>
                </div>
            </div>
        </div>
    </div>

    
    <nav class="bottom-nav hidden" id="app-footer">
        <button class="nav-btn active" onclick="switchView('list')">
            <span class="material-icons">grid_view</span>
            <span>Mapas</span>
        </button>
        <button class="nav-btn" id="btn-admin-nav" onclick="openAdminPanel()" style="display:none;">
            <span class="material-icons">admin_panel_settings</span>
            <span>Gest√£o</span>
        </button>
        <button class="nav-btn" onclick="openProfile()">
            <span class="material-icons">account_circle</span>
            <span>Perfil</span>
        </button>
    </nav>

<script>
// =======================================================
    // 1. CONFIGURA√á√ÉO E ESTADO GLOBAL
    // =======================================================
    const API_ENDPOINT = "https://script.google.com/macros/s/AKfycbw_B0RlBbzKBft76h-HT1kYjE9fbh2udZfZ-uuMMgmLReBlFiIl2N3Xkv_pE8ndBKn1mA/exec";
    
    // Estado da Aplica√ß√£o
    const APP = {
        user: null, 
        data: [],   // Lista de territ√≥rios
        adminData: { users: [], requests: [] },
        currentMapData: null, // Dados do mapa aberto atualmente
        tempAssignId: null,   // ID do territ√≥rio sendo designado
        
        isAdmin: function() {
            if (!this.user) return false;
            const roles = this.user.nivel.toLowerCase();
            return roles.includes('admin') || roles.includes('dirigente') || roles.includes('servo');
        }
    };

    // Vari√°veis do Mapa Leaflet
    let leafletMap = null;

    // =======================================================
    // 2. INICIALIZA√á√ÉO E SERVICE WORKER
    // =======================================================
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./service-worker.js').then(reg => {
            if (reg.waiting) showUpdateNotification(reg.waiting);
            reg.addEventListener('updatefound', () => {
                const newWorker = reg.installing;
                newWorker.addEventListener('statechange', () => {
                    if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                        showUpdateNotification(newWorker);
                    }
                });
            });
        });
        navigator.serviceWorker.addEventListener('controllerchange', () => window.location.reload());
    }

    function showUpdateNotification(worker) {
        const toast = document.getElementById('pwa-update-toast');
        toast.classList.add('visible');
        toast.onclick = () => worker.postMessage({ type: 'SKIP_WAITING' });
    }

    // =======================================================
    // 3. API E LOGIN
    // =======================================================
    async function callBackend(action, payload = {}) {
        payload.acao = action;
        try {
            const response = await fetch(API_ENDPOINT, { method: 'POST', body: JSON.stringify(payload) });
            return await response.json();
        } catch (error) {
            alert("Erro de conex√£o. Verifique sua internet.");
            return null;
        }
    }

    window.onload = function() {
        const savedEmail = localStorage.getItem('territorios_user_email');
        if (savedEmail) {
            document.getElementById('login-email').value = savedEmail;
            processLogin();
        }
    };

    async function processLogin() {
        const email = document.getElementById('login-email').value.trim();
        if (!email) return alert("Digite seu email.");

        const btn = document.querySelector('#view-login .btn-primary');
        const txt = btn.innerText; btn.innerText = "Carregando..."; btn.disabled = true;

        const res = await callBackend("verificarLogin", { email });
        btn.innerText = txt; btn.disabled = false;

        if (!res) return;

        if (res.status === "APROVADO") {
            APP.user = res;
            APP.user.email = email;
            localStorage.setItem('territorios_user_email', email);
            
            // UI Setup
            document.getElementById('view-login').classList.add('hidden');
            document.getElementById('view-list').classList.remove('hidden');
            document.getElementById('app-footer').classList.remove('hidden');
            
            // Perfil Setup
            document.getElementById('profile-name').innerText = res.nome;
            document.getElementById('profile-email').innerText = email;
            document.getElementById('profile-roles-container').innerHTML = 
                res.nivel.split(',').map(r => `<span class="user-role-badge">${r.trim()}</span>`).join(' ');

            if (APP.isAdmin()) document.getElementById('btn-admin-nav').style.display = 'flex';
            
            loadTerritories();
        } else {
            alert(res.status === "PENDENTE" ? "Cadastro em an√°lise." : "Email n√£o encontrado.");
        }
    }

    // =======================================================
    // 4. TERRIT√ìRIOS E MAPAS (Core Logic)
    // =======================================================
    async function loadTerritories() {
        document.getElementById('view-list').innerHTML = '<p style="text-align:center; padding:20px;">Atualizando mapas...</p>';
        const res = await callBackend("buscarTerritorios", { email: APP.user.email });
        if (res && res.mapas) {
            APP.data = res.mapas;
            renderTerritoryList();
        }
    }

    function renderTerritoryList() {
        const container = document.getElementById('view-list');
        container.innerHTML = '';
        let myCount = 0;

        APP.data.forEach(t => {
            if (t.isMeu) myCount++;
            const card = document.createElement('div');
            card.className = `territory-card status-${t.status} ${t.isMeu ? 'status-Meu' : ''}`;
            
            let actions = '';
            // A√ß√µes do Usu√°rio
            if (t.isMeu) {
                actions = `
                    <button class="btn btn-success" onclick="openMapDetails('${t.id}', '${t.nome}')"><span class="material-icons">map</span> Abrir Mapa</button>
                    <button class="btn btn-warning" style="margin-top:8px;" onclick="returnTerritory('${t.id}')"><span class="material-icons">assignment_return</span> Devolver</button>
                `;
            } else if (t.status === 'Livre') {
                actions = `<button class="btn btn-primary" onclick="requestTerritory('${t.id}')"><span class="material-icons">add_circle</span> Solicitar</button>`;
            } else {
                 actions = `<button class="btn btn-ghost" disabled>Ocupado por ${t.publicador || 'algu√©m'}</button>`;
            }

            // A√ß√µes do Admin (For√ßar Designa√ß√£o)
            if (APP.isAdmin() && !t.isMeu) {
                actions += `<button class="btn btn-ghost" style="margin-top:8px; font-size:0.8rem; border:1px dashed #ccc;" onclick="adminAssignModal('${t.id}', '${t.nome}')">
                    <span class="material-icons">manage_accounts</span> ${t.status === 'Livre' ? 'Designar' : 'Redesignar'}
                </button>`;
            }

            card.innerHTML = `
                <div style="display:flex; justify-content:space-between;">
                    <h3 style="margin:0">${t.id}</h3>
                    ${t.isMeu ? '<span class="material-icons" style="color:var(--primary-color)">verified</span>' : ''}
                </div>
                <p style="color:#666; margin:5px 0 15px 0;">${t.nome}</p>
                ${actions}
            `;
            container.appendChild(card);
        });
        document.getElementById('stat-active-maps').innerText = myCount;
    }

    // --- L√ìGICA DO MAPA (LEAFLET) ---
    async function openMapDetails(id, nome) {
        document.getElementById('modal-map-view').classList.add('active');
        document.getElementById('map-title').innerText = `Mapa ${id}`;
        document.getElementById('map-subtitle').innerText = nome;
        document.getElementById('leaflet-map').innerHTML = 'Carregando GPS...';
        document.getElementById('address-list').innerHTML = '';

        const res = await callBackend("buscarEnderecosPorTerritorio", { id });
        if (!res || !res.enderecos) return alert("Erro ao carregar endere√ßos.");

        APP.currentMapData = res; // Salva para compartilhar depois
        APP.currentMapData.id = id;
        APP.currentMapData.nome = nome;

        renderLeafletMap(res.enderecos);
        renderAddressList(res.enderecos);
    }

    function renderLeafletMap(enderecos) {
        const container = document.getElementById('leaflet-map');
        container.innerHTML = ''; 
        
        if (!enderecos.length) {
            container.innerHTML = '<div style="display:flex; height:100%; align-items:center; justify-content:center; color:#888;">Sem coordenadas GPS</div>';
            return;
        }

        if (leafletMap) { leafletMap.remove(); leafletMap = null; }

        setTimeout(() => {
            leafletMap = L.map('leaflet-map');
            L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(leafletMap);
            
            const bounds = [];
            enderecos.forEach((end, idx) => {
                if (end.lat && end.lng) {
                    const latLng = [parseFloat(end.lat), parseFloat(end.lng)];
                    bounds.push(latLng);
                    // √çcone numerado simples
                    const icon = L.divIcon({
                        className: 'custom-pin',
                        html: `<div style="background:#e74c3c; color:white; width:24px; height:24px; border-radius:50%; text-align:center; line-height:24px; font-weight:bold; border:2px solid white;">${idx+1}</div>`,
                        iconSize: [24, 24],
                        iconAnchor: [12, 24]
                    });
                    L.marker(latLng, {icon: icon}).addTo(leafletMap).bindPopup(`<b>${idx+1}.</b> ${end.rua}, ${end.numero}`);
                }
            });

            if (bounds.length > 0) leafletMap.fitBounds(bounds, { padding: [30, 30] });
        }, 300); // Timeout para garantir que o modal abriu
    }

    function renderAddressList(enderecos) {
        const list = document.getElementById('address-list');
        let html = '';
        enderecos.forEach((end, idx) => {
            html += `
                <div style="padding:10px; border-bottom:1px solid #eee; display:flex; gap:10px;">
                    <div style="font-weight:bold; color:var(--primary-color); min-width:25px;">${idx+1}</div>
                    <div>
                        <div style="font-weight:600;">${end.rua}, ${end.numero}</div>
                        <div style="font-size:0.85rem; color:#666;">${end.referencia || ''}</div>
                    </div>
                </div>`;
        });
        list.innerHTML = html;
    }

    // --- A√á√ïES DE MAPA ---
    function shareMapWhatsApp() {
        if (!APP.currentMapData) return;
        const dados = APP.currentMapData;
        const listaTxt = dados.enderecos.map((e, i) => `üìç *${i+1}.* ${e.rua}, ${e.numero}`).join('\n');
        const linkMaps = `https://www.google.com/maps/dir/${dados.enderecos.map(e => `${e.lat},${e.lng}`).join('/')}`;
        const msg = `*Territ√≥rio ${dados.id} - ${dados.nome}*\n\n${listaTxt}\n\nüîó *Rota:* ${linkMaps}`;
        window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent(msg)}`);
    }

    function openNativeMaps() {
        if (!APP.currentMapData) return;
        const linkMaps = `https://www.google.com/maps/dir/${APP.currentMapData.enderecos.map(e => `${e.lat},${e.lng}`).join('/')}`;
        window.open(linkMaps);
    }

    // --- A√á√ïES DE MOVIMENTA√á√ÉO (PEDIR/DEVOLVER) ---
    async function requestTerritory(id) {
        if(!confirm(`Deseja solicitar o territ√≥rio ${id}?`)) return;
        await sendMapAction(id, "pedir");
    }

    async function returnTerritory(id) {
        if(!confirm(`Confirmar devolu√ß√£o do territ√≥rio ${id}?`)) return;
        await sendMapAction(id, "devolver"); // Ajustado para bater com 'processarAcaoTerritorio' se necess√°rio, ou usar devolver
    }

    async function sendMapAction(id, tipo) {
        // Nota: O backend original usa 'pedir'/'designar'. Para devolver, pode ser que precise de l√≥gica espec√≠fica
        // Vou assumir que 'processarAcaoTerritorio' trata 'pedir' e 'devolver' se ajustarmos o backend, 
        // mas no original era 'pedir' e 'designar'. Devolver geralmente √© "designar para ningu√©m" ou uma a√ß√£o pr√≥pria.
        // Vou usar 'processarAcaoTerritorio' gen√©rico.
        const res = await callBackend("processarAcaoTerritorio", { id, tipoAcao: tipo, email: APP.user.email });
        if(res.sucesso) { alert(res.sucesso); loadTerritories(); }
        else { alert(res.erro); }
    }

    // =======================================================
    // 5. ADMINISTRA√á√ÉO E DESIGNA√á√ÉO
    // =======================================================
    async function openAdminPanel() {
        document.getElementById('modal-admin').classList.add('active');
        loadAdminData();
    }

    async function loadAdminData() {
        const res = await callBackend("buscarDadosAdmin", { email: APP.user.email }); // Precisa implementar essa fun√ß√£o agregadora no Backend ou chamar separadas
        // Fallback se a fun√ß√£o agregadora n√£o existir: chamar listarUsuarios e Solicitacoes
        if (!res) return;
        
        APP.adminData = res;
        renderAdminUsers();
        // Render Requests...
    }

    // --- NOVA FUNCIONALIDADE: DESIGNAR (MODAL) ---
    async function adminAssignModal(id, nome) {
        APP.tempAssignId = id;
        document.getElementById('modal-assign').classList.add('active');
        document.getElementById('assign-territory-info').innerText = `${id} - ${nome}`;
        
        const select = document.getElementById('assign-publisher-select');
        select.innerHTML = '<option>Carregando...</option>';

        // Busca lista de usu√°rios para preencher o select
        // Se j√° temos no adminData, usamos, sen√£o buscamos
        if (!APP.adminData.usuarios || APP.adminData.usuarios.length === 0) {
             const res = await callBackend("listarTodosUsuarios", { email: APP.user.email });
             if(res) APP.adminData.usuarios = res;
        }
        
        select.innerHTML = '<option value="">Selecione...</option>';
        APP.adminData.usuarios.forEach(u => {
            const op = document.createElement('option');
            op.value = u.email; // Usaremos o email para identificar
            op.innerText = u.nome;
            select.appendChild(op);
        });
    }

    async function confirmAssignment() {
        const select = document.getElementById('assign-publisher-select');
        const emailAlvo = select.value;
        if (!emailAlvo) return alert("Selecione um publicador.");

        if (confirm(`Designar ${APP.tempAssignId} para ${select.options[select.selectedIndex].text}?`)) {
            // Usa a rota de "aprovarPedidoTerritorio" mas for√ßada, ou criamos uma a√ß√£o especifica "forcarDesignacao"
            // Vamos tentar usar a processarAcaoTerritorio com type 'designar' passando o email do alvo como 'email' do payload se o backend suportar,
            // ou usar a rota aprovarPedidoTerritorio assumindo que o admin est√° 'aprovando' para aquele email.
            
            // Backend Original (Main.gs) tem: aprovarPedidoTerritorio(email, idTerritorio)
            const res = await callBackend("aprovarPedidoTerritorio", { email: emailAlvo, idTerritorio: APP.tempAssignId });
            
            if(res.sucesso) { alert("Designado com sucesso!"); closeModal('modal-assign'); loadTerritories(); }
            else { alert(res.erro); }
        }
    }

    // =======================================================
    // 6. UTILIT√ÅRIOS
    // =======================================================
    function renderAdminUsers() {
        // (C√≥digo de renderizar usu√°rios igual ao anterior)
        const container = document.getElementById('admin-content-users');
        container.innerHTML = '';
        if(!APP.adminData.usuarios) return;
        APP.adminData.usuarios.forEach(u => {
             // ... HTML simplificado para economizar espa√ßo
             const div = document.createElement('div');
             div.className = 'user-list-item';
             div.innerHTML = `<span>${u.nome} <small>(${u.nivel})</small></span>`;
             container.appendChild(div);
        });
    }

    function closeModal(id) { document.getElementById(id).classList.remove('active'); }
    function switchView(v) { 
        document.getElementById('view-list').classList.add('hidden'); 
        // Adicionar l√≥gica de tabs se necess√°rio
        if(v === 'list') document.getElementById('view-list').classList.remove('hidden');
    }
    function doLogout() { localStorage.removeItem('territorios_user_email'); window.location.reload(); }
    function syncData() { window.location.reload(); }

</script>
</body>
</html>
