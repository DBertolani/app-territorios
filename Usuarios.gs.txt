// =======================================================
// ARQUIVO: Usuarios.gs
// (Gerenciamento Centralizado de Usuários e Permissões)
// =======================================================

const NOME_ABA_USUARIOS = "Usuarios";

// --- 1. LOGIN E PERMISSÕES ---

function verificarLogin(emailInformado) {
  const planilha = SpreadsheetApp.getActiveSpreadsheet();
  const emailLimpo = emailInformado ? emailInformado.toString().trim().toLowerCase() : "";
  
  const abaUser = planilha.getSheetByName(NOME_ABA_USUARIOS);
  if (!abaUser) return { status: "ERRO", erro: "Aba Usuarios não encontrada" };

  const dadosUser = abaUser.getDataRange().getValues();
  const hUser = dadosUser[0].map(h => h.toString().toLowerCase().trim());
  
  const idxEmail = hUser.indexOf("email");
  const idxNome = hUser.indexOf("nome");
  // CORREÇÃO: Busca também a coluna sobrenome
  const idxSobrenome = hUser.indexOf("sobrenome");
  const idxNivel = hUser.indexOf("nivel") > -1 ? hUser.indexOf("nivel") : hUser.indexOf("nível");

  for (let i = 1; i < dadosUser.length; i++) {
    const emailDb = dadosUser[i][idxEmail] ? dadosUser[i][idxEmail].toString().toLowerCase().trim() : "";
    
    if (emailDb === emailLimpo) {
      // CORREÇÃO: Concatena Nome + Sobrenome
      let nome = idxNome > -1 ? dadosUser[i][idxNome] : "Publicador";
      let sobrenome = (idxSobrenome > -1 && dadosUser[i][idxSobrenome]) ? dadosUser[i][idxSobrenome] : "";
      
      let nomeCompleto = (nome + " " + sobrenome).trim();

      const nivelRaw = (idxNivel > -1 && dadosUser[i][idxNivel]) ? dadosUser[i][idxNivel].toString() : "Publicador";
      
      return { 
        status: "APROVADO", 
        nome: nomeCompleto, // Retorna o nome completo agora
        email: emailDb, 
        nivel: nivelRaw
      };
    }
  }
  return { status: "NAO_ENCONTRADO" };
}

function verificarSeEhAdmin(email) {
  const user = verificarLogin(email);
  if (user.status !== 'APROVADO') return false;
  const roles = user.nivel.toString().toLowerCase();
  return roles.includes('admin') || roles.includes('dirigente') || roles.includes('servo');
}

// --- 2. GESTÃO DE USUÁRIOS (ADMIN) ---

function listarTodosUsuarios(emailSolicitante) {
  // if (!verificarSeEhAdmin(emailSolicitante)) return { erro: "Sem permissão." }; 
  
  const aba = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(NOME_ABA_USUARIOS);
  const dados = aba.getDataRange().getValues();
  const lista = [];
  
  const h = dados[0].map(c => c.toString().toLowerCase().trim());
  const idxEmail = h.indexOf("email");
  const idxNome = h.indexOf("nome");
  const idxSobrenome = h.indexOf("sobrenome");
  const idxNivel = h.indexOf("nivel") > -1 ? h.indexOf("nivel") : h.indexOf("nível");

  for (let i = 1; i < dados.length; i++) {
    // CORREÇÃO AQUI: Verifica se tem Email OU Nome. Antes exigia Email.
    const temEmail = dados[i][idxEmail] && dados[i][idxEmail].toString().trim() !== "";
    const temNome = dados[i][idxNome] && dados[i][idxNome].toString().trim() !== "";

    if (temEmail || temNome) {
        let nome = dados[i][idxNome] || "";
        let sobrenome = (idxSobrenome > -1) ? dados[i][idxSobrenome] : "";
        let nomeCompleto = (nome + " " + sobrenome).trim();
        let email = temEmail ? dados[i][idxEmail].toString() : ""; // Retorna vazio se não tiver email

      lista.push({
        email: email,
        nome: nomeCompleto, 
        nivel: dados[i][idxNivel]
      });
    }
  }
  return { usuarios: lista };
}

function salvarEdicaoUsuario(adminEmail, emailAlvo, novosPapeis) {
  if (!verificarSeEhAdmin(adminEmail)) return { erro: "Sem permissão." };
  
  const aba = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(NOME_ABA_USUARIOS);
  const dados = aba.getDataRange().getValues();
  const idxEmail = dados[0].map(c => c.toString().toLowerCase().trim()).indexOf("email");
  const idxNivel = dados[0].map(c => c.toString().toLowerCase().trim()).indexOf("nivel");

  for (let i = 1; i < dados.length; i++) {
    const emailNaLinha = dados[i][idxEmail] ? dados[i][idxEmail].toString().trim().toLowerCase() : "";
    if (emailNaLinha === emailAlvo.toString().trim().toLowerCase()) {
      aba.getRange(i + 1, idxNivel + 1).setValue(novosPapeis);
      return { sucesso: "Permissões atualizadas." };
    }
  }
  return { erro: "Usuário não encontrado." };
}

function excluirUsuario(adminEmail, emailAlvo) {
  if (!verificarSeEhAdmin(adminEmail)) return { erro: "Sem permissão." };

  const aba = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(NOME_ABA_USUARIOS);
  const dados = aba.getDataRange().getValues();
  const idxEmail = dados[0].map(c => c.toString().toLowerCase().trim()).indexOf("email");

  for (let i = 1; i < dados.length; i++) {
    const emailNaLinha = dados[i][idxEmail] ? dados[i][idxEmail].toString().trim().toLowerCase() : "";
    if (emailNaLinha === emailAlvo.toString().trim().toLowerCase()) {
      aba.deleteRow(i + 1);
      return { sucesso: "Usuário removido." };
    }
  }
  return { erro: "Usuário não encontrado." };
}

// --- 3. APROVAÇÃO DE CADASTRO (CORRIGIDO PARA NOVA ESTRUTURA) ---

function aprovarCadastro(adminEmail, emailAlvo, nomeAlvo, nivel) {
  if (!verificarSeEhAdmin(adminEmail)) return { erro: "Sem permissão." };

  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const abaUsers = ss.getSheetByName(NOME_ABA_USUARIOS);
  const abaSol = ss.getSheetByName("Solicitacoes");

  // CORREÇÃO: Verifica estrutura para gravar certo
  // Estrutura esperada: Email | Nome | Sobrenome | Whatsapp | Nivel
  
  // Tenta separar Nome e Sobrenome se vierem juntos na string 'nomeAlvo'
  let nomeFinal = nomeAlvo;
  let sobreFinal = "";
  
  if (nomeAlvo.indexOf(" ") > -1) {
      let partes = nomeAlvo.split(" ");
      nomeFinal = partes[0]; // Primeiro nome
      sobreFinal = partes.slice(1).join(" "); // Resto é sobrenome
  }

  // Prepara linha: Email, Nome, Sobrenome, Whats(vazio), Nivel
  // OBS: Se sua planilha tiver ordem diferente, ajuste aqui.
  // Assumindo: A=Email, B=Nome, C=Sobrenome, D=Whats, E=Nivel
  abaUsers.appendRow([emailAlvo, nomeFinal, sobreFinal, "", nivel]);

  // Remove da aba Solicitações
  if (abaSol) {
    const dadosSol = abaSol.getDataRange().getValues();
    for (let i = 1; i < dadosSol.length; i++) {
      const emailSol = dadosSol[i][3] ? dadosSol[i][3].toString().toLowerCase() : ""; // Email na coluna D (index 3) na aba Solicitacoes
      if (emailSol === emailAlvo.toString().toLowerCase()) {
        abaSol.deleteRow(i + 1);
        break;
      }
    }
  }

  return { sucesso: "Cadastro aprovado com sucesso!" };
}

// --- FUNÇÃO DE CADASTRO ---
function solicitarCadastro(dadosOuNome, sobrenome, tel, email) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let aba = ss.getSheetByName("Solicitacoes");

  let d_nome, d_sobrenome, d_tel, d_email;
  if (typeof dadosOuNome === 'object' && dadosOuNome !== null) {
    d_nome = dadosOuNome.nome;
    d_sobrenome = dadosOuNome.sobrenome;
    d_tel = dadosOuNome.tel;
    d_email = dadosOuNome.email;
  } else {
    d_nome = dadosOuNome;
    d_sobrenome = sobrenome;
    d_tel = tel;
    d_email = email;
  }

  d_nome = d_nome ? d_nome.toString().trim() : "";
  d_sobrenome = d_sobrenome ? d_sobrenome.toString().trim() : "";
  d_tel = d_tel ? d_tel.toString().trim() : "";
  d_email = d_email ? d_email.toString().trim().toLowerCase() : "";

  const headers = ["Data", "Nome", "Sobrenome", "Email", "Whatsapp", "Info/Detalhe", "Tipo", "Status"];
  if (!aba) {
    aba = ss.insertSheet("Solicitacoes");
    aba.appendRow(headers);
  } else {
    const lastCol = aba.getLastColumn();
    if (lastCol < 8) {
      aba.getRange(1, 1, 1, 8).setValues([headers]);
    }
  }
  
  const dados = aba.getDataRange().getValues();
  for (let i = 1; i < dados.length; i++) {
    if (dados[i][3] && dados[i][3].toString().toLowerCase() === d_email && dados[i][7] === "PENDENTE") {
      return { erro: "Já existe uma solicitação pendente para este email." };
    }
  }

  // Grava na aba Solicitacoes
  aba.appendRow([new Date(), d_nome, d_sobrenome, d_email, d_tel, "Novo Usuário", "CADASTRO", "PENDENTE"]);
  return { sucesso: "Solicitação enviada com sucesso!" };
}