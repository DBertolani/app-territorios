/**
 * ARQUIVO: Territorios.gs
 * Módulo responsável pela lógica de recuperação de mapas e verificação de permissões.
 * STATUS: CORRIGIDO (Capitalização de Nomes + Auto-Cadastro Offline)
 */

// --- 1. BUSCAR TERRITÓRIOS (Para o Frontend) ---
function buscarTerritorios(emailLogin) {
  const planilha = SpreadsheetApp.getActiveSpreadsheet();
  const email = emailLogin ? emailLogin.toString().trim().toLowerCase() : Session.getActiveUser().getEmail().toLowerCase();
  
  const abaUsuarios = planilha.getSheetByName("Usuarios");
  const dadosUsuarios = abaUsuarios.getDataRange().getValues();
   
  // 1.1 Mapeamento de Usuários (Email -> Nome Completo)
  let niveisUsuarioString = "";
  let mapNomes = {}; 
  
  const headersUser = dadosUsuarios[0].map(h => h ? h.toString().toLowerCase().trim() : "");
  const idxEmailUser = headersUser.indexOf("email");
  const idxNomeUser = headersUser.indexOf("nome");
  const idxSobrenomeUser = headersUser.indexOf("sobrenome");
  
  let idxNivel = headersUser.indexOf("nivel");
  if (idxNivel === -1) idxNivel = headersUser.indexOf("nível");

  if (idxEmailUser > -1) {
    for (let i = 1; i < dadosUsuarios.length; i++) {
      const uEmail = dadosUsuarios[i][idxEmailUser] ? dadosUsuarios[i][idxEmailUser].toString().toLowerCase().trim() : "";
      
      let uNome = (idxNomeUser > -1 && dadosUsuarios[i][idxNomeUser]) ? dadosUsuarios[i][idxNomeUser].toString() : "Publicador";
      let uSobrenome = (idxSobrenomeUser > -1 && dadosUsuarios[i][idxSobrenomeUser]) ? dadosUsuarios[i][idxSobrenomeUser].toString() : "";
      
      let nomeCompleto = (uNome + " " + uSobrenome).trim();

      if (uEmail) mapNomes[uEmail] = nomeCompleto;

      if (uEmail === email && idxNivel > -1) {
         niveisUsuarioString = dadosUsuarios[i][idxNivel] ? dadosUsuarios[i][idxNivel].toString() : "";
      }
    }
  }

  // Lógica de RBAC
  const papeisUsuario = niveisUsuarioString.toLowerCase().split(',').map(p => p.trim());
  const ehAdmin = papeisUsuario.includes("admin") || papeisUsuario.includes("servo");
  const ehDirigente = papeisUsuario.includes("dirigente");
  const ehEditor = papeisUsuario.includes("editor");
  const podeGerenciar = (ehAdmin || ehDirigente);

  // Construção da Lista de Territórios
  const abaTerr = planilha.getSheetByName("Territorios");
  const dados = abaTerr.getDataRange().getValues();
  
  if (dados.length < 2) {
      return { 
          mapas: [], 
          roles: { admin: ehAdmin, dirigente: ehDirigente, editor: ehEditor } 
      };
  }

  const cabecalhos = dados[0].map(c => c ? c.toString().trim() : "");
  const colID = cabecalhos.indexOf("Territorio_ID");
  const colNome = cabecalhos.indexOf("Bairros_Abrangidos");
  const colPub = cabecalhos.indexOf("Publicador");
  const colSaida = cabecalhos.indexOf("Data Saída");
  const colModo = cabecalhos.indexOf("Modo"); 

  const lista = [];
  for (let i = 1; i < dados.length; i++) {
    const linha = dados[i];
    
    if (!linha[colID]) continue;

    // CORREÇÃO DE CAPITALIZAÇÃO:
    // Pega o valor original (com Maiúsculas) da célula
    const rawDono = colPub > -1 ? linha[colPub] : "";
    // Cria a chave de busca (minúscula) apenas para procurar no mapa de emails
    const donoKey = rawDono ? rawDono.toString().toLowerCase().trim() : "";

    // Se encontrar no mapa (é um email cadastrado), usa o nome do mapa.
    // Se NÃO encontrar (é um nome digitado manualmente), usa o rawDono ORIGINAL.
    const nomeResponsavel = (donoKey && mapNomes[donoKey]) ? mapNomes[donoKey] : rawDono;
    
    const modo = (colModo > -1 && linha[colModo]) ? linha[colModo].toString() : "APP";
    
    const status = donoKey !== "" ? "Ocupado" : "Livre";
    const isMeu = (donoKey === email);
    const podeAbrir = (isMeu || podeGerenciar || ehEditor);

    lista.push({
      id: linha[colID].toString(),
      nome: linha[colNome] ? linha[colNome].toString() : "Sem nome",
      status: status,
      responsavel: nomeResponsavel, // Agora envia com Maiúsculas corretas
      modo: modo,
      dataSaida: (colSaida > -1 && linha[colSaida]) ? formatarData(linha[colSaida]) : "", 
      isMeu: isMeu,
      podeGerenciar: podeGerenciar,
      podeAbrir: podeAbrir,          
      ehEditor: ehEditor  
    });
  }

  return { 
    mapas: lista, 
    roles: { admin: ehAdmin, dirigente: ehDirigente, editor: ehEditor } 
  };
}

// --- 2. SALVAR DADOS DO TERRITÓRIO ---
function salvarDadosTerritorio(idTerritorio, novoNome) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const aba = ss.getSheetByName("Territorios");
  const dados = aba.getDataRange().getValues();
  
  const cabecalhos = dados[0].map(c => c ? c.toString().trim() : "");
  const colID = cabecalhos.indexOf("Territorio_ID");
  const colNome = cabecalhos.indexOf("Bairros_Abrangidos");

  if (colID === -1 || colNome === -1) return { erro: "Colunas não encontradas." };

  for (let i = 1; i < dados.length; i++) {
    if (dados[i][colID].toString() === idTerritorio.toString()) {
      aba.getRange(i + 1, colNome + 1).setValue(novoNome);
      return { sucesso: "Território atualizado!" };
    }
  }
  return { erro: "Território não encontrado." };
}

// --- PROCESSAR AÇÕES (DESIGNAR, PEDIR, DEVOLVER) ---
function processarAcaoTerritorio(dadosInput) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const abaTerr = ss.getSheetByName("Territorios");
  const abaHist = ss.getSheetByName("Historico");
  
  const lock = LockService.getScriptLock();
  try { lock.waitLock(10000);
  } catch (e) { return { erro: "Servidor ocupado." }; }

  try {
    const dados = abaTerr.getDataRange().getValues();
    const headers = dados[0].map(h => h.toString().toLowerCase().trim());
    const idxId = headers.indexOf("territorio_id");
    const idxStatus = headers.indexOf("status");
    const idxPub = headers.indexOf("publicador");
    const idxSaida = headers.indexOf("data saída");
    const idxModo = headers.indexOf("modo");

    if (idxId === -1 || idxPub === -1) return { erro: "Colunas ID ou Publicador não encontradas." };

    const idAlvo = dadosInput.id;
    const acao = dadosInput.tipoAcao;
    
    // LÓGICA DE NEGÓCIO OFFLINE
    const isOffline = !!dadosInput.nomeOffline;
    const quemAssume = isOffline ? dadosInput.nomeOffline : dadosInput.email;
    const modoUso = isOffline ? "OFFLINE" : "APP";

    // --- NOVO: AUTO-CADASTRO NA ABA USUARIOS SE FOR OFFLINE ---
    if (isOffline && acao === "designar") {
       cadastrarUsuarioOfflineSeNaoExistir(ss, quemAssume);
    }
    // -----------------------------------------------------------

    for (let i = 1; i < dados.length; i++) {
      if (dados[i][idxId].toString() == idAlvo.toString()) {
        const linha = i + 1;
        
        // --- DESIGNAR / PEDIR ---
        if (acao === "pedir" || acao === "designar") {
          if (idxStatus > -1) abaTerr.getRange(linha, idxStatus + 1).setValue("Ocupado");
          abaTerr.getRange(linha, idxPub + 1).setValue(quemAssume);
          
          if (idxSaida > -1) abaTerr.getRange(linha, idxSaida + 1).setValue(new Date());
          if (idxModo > -1) abaTerr.getRange(linha, idxModo + 1).setValue(modoUso);
          
          return { sucesso: `Designado para ${quemAssume} (${modoUso}).` };
        }
        
        // --- DEVOLVER ---
        else if (acao === "devolver") {
          const valPub = dados[i][idxPub];
          const valSaida = idxSaida > -1 ? dados[i][idxSaida] : "";
          const valModo = idxModo > -1 ? dados[i][idxModo] : "APP";
          
          if (abaHist) {
            abaHist.appendRow([idAlvo, valPub, valSaida, new Date(), valModo, ""]);
          }

          if (idxStatus > -1) abaTerr.getRange(linha, idxStatus + 1).setValue("Livre");
          abaTerr.getRange(linha, idxPub + 1).clearContent();
          if (idxSaida > -1) abaTerr.getRange(linha, idxSaida + 1).clearContent();
          if (idxModo > -1) abaTerr.getRange(linha, idxModo + 1).clearContent();
          
          return { sucesso: "Devolvido com sucesso." };
        }
      }
    }
    return { erro: "ID não encontrado." };

  } catch (err) { return { erro: err.toString() }; } 
  finally { lock.releaseLock(); }
}

// --- FUNÇÃO AUXILIAR: CADASTRAR OFFLINE EM USUARIOS ---
function cadastrarUsuarioOfflineSeNaoExistir(ss, nomeCompleto) {
  const abaUsers = ss.getSheetByName("Usuarios");
  if (!abaUsers) return;

  const dados = abaUsers.getDataRange().getValues();
  // Verifica se o nome já existe (coluna Nome ou concatenado)
  // Assumindo estrutura: Email(0), Nome(1), Sobrenome(2), Whats(3), Nivel(4)
  // Mas vamos buscar pelos headers para garantir
  
  const headers = dados[0].map(h => h.toString().toLowerCase().trim());
  const idxNome = headers.indexOf("nome");
  const idxSobre = headers.indexOf("sobrenome");
  
  const nomeLimpo = nomeCompleto.toString().toLowerCase().trim();

  // 1. Verifica duplicidade
  for (let i = 1; i < dados.length; i++) {
     let n = (idxNome > -1) ? dados[i][idxNome].toString() : "";
     let s = (idxSobre > -1) ? dados[i][idxSobre].toString() : "";
     let nCompleto = (n + " " + s).trim().toLowerCase();
     
     // Se já existe alguém com esse nome exato, não cadastra de novo
     if (nCompleto === nomeLimpo) return; 
  }

  // 2. Separa Nome e Sobrenome para salvar bonitinho
  let nomeSalvar = nomeCompleto;
  let sobreSalvar = "";
  
  // Lógica simples: tudo após o primeiro espaço é sobrenome
  if (nomeCompleto.indexOf(" ") > -1) {
      let partes = nomeCompleto.split(" ");
      nomeSalvar = partes[0];
      sobreSalvar = partes.slice(1).join(" ");
  }

  // 3. Adiciona na planilha
  // Ordem Padrão (ajuste se necessário): Email, Nome, Sobrenome, Whats, Nivel
  // Deixamos email e whats vazios
  abaUsers.appendRow(["", nomeSalvar, sobreSalvar, "", "Publicador"]);
}


// --- 4. SISTEMA DE REGISTRO DE TRABALHO ---

// --- 4. REGISTRO DE VISITAS E HISTÓRICO (Versão Segura) ---

function salvarRegistroVisita(dados) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const NOME_ABA = "Registros_Trabalho";
  let aba = ss.getSheetByName(NOME_ABA);
  
  // Cria a aba automaticamente se não existir
  if (!aba) {
    aba = ss.insertSheet(NOME_ABA);
    aba.appendRow(["DataHora", "ID_Territorio", "ID_Endereco", "Status", "Obs", "Publicador"]);
  }
  
  try {
    // Salva: Data | Território | ID Endereço | Status | Obs | Publicador
    aba.appendRow([new Date(), dados.idTerritorio, dados.idEndereco, dados.status, dados.obs, dados.publicador]);
    return { sucesso: "Salvo com sucesso!" };
  } catch (e) {
    return { erro: "Erro ao salvar: " + e.toString() };
  }
}

function buscarEnderecosPorTerritorio(dados) {
  const idTerritorio = (typeof dados === 'object') ? dados.id : dados;
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  
  // 1. Busca Endereços (Obrigatório)
  const abaEnd = ss.getSheetByName("Enderecos");
  if (!abaEnd) return { erro: "Aba Enderecos não encontrada." };
  
  const dadosEnd = abaEnd.getDataRange().getValues();
  const headers = dadosEnd[0].map(h => h.toString().toLowerCase().trim());
  
  const idxTerr = headers.indexOf("territorio_id");
  const idxId = headers.indexOf("id");
  const idxRua = headers.indexOf("rua");
  const idxNum = headers.indexOf("numero");
  const idxRef = headers.indexOf("referencia");
  const idxLat = headers.indexOf("lat");
  const idxLng = headers.indexOf("lng");
  
  let lista = [];

  // 2. Tenta Buscar Histórico (Opcional - Não quebra se falhar)
  let historicoMap = {};
  try {
    const abaReg = ss.getSheetByName("Registros_Trabalho");
    if (abaReg) {
      const dadosReg = abaReg.getDataRange().getValues();
      // Percorre do fim para o começo para pegar o mais recente
      for (let i = dadosReg.length - 1; i >= 1; i--) {
        const row = dadosReg[i];
        // row[1] é ID_Territorio, row[2] é ID_Endereco
        if (row[1].toString() == idTerritorio.toString()) {
          const idEnd = row[2].toString();
          if (!historicoMap[idEnd]) { // Só guarda se ainda não guardou (o mais recente)
            historicoMap[idEnd] = {
              data: row[0],
              status: row[3],
              obs: row[4]
            };
          }
        }
      }
    }
  } catch (e) {
    // Se der erro no histórico, segue vida normal só com os endereços
    console.log("Erro ao ler histórico: " + e);
  }

  // 3. Cruza os dados
  for (let i = 1; i < dadosEnd.length; i++) {
    if (dadosEnd[i][idxTerr].toString() == idTerritorio.toString()) {
       const idAtual = idxId > -1 ? dadosEnd[i][idxId] : "";
       
       // Pega histórico se houver
       const hist = historicoMap[idAtual] || {};
       let dataFormatada = "";
       if (hist.data) {
         try { 
            let d = new Date(hist.data);
            dataFormatada = d.getDate() + "/" + (d.getMonth()+1);
         } catch(e) { dataFormatada = ""; }
       }

       lista.push({
         id: idAtual,
         rua: dadosEnd[i][idxRua],
         numero: dadosEnd[i][idxNum],
         referencia: idxRef > -1 ? dadosEnd[i][idxRef] : "",
         lat: dadosEnd[i][idxLat],
         lng: dadosEnd[i][idxLng],
         // Campos extras do histórico
         ultimaData: dataFormatada,
         ultimoStatus: hist.status || "",
         ultimaObs: hist.obs || ""
       });
    }
  }
  
  return { enderecos: lista, cidade: "Território " + idTerritorio };
}


// --- FUNÇÕES DE ADMINISTRAÇÃO E AUXILIARES ---

function designarTerritorioManual(id, email) {
   const ss = SpreadsheetApp.getActiveSpreadsheet();
   const aba = ss.getSheetByName("Territorios");
   const dados = aba.getDataRange().getValues();
   const cabecalhos = dados[0].map(c => c ? c.toString().trim() : "");
   const colID = cabecalhos.indexOf("Territorio_ID");
   const colPub = cabecalhos.indexOf("Publicador");
   const colSaida = cabecalhos.indexOf("Data Saída");

   if (colID === -1) return { erro: "Erro na planilha Territorios." };
   for(let i=1; i<dados.length; i++){
     const celulaID = dados[i][colID];
     const idLinha = celulaID ? celulaID.toString().trim() : "";
     if(idLinha === id.toString().trim()){
       aba.getRange(i+1, colPub + 1).setValue(email); 
       aba.getRange(i+1, colSaida + 1).setValue(new Date());
       return { sucesso: `Território ${id} designado para ${email}` };
     }
   }
   return { erro: "Território não encontrado." };
}

function aprovarPedidoTerritorio(emailPublicador, idTerritorio) {
  const resultado = designarTerritorioManual(idTerritorio, emailPublicador);
  if (resultado.sucesso) {
    removerSolicitacaoDaPlanilha(emailPublicador, idTerritorio, "TERRITORIO");
  }
  return resultado;
}

function sugerirTrocaTerritorio(emailPublicador, idAtual, idSugerido) {
  if (!verificarSeEhAdmin(Session.getActiveUser().getEmail())) return { erro: "Sem permissão." };
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const aba = ss.getSheetByName("Solicitacoes");
  const dados = aba.getDataRange().getValues();
  let linhaEncontrada = -1;
  for (let i = 1; i < dados.length; i++) {
    const rowEmail = dados[i][2] ? dados[i][2].toString() : "";
    const rowId = dados[i][3] ? dados[i][3].toString() : "";
    if (rowEmail == emailPublicador && rowId == idAtual && dados[i][4] == "TERRITORIO") {
      linhaEncontrada = i + 1;
      break;
    }
  }
  if (linhaEncontrada > -1) {
    aba.getRange(linhaEncontrada, 4).setValue(idSugerido); 
    return { sucesso: `Sugestão enviada! Alterado para ${idSugerido}.` };
  }
  return { erro: "Pedido original não encontrado." };
}

function formatarData(data) {
  if (!data) return "";
  try {
    const d = new Date(data);
    return `${d.getDate()}/${d.getMonth()+1}/${d.getFullYear()}`;
  } catch (e) { return ""; }
}

// ARQUIVO: Territorios.gs

function listarTodosTerritoriosAdmin() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const aba = ss.getSheetByName("Territorios");
  
  if (!aba) return { erro: "Aba 'Territorios' não encontrada." };

  const dados = aba.getDataRange().getValues();
  if (dados.length < 2) return []; // Se só tem cabeçalho ou está vazia

  // Normalização de Cabeçalhos (Remove espaços e converte para minúsculas)
  const headers = dados[0].map(c => c ? c.toString().trim().toLowerCase() : "");
  
  // Mapeamento flexível das colunas
  const colID = headers.indexOf("territorio_id");
  // Tenta encontrar 'bairros_abrangidos' ou 'nome' ou 'bairros'
  let colNome = headers.indexOf("bairros_abrangidos");
  if (colNome === -1) colNome = headers.indexOf("nome");
  if (colNome === -1) colNome = headers.indexOf("bairros");

  const colPub = headers.indexOf("publicador");
  const colData = headers.indexOf("data saída");
  
  // Se não achar o ID, não tem como listar
  if (colID === -1) return [];

  const lista = [];
  
  // Começa da linha 1 (pula cabeçalho)
  for (let i = 1; i < dados.length; i++) {
    const idRaw = dados[i][colID];
    
    // Pula linhas vazias
    if (!idRaw || idRaw.toString().trim() === "") continue;

    const pub = (colPub > -1 && dados[i][colPub]) ? dados[i][colPub].toString() : "";
    
    // Tratamento de Data
    let dataFormatada = "Nunca trabalhado";
    if (colData > -1 && dados[i][colData]) {
      try {
         const d = new Date(dados[i][colData]);
         if (!isNaN(d.getTime())) {
            dataFormatada = `${d.getDate()}/${d.getMonth()+1}/${d.getFullYear()}`;
         }
      } catch(e) {}
    }

    lista.push({
      id: idRaw.toString(),
      nome: (colNome > -1 && dados[i][colNome]) ? dados[i][colNome].toString() : "Sem Nome",
      status: pub === "" ? "Livre" : "Ocupado",
      dono: pub, // Nome do publicador para exibir
      data: dataFormatada
    });
  }
  
  return lista;
}

function buscarSolicitacoes(emailSolicitante) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const aba = ss.getSheetByName("Solicitacoes");
  if (!aba) return [];

  const dados = aba.getDataRange().getValues();
  // Índices baseados na nova estrutura:
  // 0:Data, 1:Nome, 2:Sobrenome, 3:Email, 4:Whatsapp, 5:Info, 6:Tipo, 7:Status
  
  const lista = [];
  for (let i = 1; i < dados.length; i++) {
    const row = dados[i];
    const status = row[7];
    
    if (status === "PENDENTE") {
      const tipo = row[6];
      let infoDisplay = row[5];
      if (tipo === "CADASTRO") {
        infoDisplay = row[4]; 
      }

      lista.push({
        nome: row[1] + " " + row[2], 
        email: row[3],
        info: infoDisplay, 
        tipo: tipo
      });
    }
  }
  
  return lista;
}

function removerSolicitacaoDaPlanilha(email, info, tipo) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const aba = ss.getSheetByName("Solicitacoes");
  const dados = aba.getDataRange().getValues();
  for (let i = dados.length - 1; i >= 1; i--) {
    const rowEmail = dados[i][2] ? dados[i][2].toString().toLowerCase() : "";
    const rowInfo = dados[i][3] ? dados[i][3].toString() : "";
    const rowTipo = dados[i][4] ? dados[i][4].toString() : "ACESSO";
    if (rowEmail === email.toLowerCase()) {
        if (tipo === "TERRITORIO" && rowTipo === "TERRITORIO" && rowInfo === info) {
            aba.deleteRow(i + 1);
            return true;
        }
        else if (tipo === "ACESSO" && rowTipo === "ACESSO") {
            aba.deleteRow(i + 1);
            return true;
        }
    }
  }
  return false;
}

function recusarSolicitacao(email, info, tipo, motivo) {
  if (!verificarSeEhAdmin(Session.getActiveUser().getEmail())) return { erro: "Sem permissão." };
  const sucesso = removerSolicitacaoDaPlanilha(email, info, tipo);
  if (sucesso) { return { sucesso: "Recusado." }; }
  return { erro: "Não encontrado." };
}

function devolverTerritorio(idTerritorio, emailSolicitante) {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var aba = ss.getSheetByName("Territorios");
  var dados = aba.getDataRange().getValues();
  var headers = dados[0].map(function(h) { return h ? h.toString().trim() : ""; });
  var colId = headers.indexOf("Territorio_ID");
  var colPub = headers.indexOf("Publicador");
  var colData = headers.indexOf("Data Saída");
  var encontrou = false;
  for (var i = 1; i < dados.length; i++) {
    const celulaID = dados[i][colId];
    if (celulaID && celulaID.toString().trim() === idTerritorio.toString().trim()) {
      aba.getRange(i + 1, colPub + 1).setValue("");
      aba.getRange(i + 1, colData + 1).setValue("");
      encontrou = true;
      break;
    }
  }
  if (encontrou) { return { success: true, message: "Território devolvido." }; } 
  else { return { error: "Território não encontrado." }; }
}

// --- 5. RELATÓRIOS ---

function listarHistoricoTerritorio(dados) {
  const id = (typeof dados === 'object') ? dados.id : dados;
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const aba = ss.getSheetByName("Registros_Trabalho");
  if (!aba) return [];
  
  const vals = aba.getDataRange().getValues();
  // Estrutura: 0:Data, 1:TerrID, 2:EndID, 3:Status, 4:Obs, 5:Pub
  
  let historico = [];
  // Loop reverso (do mais novo para o mais antigo)
  for(let i = vals.length - 1; i >= 1; i--) {
     if(vals[i][1].toString() == id.toString()) {
         historico.push({
             data: vals[i][0],
             endereco: vals[i][2], // ID do endereço
             status: vals[i][3],
             obs: vals[i][4],
             pub: vals[i][5]
         });
     }
  }
  return historico;
}