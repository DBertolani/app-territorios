/**
 * SISTEMA DE GEST√ÉO DE TERRIT√ìRIOS (Vers√£o 15.0: Nomes Inteligentes + API)
 * ------------------------------------------------------------------
 */

// === ‚öôÔ∏è PAINEL DE CONTROLE ===
const DISTANCIA_MAX_URBANA = 1.0;   // Raio Urbano (km)
const DISTANCIA_MAX_RURAL = 60.0;   // Raio Rural (km)

const CAPACIDADE_MAX_URBANA = 6;    // M√°x casas por mapa Urbano
const CAPACIDADE_MAX_RURAL = 6;     // M√°x casas por mapa Rural
// =============================

function onOpen() {
  SpreadsheetApp.getUi()
      .createMenu('üìç Sistema Territ√≥rios')
      .addItem('üöÄ Processar Endere√ßos', 'processarTudo')
      .addToUi();
}

// --- FUN√á√ÉO API (Para chamar pelo App) ---
function processarTudoAPI() {
    try {
        const ss = SpreadsheetApp.getActiveSpreadsheet();
        const sheetEnd = ss.getSheetByName("Endere√ßos_Geral");
        const sheetConf = ss.getSheetByName("Config_Bairros");
        const sheetTerr = ss.getSheetByName("Territorios");
        
        // 1. Gera IDs de Endere√ßo (Mantido)
        gerarIdsUnicos(sheetEnd, sheetConf);
        
        // 2. Agrupa Territ√≥rios (Com nova l√≥gica de nome, SEM resetar tudo)
        // Passamos false para modoReset e {} para carimbosBackup
        agruparTerritorios(sheetEnd, sheetTerr, sheetConf, false, {}); 
        
        return { sucesso: "Processamento conclu√≠do com sucesso!" };
    } catch (e) {
        return { erro: "Erro no processamento: " + e.toString() };
    }
}

// --- FUN√á√ÉO MANUAL (Para chamar pela Planilha) ---
function processarTudo() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheetEnd = ss.getSheetByName("Endere√ßos_Geral");
  var sheetConf = ss.getSheetByName("Config_Bairros");
  var sheetTerr = ss.getSheetByName("Territorios");

  if (!sheetEnd || !sheetConf || !sheetTerr) {
    SpreadsheetApp.getUi().alert("‚ùå Erro: Verifique as abas.");
    return;
  }

  // 1. Pergunta de Decis√£o
  var resposta = SpreadsheetApp.getUi().alert(
    'Modo de Opera√ß√£o',
    'Deseja REFAZER todos os territ√≥rios do zero?\n\n' +
    '[SIM] = Apaga TUDO e recria (Pode mudar nomes de cart√µes).\n' +
    '[N√ÉO] = Apenas encaixa novos endere√ßos nos cart√µes existentes.',
    SpreadsheetApp.getUi().ButtonSet.YES_NO_CANCEL
  );

  if (resposta == SpreadsheetApp.getUi().Button.CANCEL || resposta == SpreadsheetApp.getUi().Button.CLOSE) return;
  
  var modoReset = (resposta == SpreadsheetApp.getUi().Button.YES);
  var carimbosBackup = {}; 

  if (modoReset) {
    // A. Backup Carimbos (Data de impress√£o, etc)
    var dataTerr = sheetTerr.getDataRange().getValues();
    if (dataTerr.length > 1) {
       var mapTerr = mapearColunas(dataTerr[0]);
       var idxID = mapTerr["Territorio_ID"];
       var idxCarimbo = mapTerr["Carimbo_Impressao"];
       if (idxID !== undefined && idxCarimbo !== undefined) {
          for (var i = 1; i < dataTerr.length; i++) {
             var tID = dataTerr[i][idxID];
             var tCarimbo = dataTerr[i][idxCarimbo];
             if (tID && tCarimbo) carimbosBackup[tID] = tCarimbo;
          }
       }
    }

    var lastRow = sheetEnd.getLastRow();
    if (lastRow > 1) {
      var headers = sheetEnd.getRange(1, 1, 1, sheetEnd.getLastColumn()).getValues()[0];
      
      // B. Limpa coluna de TERRIT√ìRIOS (Reseta agrupamento)
      var colIndexTerr = headers.indexOf("Territorio_ID") + 1;
      if (colIndexTerr > 0) sheetEnd.getRange(2, colIndexTerr, lastRow - 1, 1).clearContent();

      // C. IMPORTANTE: N√ÉO LIMPE A COLUNA ID_UNICO! (Mant√©m hist√≥rico)
      // var colIndexID = headers.indexOf("ID_Unico") + 1;
      // if (colIndexID > 0) sheetEnd.getRange(2, colIndexID, lastRow - 1, 1).clearContent();
    }

    // D. Limpa aba Territorios
    var lastRowTerr = sheetTerr.getLastRow();
    if (lastRowTerr > 1) {
      sheetTerr.getRange(2, 1, lastRowTerr - 1, sheetTerr.getLastColumn()).clearContent();
    }
  }

  ss.toast(modoReset ? "Regenerando..." : "Encaixando novos...", "Processando", -1);

  gerarIdsUnicos(sheetEnd, sheetConf);
  agruparTerritorios(sheetEnd, sheetTerr, sheetConf, modoReset, carimbosBackup);
  
  SpreadsheetApp.flush();
  SpreadsheetApp.getUi().alert("‚úÖ Processo conclu√≠do!");
}

// --- GERA√á√ÉO DE IDs (Com Trim e Leitura Correta) ---
function gerarIdsUnicos(sheetEnd, sheetConf) {
  var dataEnd = sheetEnd.getDataRange().getValues();
  var headers = dataEnd[0];
  var map = mapearColunas(headers);
  
  var dataConf = sheetConf.getDataRange().getValues();
  var headersConf = dataConf[0];
  var mapConf = mapearColunas(headersConf);
  
  var configBairros = {}; 
  var linhasConfParaAtualizar = {}; 

  for (var i = 1; i < dataConf.length; i++) {
    var rawChave = mapConf["Chave_Bairro"] !== undefined ? dataConf[i][mapConf["Chave_Bairro"]] : dataConf[i][0];
    if (rawChave) {
      var chave = String(rawChave).trim(); 
      var sigla = mapConf["Sigla_Utilizada"] !== undefined ? dataConf[i][mapConf["Sigla_Utilizada"]] : dataConf[i][1];
      var seq = mapConf["Ultimo_Sequencial"] !== undefined ? dataConf[i][mapConf["Ultimo_Sequencial"]] : dataConf[i][2];
      
      configBairros[chave] = { 
        sigla: String(sigla).trim(), 
        seq: parseInt(seq || 0), 
        rowIndex: i + 1 
      };
    }
  }

  var novosConfigs = [];
  var h_ID = map["ID_Unico"];
  var h_Cid = map["Cidade"];
  var h_Bair = map["Bairro"];
  var houveAlteracaoEnd = false;

  for (var i = 1; i < dataEnd.length; i++) {
    var linha = dataEnd[i];
    
    // Se ID j√° existe, pula (Respeita IDs manuais ou antigos)
    if (linha[h_ID] && linha[h_ID] !== "") continue;
    if (!linha[h_Cid] || !linha[h_Bair]) continue;

    var partesCidade = linha[h_Cid].toString().split("-");
    var nomeCidade = partesCidade[0].trim();
    var estado = partesCidade.length > 1 ? partesCidade[1].trim() : "RJ"; // Default RJ se n√£o tiver
    var codCidade = nomeCidade.substring(0, 3).toUpperCase();
    var nomeBairro = linha[h_Bair].toString().trim();
    
    var chaveBairro = (nomeCidade + " - " + nomeBairro).trim();

    if (!configBairros[chaveBairro]) {
      var novaSigla = nomeBairro.substring(0, 4).toUpperCase().replace(/\s/g, "");
      configBairros[chaveBairro] = { sigla: novaSigla, seq: 0, rowIndex: null };
      novosConfigs.push([chaveBairro, novaSigla, 0]);
    }

    configBairros[chaveBairro].seq++;
    var seqFormatado = pad(configBairros[chaveBairro].seq, 3);
    
    // Gera ID com a sigla correta (Formato Legado da Planilha)
    var novoID = estado + "-" + codCidade + "-" + configBairros[chaveBairro].sigla + "-" + seqFormatado;
    
    dataEnd[i][h_ID] = novoID;
    houveAlteracaoEnd = true;
    
    if (configBairros[chaveBairro].rowIndex !== null) {
      linhasConfParaAtualizar[configBairros[chaveBairro].rowIndex] = configBairros[chaveBairro].seq;
    }
  }

  if (houveAlteracaoEnd) sheetEnd.getRange(1, 1, dataEnd.length, dataEnd[0].length).setValues(dataEnd);

  if (novosConfigs.length > 0) {
    var lastRowConf = sheetConf.getLastRow();
    sheetConf.getRange(lastRowConf + 1, 1, novosConfigs.length, 3).setValues(novosConfigs);
  }

  var colSeq = mapConf["Ultimo_Sequencial"] !== undefined ? mapConf["Ultimo_Sequencial"] + 1 : 3;
  var updates = [];
  for (var rowIdx in linhasConfParaAtualizar) {
    updates.push({row: parseInt(rowIdx), col: colSeq, val: linhasConfParaAtualizar[rowIdx]});
  }
  updates.forEach(function(u) { sheetConf.getRange(u.row, u.col).setValue(u.val); });
}

// --- L√ìGICA DE TERRIT√ìRIOS (AGRUPAMENTO) ---
function agruparTerritorios(sheetEnd, sheetTerr, sheetConf, modoReset, carimbosBackup) {
  var dataRange = sheetEnd.getDataRange();
  var valuesEnd = dataRange.getValues();
  var map = mapearColunas(valuesEnd[0]);

  if (map["Territorio_ID"] === undefined || map["Latitude"] === undefined) return;

  var dataConf = sheetConf.getDataRange().getValues();
  var mapConf = mapearColunas(dataConf[0]);
  var zonasPorBairro = {}; 
  var listaZonasUnicas = [];
  var mapSiglas = {}; // Mapa para converter Nome do Bairro em Sigla (AERO, CEHA...)

  if (mapConf["Zona_Agrupamento"] !== undefined) {
    for (var i = 1; i < dataConf.length; i++) {
      var rawChave = mapConf["Chave_Bairro"] !== undefined ? dataConf[i][mapConf["Chave_Bairro"]] : dataConf[i][0];
      var chave = String(rawChave).trim();
      var zona = dataConf[i][mapConf["Zona_Agrupamento"]];
      var sigla = dataConf[i][mapConf["Sigla_Utilizada"]]; // Pega a Sigla da Config

      if (chave) {
        if (zona) {
            var zonaStr = zona.toString().trim().toUpperCase();
            zonasPorBairro[chave] = zonaStr;
            if (listaZonasUnicas.indexOf(zonaStr) === -1) listaZonasUnicas.push(zonaStr);
        }
        if (sigla) mapSiglas[chave] = sigla.toString().trim();
      }
    }
  }
  listaZonasUnicas.sort();
  listaZonasUnicas.push(""); 

  var novosTerritoriosCol = valuesEnd.map(function(r){ return [r[map["Territorio_ID"]]]; });
  var contagemTerritorios = {}; // Contador de CASAS por ID de Territ√≥rio (TERR-001: 5 casas)
  
  // Contador Global de CART√ïES por Prefixo (RJ-ITA-AERO: 2 cart√µes j√° criados)
  // Isso garante o sequencial correto (001, 002, 003)
  var contadorCartoesPorPrefixo = {}; 

  // 1. Analisa o que j√° existe para n√£o duplicar n√∫meros
  for (var i = 1; i < valuesEnd.length; i++) {
    var tID = novosTerritoriosCol[i][0];
    if (tID) {
      // Conta casas
      if (!contagemTerritorios[tID]) contagemTerritorios[tID] = 0;
      contagemTerritorios[tID]++;

      // Tenta extrair o prefixo (Ex: de "RJ-ITA-AERO-001" extrai "RJ-ITA-AERO")
      if (tID.toString().indexOf("-") > -1) {
          var partes = tID.toString().split("-");
          // Se tiver 4 partes (UF-CID-BAIRRO-SEQ)
          if (partes.length >= 4) {
              var seq = parseInt(partes[partes.length-1]);
              var prefixo = partes.slice(0, partes.length-1).join("-");
              
              if (!contadorCartoesPorPrefixo[prefixo]) contadorCartoesPorPrefixo[prefixo] = 0;
              if (seq > contadorCartoesPorPrefixo[prefixo]) contadorCartoesPorPrefixo[prefixo] = seq;
          }
      }
    }
  }
  
  for (var z = 0; z < listaZonasUnicas.length; z++) {
    var zonaAtualProcessamento = listaZonasUnicas[z];
    var distanciaLimite = DISTANCIA_MAX_URBANA;
    var capacidadeLimite = CAPACIDADE_MAX_URBANA;
    var isRural = false;

    if (zonaAtualProcessamento.indexOf("RURAL") > -1) {
       distanciaLimite = DISTANCIA_MAX_RURAL;
       capacidadeLimite = CAPACIDADE_MAX_RURAL; 
       isRural = true;
    }

    for (var i = 1; i < valuesEnd.length; i++) {
      var terrAtual = novosTerritoriosCol[i][0];
      var cidadeRef = valuesEnd[i][map["Cidade"]].split("-")[0].trim(); // Remove UF se tiver
      var bairroNomeRef = valuesEnd[i][map["Bairro"]].trim();
      var chaveBairroRef = (cidadeRef + " - " + bairroNomeRef).trim();
      var zonaRef = zonasPorBairro[chaveBairroRef] || ""; 

      if (zonaRef !== zonaAtualProcessamento) continue;

      var latRef = limparCoord(valuesEnd[i][map["Latitude"]]);
      var lonRef = limparCoord(valuesEnd[i][map["Longitude"]]);

      if (terrAtual !== "" || isNaN(latRef) || isNaN(lonRef)) continue;

      var territorioEscolhido = "";

      // Tenta encaixar em vizinho existente
      if (!modoReset) {
        var melhorVizinhoID = "";
        var menorDistanciaVizinho = 999999;
        for (var k = 1; k < valuesEnd.length; k++) {
          var tVizinho = novosTerritoriosCol[k][0];
          if (tVizinho === "") continue;
          if (contagemTerritorios[tVizinho] >= capacidadeLimite) continue;

          var cidadeViz = valuesEnd[k][map["Cidade"]].split("-")[0].trim();
          var bairroNomeViz = valuesEnd[k][map["Bairro"]].trim();
          var chaveBairroViz = (cidadeViz + " - " + bairroNomeViz).trim();
          var zonaViz = zonasPorBairro[chaveBairroViz] || "";

          if (zonaRef !== zonaViz) continue;
          if (isRural && bairroNomeRef !== bairroNomeViz) continue;

          var latViz = limparCoord(valuesEnd[k][map["Latitude"]]);
          var lonViz = limparCoord(valuesEnd[k][map["Longitude"]]);
          if (isNaN(latViz) || isNaN(lonViz)) continue;

          var dist = calcularDistancia(latRef, lonRef, latViz, lonViz);
          if (dist <= distanciaLimite && dist < menorDistanciaVizinho) {
             menorDistanciaVizinho = dist;
             melhorVizinhoID = tVizinho;
          }
        }
        if (melhorVizinhoID !== "") territorioEscolhido = melhorVizinhoID;
      }

      // --- CRIA√á√ÉO DE NOVO TERRIT√ìRIO (COM NOME INTELIGENTE) ---
      if (territorioEscolhido === "") {
        // 1. Define componentes do nome
        var uf = "RJ"; // Padr√£o
        var cidSigla = cidadeRef.substring(0,3).toUpperCase(); // Ex: ITA
        var bairroSigla = mapSiglas[chaveBairroRef] || bairroNomeRef.substring(0,4).toUpperCase(); // Ex: AERO
        
        var prefixoNome = uf + "-" + cidSigla + "-" + bairroSigla; // Ex: RJ-ITA-AERO

        // 2. Calcula pr√≥ximo n√∫mero
        if (!contadorCartoesPorPrefixo[prefixoNome]) contadorCartoesPorPrefixo[prefixoNome] = 0;
        contadorCartoesPorPrefixo[prefixoNome]++;
        
        var numSeq = pad(contadorCartoesPorPrefixo[prefixoNome], 3); // 001
        
        // 3. Monta ID final
        territorioEscolhido = prefixoNome + "-" + numSeq; // RJ-ITA-AERO-001
        
        contagemTerritorios[territorioEscolhido] = 0; // Inicializa contador de casas
      }
      // --------------------------------------------------------

      novosTerritoriosCol[i][0] = territorioEscolhido;
      contagemTerritorios[territorioEscolhido]++;

      // Tenta puxar mais vizinhos para este novo territ√≥rio (Encher o carrinho)
      if (contagemTerritorios[territorioEscolhido] < capacidadeLimite) {
        while (contagemTerritorios[territorioEscolhido] < capacidadeLimite) {
          var idxMelhor = -1;
          var distMenor = 999999;
          for (var j = 1; j < valuesEnd.length; j++) {
            if (i === j) continue;
            if (novosTerritoriosCol[j][0] !== "") continue; 
            
            var cidadeCand = valuesEnd[j][map["Cidade"]].split("-")[0].trim();
            var bairroNomeCand = valuesEnd[j][map["Bairro"]].trim();
            var chaveBairroCand = (cidadeCand + " - " + bairroNomeCand).trim();
            var zonaCand = zonasPorBairro[chaveBairroCand] || "";

            if (zonaCand !== zonaAtualProcessamento) continue;
            if (isRural && bairroNomeRef !== bairroNomeCand) continue;
            
            var latViz = limparCoord(valuesEnd[j][map["Latitude"]]);
            var lonViz = limparCoord(valuesEnd[j][map["Longitude"]]);
            if (isNaN(latViz) || isNaN(lonViz)) continue;

            var dist = calcularDistancia(latRef, lonRef, latViz, lonViz);
            if (dist <= distanciaLimite && dist < distMenor) {
              distMenor = dist;
              idxMelhor = j;
            }
          }
          if (idxMelhor > -1) {
            novosTerritoriosCol[idxMelhor][0] = territorioEscolhido;
            contagemTerritorios[territorioEscolhido]++;
          } else {
            break;
          }
        }
      }
    }
  }

  sheetEnd.getRange(1, map["Territorio_ID"]+1, novosTerritoriosCol.length, 1).setValues(novosTerritoriosCol);
  atualizarAbaResumoTerritorios(sheetTerr, novosTerritoriosCol, valuesEnd, map, carimbosBackup);
}

// --- ATUALIZA√á√ÉO DO RESUMO (Aba Territorios) ---
function atualizarAbaResumoTerritorios(sheetTerr, colIDs, dadosCompletos, mapEnd, carimbosBackup) {
  var bairrosPorTerritorio = {}; 
  for (var i = 1; i < dadosCompletos.length; i++) {
    var tID = colIDs[i][0];
    var bairroNome = dadosCompletos[i][mapEnd["Bairro"]] || "Indefinido";
    if (tID) {
      if (!bairrosPorTerritorio[tID]) bairrosPorTerritorio[tID] = {};
      bairrosPorTerritorio[tID][bairroNome] = true;
    }
  }
  var dataTerr = sheetTerr.getDataRange().getValues();
  var headersTerr = dataTerr[0];
  var mapTerr = mapearColunas(headersTerr);
  var colIndexBairros = mapTerr["Bairros_Abrangidos"];
  var colIndexCarimbo = mapTerr["Carimbo_Impressao"];

  var idsExistentesIndex = {}; 
  for(var i=1; i<dataTerr.length; i++) {
    idsExistentesIndex[dataTerr[i][mapTerr["Territorio_ID"]]] = i + 1; 
  }
  var novasLinhas = [];
  var updatesBairros = []; 
  
  // Ordena para adicionar bonitinho
  var listaIDs = Object.keys(bairrosPorTerritorio).sort();

  for (var k=0; k<listaIDs.length; k++) {
    var id = listaIDs[k];
    var listaBairros = Object.keys(bairrosPorTerritorio[id]).join(" / "); // Separador /
    
    if (idsExistentesIndex[id]) {
      if (colIndexBairros !== undefined) {
        updatesBairros.push({
          row: idsExistentesIndex[id],
          col: colIndexBairros + 1,
          val: listaBairros
        });
      }
    } else {
      var novaLinha = new Array(headersTerr.length).fill("");
      novaLinha[mapTerr["Territorio_ID"]] = id;
      if (colIndexBairros !== undefined) novaLinha[colIndexBairros] = listaBairros;
      if (carimbosBackup && carimbosBackup[id] && colIndexCarimbo !== undefined) novaLinha[colIndexCarimbo] = carimbosBackup[id];
      novasLinhas.push(novaLinha);
    }
  }
  if (novasLinhas.length > 0) sheetTerr.getRange(sheetTerr.getLastRow() + 1, 1, novasLinhas.length, novasLinhas[0].length).setValues(novasLinhas);
  if (updatesBairros.length > 0) {
    updatesBairros.forEach(function(u) { sheetTerr.getRange(u.row, u.col).setValue(u.val); });
  }
}

// --- UTILIT√ÅRIOS ---
function mapearColunas(headers) {
  var map = {};
  headers.forEach(function(h, i) { map[h] = i; });
  return map;
}
function limparCoord(valor) {
  if (!valor) return NaN;
  var str = String(valor).replace(",", ".").trim(); 
  return parseFloat(str);
}
function calcularDistancia(lat1, lon1, lat2, lon2) {
  var R = 6371; var dLat = deg2rad(lat2 - lat1); var dLon = deg2rad(lon2 - lon1);
  var a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
  var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)); return R * c; 
}
function deg2rad(deg) { return deg * (Math.PI / 180); }
function pad(num, size) { var s = "000000000" + num; return s.substr(s.length-size); }